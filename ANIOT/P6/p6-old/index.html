<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Práctica 6. Componentes y NVS - Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-I</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P1b/index.md" class="dropdown-item">Práctica 1 (segunda parte)</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-II</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (1)</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P1_II/" class="dropdown-item">Práctica 1 (2)</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P1_III/" class="dropdown-item">Práctica 1 (3)</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P1_IV/" class="dropdown-item">Práctica 1 (4)</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">ANIOT</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#practica-6-componentes-y-nvs" class="nav-link">Práctica 6. Componentes y NVS</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#material-de-consulta" class="nav-link">Material de consulta</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#proyectos-esp-idf" class="nav-link">Proyectos ESP-IDF</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#libreria-nvs" class="nav-link">Librería NVS</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#aplicacion-consola" class="nav-link">Aplicación Consola</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#ejercicios-basicos" class="nav-link">Ejercicios básicos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#ejercicio-avanzado" class="nav-link">Ejercicio avanzado</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-6-componentes-y-nvs">Práctica 6. Componentes y NVS</h1>
<p>Esta práctica se desarrollará el 15 de noviembre.</p>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo de esta práctica es familiarizarse con la estructura de componentes en que se basa la compilación de proyectos en ESP-IDF. 
Asímismo, aprovecharemos para probar la partición NVS. Trabajaremos los siguientes aspectos:</p>
<ul>
<li>Creación de componentes en nuestro proyecto.</li>
<li>Incorporar componentes externos.</li>
<li>Crear pares clave-valor en una partición NVS.</li>
<li>Uso del componente  <code>console</code> para tener un entorno interactivo. </li>
</ul>
<h2 id="material-de-consulta">Material de consulta</h2>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/build-system.html#component-configuration">Documentación sobre el sistema de compilación</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/storage/nvs_flash.html">Documentación sobre la librería NVS</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/console.html">Documentación del componente <code>console</code></a></li>
<li><a href="https://www.argtable.org/">Documentación sobre la librería Argtable</a></li>
<li><a href="https://cmake.org/">Documentación sobre CMake</a></li>
</ul>
<h2 id="proyectos-esp-idf">Proyectos ESP-IDF</h2>
<p>Tal y como hemos visto en clase, un proyecto ESP-IDF está formada de  <em>componentes</em>.
un componente es la unidad en la que se organiza el código en un proyecto ESP-IDF. Cada componente se compila formando una librería estática, que posteriormente se enlazará junto al resto de componentes y al <em>kernel</em> de ESP-IDF para crear la aplicación. El código que incluyamos en la carpeta <code>main</code> no es más que otro componente, con pequeños matices que lo diferencian de otros.</p>
<p>Los elementos principales en ESP-IDF son:</p>
<ul>
<li><strong>Proyecto</strong>. Un directorio que contiene  todos los ficheros y configuración para construir un “app” (ejecutable).
Incluye elementos como tabla de partición, sistemas de ficheros y bootloader</li>
<li><strong>Configuración de proyecto</strong>. Se mantiene en el fichero sdkconfig  en el directorio raíz del proyecto. Se modifica a través de menuconfig. Cada proyecto tiene un único fichero de configuración.</li>
<li><strong>app</strong>. Es un ejecutable resultado de la compilación/enlazado.  De un proyecto se suelen crear 2 apps</li>
<li>Project app: el ejectuable principal con nuestro código</li>
<li>Bootloader app: el programa inicial que se encarga de cargar nuestro código</li>
<li><strong>Componentes</strong>. Partes modulares del código que se compilan como librearías estáticas (ficheros .a) y se enlazan en la app. Algunos componentes los proporciona ESP-IDF, pero pueden ser externos
https://components.espressif.com/ (aún no público)</li>
<li><strong>Target</strong>.  Es el hardware para el que construimos la aplicación. Podemos comprobar los targets disponibles para una versión de ESP-IDF con el comando <code>idf.py -list-targets</code></li>
</ul>
<p>La compilación se basa en la herramienta <a href="https://cmake.org/">CMake</a>, por lo que tendremos un fichero <code>CMakeLists.txt</code> para cada componente, y uno general para el proyecto. Así, la estructura general de un proyecto podría ser similar a:</p>
<p><img alt="estructura proyect" src="../img/est-proy.png" /></p>
<p>El contenido mínimo del fichero <code>CMakeLists.txt</code> del proyecto (el que se encuentra en la carpeta <code>myProject</code> en el ejemplo anterior) es:</p>
<pre><code class="language-c">cmake_minimum_required(VERSION 3.5)
include($ENV{IDF_PATH}/tools/cmake/project.cmake)
project(si7021)
</code></pre>
<h3 id="componentes">Componentes</h3>
<p>Un componente es cualquier directorio en COMPONENT_DIRS que contenga un fichero <code>CMakeLists.txt</code>. Puede ser un directorio sin <code>CMakeLists.txt</code> pero con subdirectorios, cada uno de ellos con su <code>CMakeLists.txt</code>. Se creará una librería estática para cada componente, cuyo nombre será, por defecto, el nombre del directorio. Cada componente puede, asimismo, tener su propio fichero <code>Kconfig</code>.</p>
<p>El fichero <code>CMakeLists.txt</code> debe indicar las fuentes que se enlazarán en la librería y la ubicación de los ficheros de cabecera públicos del componente. Asimismo, puede indicar dependencias con otros componentes (si las hubiera)</p>
<pre><code class="language-c">idf_component_register(SRCS &quot;foo.c&quot; &quot;bar.c&quot;
INCLUDE_DIRS &quot;include&quot;
REQUIRES mbedtls
)
</code></pre>
<p>La variable <code>COMPONENT_DIRS</code> indica los directorios en los que ESP-IDF buscará componentes. Creará bibliotecas para todos aquellos componentes que encuentre. Por defecto buscará en:</p>
<ul>
<li><code>IDF_PATH/components</code></li>
<li><code>PROJECT_DIR/componentes</code></li>
<li><code>EXTRA_COMPONENT_DIRS</code></li>
</ul>
<p>Es posible reescribir la variable <code>COMPONENT_DIRS</code>para incluir algún directorio o, especialmente, para limitar la búsquda de directorios.</p>
<p>La variable <code>EXTRA_COMPONENT_DIRS</code> nos permite incluir directorios adicionales en la búsqueda de componentes. Las rutas pueden ser absolutas o relativas al directorio del proyecto. Se indica en el <em>top-level</em>  <code>CMakeLists.txt</code>, antes del <code>include</code>.</p>
<p>La variable <code>COMPONENTS</code> permita hacer explícita la lista de componentes que queremos incluir en el proyecto. Como decíamos anteriormente, por defecto serán todos aquellos que se encuentren en <code>COMPONENT_DIRS</code>. Su uso permite reducir el tamaño del binario final, lo que puede resultar conveniente en muchos proyectos.</p>
<h2 id="libreria-nvs">Librería NVS</h2>
<p>La librería <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/storage/nvs_flash.html"><em>Non-volatile storage</em> (NVS)</a>  está diseñada para almacenar pares <em>clave-valor</em> en memoria flash (soporte no volátil). Resulta muy útil para mantener determinados parámetros de diferentes módulos de nuestra aplicación, que queremos mantener almacenados entre diferentes arranques de nuestro sistema.</p>
<p>Para utilizar la librería es necesario disponer de una partición de tipo NVS en nuestro dispositivo flash.  Una partición es una porción del dispositivo de almacenamiento (flash en nuestro caso) a la que daremos una identidad específica. Por ejemplo, una partición contendrá la lista de pares <em>clave-valor</em> tal y como los organiza la librería NVS. Otra partición puede contener un sistema de ficheros basado en FAT, para que podamos almacenar información y distribuirla en ficheros y directorios.</p>
<p>En la zona inicial de la flash se ubicará la <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/partition-tables.html">tabla de particiones</a> que indica qué particiones tendremos en nuestro dipositivo y de qué tamaño y tipo son cada una de ellas.</p>
<h2 id="aplicacion-consola">Aplicación <em>Consola</em></h2>
<p>En muchos entornos resulta muy conveniente tener una aplicación de tipo <em>consola</em>: un intérprete de comandos que nos permita interaccionar de forma básica con el sistema. Muchos sistemas empotrados tienen la opción de arrancar en modo consola, para tareas de mantenimiento y depuración. En funcionamiento <em>normal</em> la consola no se ejecutará o se saldrá de dicho modo transcurrido un tiempo de inactividad, arrancándose entonces la aplicación real.</p>
<p>ESP-IDF incluye un componente llamado <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/console.html"><em>Console</em></a> que nos da un servicio mínimo tipo REPL (Read-Evaluate-Print-Loop)  El componente incluye toda la funcionalidad necesaria para el procesamiento/eidción de línea, basándose en la <a href="https://github.com/antirez/linenoise">librería lineoise</a>. De ese modo, sabe interpretar la acción de borrado, movimiento por cursores, auto completa, indica el formato de cada comando... Asimismo, tiene funciones para que sea sencillo registrar nuevos comandos escritos por nosotros mismos.</p>
<h2 id="ejercicios-basicos">Ejercicios básicos</h2>
<p>Vamos a partir  <a href="https://github.com/espressif/esp-idf/tree/4b6d9c8ad317dc9e45f3c7699525dd9479f1f4c7/examples/system/console/basic">del ejemplo de consola básico</a>. Estudia el código, y responde a las siguientes preguntas:</p>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<ul>
<li>¿Qué componente se está incluyendo además de los que siempre se incluyen por defecto?</li>
<li>¿Qué funcionalidad se importa de dicho componente?</li>
<li>¿Qué particiones se crean al volcar el proyecto en nuestro dispositivo?</li>
</ul>
</div>
<div class="admonition danger">
<p class="admonition-title">Tareas</p>
<ul>
<li>Crea dos nuevos componentes en el proyecto creado a partir del ejemplo. Uno de ellos tendrá al menos una función <code>int get_hall_read()</code> que proporcionará una lectura del sensor de efecto Hall. El otro tendrá al menos una función <code>int get_temperature()</code> que deolverá la temperatura medida en grados Celsius obtenida del sensor Si7021. Los componentes podrán tener más funciones, tanto públicas como privadas. Antes de comenzar el REPL (que comienza con la llamada <code>esp_console_start_repl()</code>) se deberá mostrar por terminal una lectura de cada sensor.</li>
<li>Respecto al ejemplo de consola, evita que se registren comandos relaciondos con WiFi.</li>
<li>Crea un nuevo <em>namespace</em> en la partición NVS, y crea una variable de tipo entero sin signo de 8 bits (<code>uint8_t</code>)con valor 7. Lista el contenido de las variables y comprueba que efectivamente aparece.</li>
</ul>
</div>
<h2 id="ejercicio-avanzado">Ejercicio avanzado</h2>
<div class="admonition danger">
<p class="admonition-title">Tareas</p>
<ul>
<li>Incluye dos nuevos comandos en la consola: <code>get_hall</code> y <code>get_temp</code> que muestren por pantalla una lectura del sensor de efecto Hall y la temperatura, respectivamente.</li>
<li>Trata de reducir el tamaño del binario generado alterando el valor de la variable <code>COMPONENTS</code></li>
</ul>
</div>
<p>Se recomienda consultar el <a href="https://github.com/espressif/esp-idf/tree/4b6d9c8ad317dc9e45f3c7699525dd9479f1f4c7/examples/peripherals/i2c/i2c_tools">ejemplo de <code>i2c_tools</code></a> para comprobar cómo incluir comandos.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
