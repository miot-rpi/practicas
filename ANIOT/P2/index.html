<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 2 - Master IoT UCM - Prácticas RPI</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-I <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-II <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_II/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6/" class="dropdown-item">Práctica 2 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6-II/" class="dropdown-item">Práctica 2 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P7/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P3/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P10/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">ANIOT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Práctica 2</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P1/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P3/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#practica-2-programacion-con-tareas-y-eventos-en-esp-idf" class="nav-link">Práctica 2. Programación con tareas y eventos en ESP-IDF</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#material-de-consulta" class="nav-link">Material de consulta</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#introduccion" class="nav-link">Introducción</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ejercicios-basicos" class="nav-link">Ejercicios básicos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ejercicio-adicional" class="nav-link">Ejercicio adicional</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-2-programacion-con-tareas-y-eventos-en-esp-idf">Práctica 2. Programación con tareas y eventos en ESP-IDF</h1>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo  de esta práctica es conocer los mecanismos para la gestión de tareas
que ofrece FreeRTOS, concretamente en su porting  ESP-IDF (con alguna
particularidad por el hecho de estar adaptado a tener 2 cores).</p>
<p>Trabajaremos los siguientes aspectos del API de ESP-IDF:</p>
<ul>
<li>Familiarizarse con la API de <em>tareas</em> y <em>eventos</em> en ESP/IDF.</li>
<li>Uso de <em>delays</em> para tareas periódicas (veremos mejores opciones en el futuro)</li>
<li>Comunicación y sincronización de tareas mediante colas</li>
</ul>
<h2 id="material-de-consulta">Material de consulta</h2>
<p>Para ver los detalles de cada aspecto de esta práctica se recomienda la lectura de los siguientes enlaces:</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/stable/api-reference/system/freertos.html">API de ESP-IDF</a></li>
<li><a href="https://www.freertos.org/features.html}. Documentación oficial de FreeRTOS">Documentación oficial de FreeRTOS</a></li>
<li><a href="https://www.freertos.org/fr-content-src/uploads/2018/07/161204_Mastering_the_FreeRTOS_Real_Time_Kernel-A_Hands-On_Tutorial_Guide.pdf">Mastering de FreeRTOS Real Time Kernel</a></li>
</ul>
<h2 id="introduccion">Introducción</h2>
<p>Al desarrollar código para sistemas empotrados, como nuestro nodo basado en ESP32, es habitual organizar la aplicación en torno a diferentes tareas que se ejecutan de forma concurrente. Habrá tareas dedicadas al muestreo de sensores, tareas dedicadas a la conectividad, tareas de <em>logging</em>... </p>
<p>Por tanto, al comenzar un desarrollo con un nuevo <em>RTOS</em> (Real-Time Operating System) es importante conocer qué servicios ofrece el sistema para la gestión de hilos/tareas. En ocasiones, puede no haber ningún soporte. En otras ocasiones, el API ofrecida será específica del sistema operativo utilizado (como es el caso con FreeRTOS y, por tanto, con la extensión que usaremos: ESP-IDF). Y, en ocasiones, el sistema ofrecerá algún API estándar, como el de <a href="https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/pthread.h.html">POSIX</a>.</p>
<p>En los vídeos y transparencias de la asignatura disponibles en el Campus Virtual se hace una breve introducción de los mecanismos de:</p>
<ul>
<li>Creación y destrucción de tareas en ESP-IDF.</li>
<li>Comunicación y sincronización de tareas mediante colas </li>
<li>Uso de <em>eventos</em> como sistema de comunicación asíncrona.</li>
</ul>
<p>Los siguientes ejercicios se proponen como una práctica sencilla de esos mecanismos.</p>
<h2 id="ejercicios-basicos">Ejercicios básicos</h2>
<h3 id="muestreo-periodico-del-sensor-de-efecto-hall">Muestreo periódico del sensor de efecto Hall</h3>
<p>Un sensor de efecto Hall permite la medición de campos magnéticos o corrientes. En este ejercicio no entraremos a ver los detalles del sensor en sí y simplemente estamos interesados en su uso en el entorno ESP-IDF. El <a href="https://docs.espressif.com/projects/esp-idf/en/v4.0.3/api-reference/peripherals/adc.html#_CPPv416hall_sensor_readv">Hall sensor</a> está conectado a un canal del <em>ADC</em> (Conversor Analógico-Digital) que estudiaremos más adelante. Por ahora, nos basta con saber que para realizar una lectura del sensor basta con invocar a la función <code>hall_sensor_read()</code> y que, previamente, es necesario configurar el ADC mediante la llamada <code>adc1_config_width(ADC_WIDTH_12Bit)</code> (sólo es necesario invocar esta llamada una vez).</p>
<pre><code class="language-c">#include &lt;driver/adc.h&gt;
...

    adc1_config_width(ADC_WIDTH_12Bit);
    int val = hall_sensor_read();
</code></pre>
<p>En este primer ejercicio NO crearemos más tareas y simplemente usaremos un bucle infinito en la función <code>app_main()</code> para leer de forma periódica el sensor. Asimismo, usaremos la llamada <code>void vTaskDelay(const TickType_t xTicksToDelay)</code> para realizar las esperas entre lecturas.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Crea una aplicación que lea el valor del sensor de efecto Hall cada 2 segundos y muestre el valor leído por puerto serie.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<p>¿Qué prioridad tiene la tarea inicial que ejecuta la función <code>app_main()</code>? ¿Con qué llamada de ESP-IDF podemos conocer la prioridad de una tarea?</p>
</div>
<h3 id="creacion-de-una-tarea-para-realizar-el-muestreo">Creación de una tarea para realizar el muestreo</h3>
<p>Modifica el código anterior para crear una nueva tarea que sea la encargada de realizar el muestreo (denominaremos <em>muestreadora</em> a dicha tarea). La tarea muestreadora comunicará la lectura con la tarea inicial (la que ejecuta <code>app_main()</code>) a través de una variable global.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>La tarea creada leerá el valor del sensor de efecto Hall con un período que se pasará como argumento a la tarea. La tarea inicial recogerá ese valor y lo mostrará por puerto serie.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<ul>
<li>¿Cómo sincronizas ambas tareas?¿Cómo sabe la tarea inicial que hay un nuevo dato generado por la tarea muestreadora?</li>
<li>Si además de pasar el período como parámetro, quisiéramos pasar como argumento la dirección en la que la tarea muestreadora debe escribir las lecturas, ¿cómo pasaríamos los dos argumentos a la nueva tarea?</li>
</ul>
</div>
<h3 id="comunicacion-mediante-colas">Comunicación mediante colas</h3>
<p>Modifica el código anterior para que las dos tareas (inicial y muestreadora) se comuniquen mediante una <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/freertos.html#queue-api">cola de ESP-IDF</a>.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>La tarea creada (muestreadora) recibirá como argumento el período de muestreo y la cola en la que deberá escribir los datos leídos.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<p>Al enviar un dato por una cola, ¿el dato se pasa por copia o por referencia?. Consulta la documentación para responder.</p>
</div>
<h3 id="uso-de-eventos">Uso de eventos</h3>
<p>Finalmente, se modificará nuevamente el código de muestreo original (no el que usa una cola para comunicar) para que utilice <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/esp_event.html">eventos</a> para notificar que hay una nueva lectura que mostrar por el puerto serie.</p>
<p>Para ello se declara un nuevo <em>event base</em> llamado <em>HALL_EVENT</em> y al menos un <code>event ID</code> que se denominará <code>HALL_EVENT_NEWSAMPLE</code>.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>La tarea creada (muestreadora) recibirá como argumento el período de muestreo. Cuando tenga una nueva muestra, la comunicará a través de <code>esp_event_post_to()</code>. La tarea inicial registrará un <code>handler</code> que se encargará de escribir en el puerto serie.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<p>¿Qué debe hacer la tarea inicial tras registrar el <em>handle</em>? ¿Puede finalizar?   </p>
</div>
<h2 id="ejercicio-adicional">Ejercicio adicional</h2>
<p>Los ejercicios anteriores son de entrega obligatoria para obtener un 5 en la calificación de la práctica. La realización del siguiente ejercicio permite mejorar la calificación.</p>
<h3 id="gestion-de-multiples-tareas">Gestión de múltiples tareas</h3>
<p>Se creará un sistema con múltiples tareas que se comunicarán entre sí por eventos:</p>
<ul>
<li>Tarea <em>Sampler</em> (muestreadora), similar a la del apartado anterior. Comunicará sus muestras mediante eventos (<code>HALL_EVENT_NEWSAMPLE</code>).</li>
<li>Tarea <em>Filter</em> que irá acumulando muestras de la tarea <em>Sampler</em> y realizará la media  de las últimas 5 muestras recibidas. Enviará dicha media mediante un evento <code>HALL_EVENT_FILTERSAMPLE</code>.</li>
<li>Tarea <em>Logger</em> que escribe por puerto serie lo que le comunican otras tareas. Debe ser una tarea diferente a la inicial. Recibirá información a través de los eventos correspondientes (a los que deberá suscribirse).</li>
<li>Tarea <em>Monitor</em> que monitoriza el estado de las otras tareas creadas. Usará el API de Tareas para consultar el espacio de pila restante de cada tarea. Comunicará los datos a la tarea <em>Logger</em>, incluyendo nombre de la tarea, prioridad y cantidad de pila restante. Puede usar la llamada <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/freertos.html#task-api">vTaskGetInfo()</a> que devuelve un tipo <a href="https://www.freertos.org/vTaskGetInfo.html#TaskStatus_t">TaskStatus_t</a>. Enviará la información periódicamente (cada minuto) a través del evento <code>TASK_EVENT_MONITOR</code>.</li>
</ul>
<p>La tarea inicial creará las tareas <em>Sampler</em>, <em>Filter</em> y <em>Logger</em> y, por último, la tarea <em>Monitor</em> que recibirá los <em>handlers</em> de las tareas anteriores. </p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Escribe una aplicación que realice la funcionalidad anterior. El código debe organizarse en varios ficheros fuente (.c): uno para la funcionalidad relativa al muestreo del sensor y su filtrado, otro para el <em>logging</em> y otro para la monitorización de tareas (además del fichero <code>main.c</code>). Si se usa algún tipo de datos propio (una cola circular puede ser perfecta para el filtrado), se incluirá en otro fichero fuente diferente, con su fichero de cabecera (.h) correspondiente</p>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<p>¿Qué opinas de esta estructura de código? ¿Es razonable el número de tareas empleado? ¿Qué cambiarías en el diseño? </p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
