<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 2 - Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-I</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P1b/index.md" class="dropdown-item">Práctica 1 (segunda parte)</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-II</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_III/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5/" class="dropdown-item">Práctica 5 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5_II/" class="dropdown-item">Práctica 5 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">ANIOT</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Práctica 2</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../P7/index2/" class="dropdown-item">Práctica 7 (adicional)</a>
</li>
                                    
<li>
    <a href="../P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">LSI</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../LSI/Lab0/" class="dropdown-item">Práctica 0</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab4/" class="dropdown-item">Práctica 4</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P1/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P3/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#practica-2-entorno-de-compilacion-uso-de-timers" class="nav-link">Práctica 2. Entorno de compilación. Uso de timers</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#material-de-consulta" class="nav-link">Material de consulta</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#proyectos-esp-idf" class="nav-link">Proyectos ESP-IDF</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#controladores-gpio" class="nav-link">Controladores GPIO</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#esp-idf-high-resolution-timer" class="nav-link">ESP-IDF: High Resolution Timer</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#ejercicio-final" class="nav-link">Ejercicio final</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-2-entorno-de-compilacion-uso-de-timers">Práctica 2. Entorno de compilación. Uso de timers</h1>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo de esta práctica es familiarizarse con la estructura de componentes en que se basa la compilación de proyectos en ESP-IDF. 
Asímismo, aprovecharemos para utlizar <em>timers</em>. Trabajaremos los siguientes aspectos:</p>
<ul>
<li>Creación de componentes en nuestro proyecto.</li>
<li>Incorporar componentes externos.</li>
<li>Uso del componente  <code>console</code> para tener un entorno interactivo. </li>
<li>Familiarizarse con la API de <em>High Resolution Timers</em>  en ESP/IDF.</li>
</ul>
<h2 id="material-de-consulta">Material de consulta</h2>
<p>Para ver los detalles de cada aspecto de esta práctica se recomienda la lectura de los siguientes enlaces:</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/build-system.html#component-configuration">Documentación sobre el sistema de compilación</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/console.html">Documentación del componente <code>console</code></a></li>
<li><a href="https://www.argtable.org/">Documentación sobre la librería Argtable</a></li>
<li><a href="https://cmake.org/">Documentación sobre CMake</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32c3/api-reference/system/esp_timer.html">API de High Resolution Timers</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/v5.3.1/esp32c3/api-reference/peripherals/gpio.html">API sobre GPIO en ESP-IDF</a></li>
</ul>
<h2 id="proyectos-esp-idf">Proyectos ESP-IDF</h2>
<p>Tal y como hemos visto en clase, un proyecto ESP-IDF está formada de  <em>componentes</em>.
un componente es la unidad en la que se organiza el código en un proyecto ESP-IDF. Cada componente se compila formando una librería estática, que posteriormente se enlazará junto al resto de componentes y al <em>kernel</em> de ESP-IDF para crear la aplicación. El código que incluyamos en la carpeta <code>main</code> no es más que otro componente, con pequeños matices que lo diferencian de otros.</p>
<p>Los elementos principales en ESP-IDF son:</p>
<ul>
<li><strong>Proyecto</strong>. Un directorio que contiene  todos los ficheros y configuración para construir un “app” (ejecutable).
Incluye elementos como tabla de partición, sistemas de ficheros y bootloader</li>
<li><strong>Configuración de proyecto</strong>. Se mantiene en el fichero sdkconfig  en el directorio raíz del proyecto. Se modifica a través de menuconfig. Cada proyecto tiene un único fichero de configuración.</li>
<li><strong>app</strong>. Es un ejecutable resultado de la compilación/enlazado.  De un proyecto se suelen crear 2 apps</li>
<li>Project app: el ejectuable principal con nuestro código</li>
<li>Bootloader app: el programa inicial que se encarga de cargar nuestro código</li>
<li><strong>Componentes</strong>. Partes modulares del código que se compilan como librearías estáticas (ficheros .a) y se enlazan en la app. Algunos componentes los proporciona ESP-IDF, pero pueden ser externos
https://components.espressif.com/ (aún no público)</li>
<li><strong>Target</strong>.  Es el hardware para el que construimos la aplicación. Podemos comprobar los targets disponibles para una versión de ESP-IDF con el comando <code>idf.py -list-targets</code></li>
</ul>
<p>La compilación se basa en la herramienta <a href="https://cmake.org/">CMake</a>, por lo que tendremos un fichero <code>CMakeLists.txt</code> para cada componente, y uno general para el proyecto. Así, la estructura general de un proyecto podría ser similar a:</p>
<p><img alt="estructura proyecto" src="img/est-proy.png" /></p>
<p>El contenido mínimo del fichero <code>CMakeLists.txt</code> del proyecto (el que se encuentra en la carpeta <code>myProject</code> en el ejemplo anterior) es:</p>
<pre><code class="language-c">cmake_minimum_required(VERSION 3.5)
include($ENV{IDF_PATH}/tools/cmake/project.cmake)
project(si7021)
</code></pre>
<h3 id="componentes">Componentes</h3>
<p>Un componente es cualquier directorio en COMPONENT_DIRS que contenga un fichero <code>CMakeLists.txt</code>. Puede ser un directorio sin <code>CMakeLists.txt</code> pero con subdirectorios, cada uno de ellos con su <code>CMakeLists.txt</code>. Se creará una librería estática para cada componente, cuyo nombre será, por defecto, el nombre del directorio. Cada componente puede, asimismo, tener su propio fichero <code>Kconfig</code>.</p>
<p>El fichero <code>CMakeLists.txt</code> debe indicar las fuentes que se enlazarán en la librería y la ubicación de los ficheros de cabecera públicos del componente. Asimismo, puede indicar dependencias con otros componentes (si las hubiera)</p>
<pre><code class="language-c">idf_component_register(SRCS &quot;foo.c&quot; &quot;bar.c&quot;
INCLUDE_DIRS &quot;include&quot;
REQUIRES driver
)
</code></pre>
<p>La variable <code>COMPONENT_DIRS</code> indica los directorios en los que ESP-IDF buscará componentes. Creará bibliotecas para todos aquellos componentes que encuentre. Por defecto buscará en:</p>
<ul>
<li><code>IDF_PATH/components</code></li>
<li><code>PROJECT_DIR/components</code></li>
<li><code>EXTRA_COMPONENT_DIRS</code></li>
</ul>
<p>Es posible reescribir la variable <code>COMPONENT_DIRS</code>para incluir algún directorio o, especialmente, para limitar la búsquda de directorios.</p>
<p>La variable <code>EXTRA_COMPONENT_DIRS</code> nos permite incluir directorios adicionales en la búsqueda de componentes. Las rutas pueden ser absolutas o relativas al directorio del proyecto. Se indica en el <em>top-level</em>  <code>CMakeLists.txt</code>, antes del <code>include</code>.</p>
<p>La variable <code>COMPONENTS</code> permita hacer explícita la lista de componentes que queremos incluir en el proyecto. Como decíamos anteriormente, por defecto serán todos aquellos que se encuentren en <code>COMPONENT_DIRS</code>. Su uso permite reducir el tamaño del binario final, lo que puede resultar conveniente en muchos proyectos.</p>
<h3 id="aplicacion-consola-opcional">Aplicación <em>Consola</em> (opcional)</h3>
<p>En muchos entornos resulta muy conveniente tener una aplicación de tipo <em>consola</em>: un intérprete de comandos que nos permita interaccionar de forma básica con el sistema. Muchos sistemas empotrados tienen la opción de arrancar en modo consola, para tareas de mantenimiento y depuración. En funcionamiento <em>normal</em> la consola no se ejecutará o se saldrá de dicho modo transcurrido un tiempo de inactividad, arrancándose entonces la aplicación real.</p>
<p>ESP-IDF incluye un componente llamado <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/console.html"><em>Console</em></a> que nos da un servicio mínimo tipo REPL (Read-Evaluate-Print-Loop)  El componente incluye toda la funcionalidad necesaria para el procesamiento/eidción de línea, basándose en la <a href="https://github.com/antirez/linenoise">librería lineoise</a>. De ese modo, sabe interpretar la acción de borrado, movimiento por cursores, auto completa, indica el formato de cada comando... Asimismo, tiene funciones para que sea sencillo registrar nuevos comandos escritos por nosotros mismos.</p>
<p>Vamos a partir  <a href="https://github.com/espressif/esp-idf/tree/4b6d9c8ad317dc9e45f3c7699525dd9479f1f4c7/examples/system/console/basic">del ejemplo de consola básico</a>. Estudia el código, y responde a las siguientes preguntas:</p>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<ul>
<li>¿Qué componente se está incluyendo además de los que siempre se incluyen por defecto?</li>
<li>¿Qué funcionalidad se importa de dicho componente?</li>
<li>¿Qué particiones se crean al volcar el proyecto en nuestro dispositivo?</li>
</ul>
</div>
<h3 id="importar-codigo-externo-como-componente">Importar código externo como componente</h3>
<p>Espressif tiene una <a href="https://components.espressif.com/">base de datos de componentes</a> que permite incorporar componentes <em>open-source</em> en nuestros proyectos ESP-IDF de forma sencilla. Podemos incluir un componente del registro mediante el comando <code>idf.py add-dependency &lt;componentName&gt;</code> o descargando el fichero de la web de componentes y copiándolo en nuestro proyecto. Bastará con copiar la carpeta descargada dentro de la carpeta <code>components</code> de nuestro proyecto.</p>
<p>En ocasiones, encontraremos códigos no incluidos en el registro oficial de Espressif pero que pueden resultar útiles para nuestros desarollos. Nuevamente, resulta aconsejable importar esos proyectos externos como componentes en nuestros proyectos. Y así lo haremos en la siguiente tarea:</p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>La placa de desarrollo ESP32-C3-DevKit-RUST-1 tiene dos sensores de temperatura. Uno está integrado en el propio ESP32-C3 (puedes econtrar su API en <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32c3/api-reference/peripherals/temp_sensor.html">la documentación de ESP-IDF</a>). El segundo está en la placa, tal y como se indica en <a href="https://github.com/esp-rs/esp-rust-board?tab=readme-ov-file">su documentación</a>. Se trata de un sensor <a href="https://github.com/esp-rs/esp-rust-board?tab=readme-ov-file#:~:text=SHTC3-,Datasheet,-Link">SHTC3 de Sensirion</a> que está conectado al SoC mediante el bus I2C.</p>
<ul>
<li>A partir del código disponible en <a href="https://github.com/mauriciobarroso/shtc3">este repositorio de Github https://github.com/mauriciobarroso/shtc3 </a>  crea un componente llamado <code>shtc3</code> para poder utilizar el sensor sin necesidad de consultar el <em>datasheet</em>.  Los ficheros del repositorio ya están preparados para usarse como un componente en ESP-IDF v5.3 Sólo debes ubicarlos en la carpeta correcta. </li>
<li>En el fichero principal de tu aplicación, deberás inicializar el driver del bus I2C y el propio sensor. Puedes usar el código que se proporciona a continuación.</li>
</ul>
</div>
<pre><code class="language-c">shtc3_t tempSensor;
  i2c_master_bus_handle_t bus_handle;

void init_i2c(void) {
 uint16_t id;
i2c_master_bus_config_t i2c_bus_config = {
        .clk_source = I2C_CLK_SRC_DEFAULT,
        .i2c_port = I2C_NUM_0,
        .scl_io_num = 8,
        .sda_io_num = 10,
        .glitch_ignore_cnt = 7,
        .flags.enable_internal_pullup = true,
    };

    ESP_ERROR_CHECK(i2c_new_master_bus(&amp;i2c_bus_config, &amp;bus_handle));

   shtc3_init(&amp;tempSensor, bus_handle, 0x70);
}
</code></pre>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>En relación al código anterior:</p>
<ul>
<li>¿Por qué <em>scl_io_num</em> es 8? ¿Por qué <em>sda_io_num</em> es 10? ¿Se pueden cambiar?</li>
<li>¿Por qué la llamada a <em>shtc3_init()</em> reciba 0x70 como tercer argumento?</li>
</ul>
</div>
<h2 id="controladores-gpio">Controladores GPIO</h2>
<p>Los controladores de GPIO (<em>General Purpose Input-Ouput</em>) permiten controlar ciertos pines de nuestro dispositivo para usarlos como entrada (por ejemplo, para conectar un botón) o salida (por ejemplo para conectar un LED) o con funciones <em>especiales</em> (que forme parte de un bus serie, por ejemplo). </p>
<h3 id="placa-esp32-devkitc-v4">Placa ESP32-DevKitC v4</h3>
<p>El SoC ESP32 que usamos proporciona 40 GPIO <em>pads</em> (el SoC no tiene pines propiamente dichos, sino conectores, normalmente de superfície, que se deminan <em>pad</em>). El módulo WROOM-32 que usamos expone 38 de ellos, que son accesibles a traves de los pines (los conectores físicos a ambos lados de la placa) que incorpora nuestra placa DevKitC.</p>
<p>En la siguiente figura se muestra la disposición de los pines en la placa ESP32-DevKitC que usamos en nuestras prácticas: </p>
<p><img alt="pinout" src="img/esp32-devkitC-v4-pinout.png" /></p>
<p>En <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/hw-reference/esp32/get-started-devkitc.html">la web de Espressif</a> se pueden encontrar más detalles de la placa.</p>
<p><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/gpio.html">Como se indica en la documentación de  ESP-IDF</a>, algunos de esos pines tiene un propósito específico. Por ejemplo, GPIO6-11 y 16-17 no deben usarse porque están internamente conectados a la memoria SPI flash. También nos indica que los pines del canal 2 del ADC (ADC2) NO deben usarse mientras se utiliza Wi-Fi.  Es muy conveniente leer todas las restricciones para evitar problemas en nuestros desarrollos.</p>
<h3 id="placa-rust-board-esp32-c3">Placa  Rust Board ESP32-C3</h3>
<p>En la siguiente figura se muestra la disposición de los pines en la placa ESP32-Rust board que usamos en nuestras prácticas: </p>
<p><img alt="pinoutRust" src="img/rust_board_v1_pin-layout.png" /></p>
<p>En <a href="https://github.com/esp-rs/esp-rust-board">la web de la placa</a> se pueden encontrar más detalles sobre los componenentes, esquemáticos, BOM... </p>
<p>Entre otra documentación podéis encontrar el esquemático de la placa, que permite conocer a qué pines del SoC se conectan los diferentes elementos (LEDs, botones) de la placa:</p>
<p><img alt="schematicRust" src="img/esp-rust-board.png" /></p>
<h3 id="api-de-esp-idf">API de ESP-IDF</h3>
<p>La documentación muestra también la API que ofrece ESP-IDF para configurar los pines (entrada o salida, uso de pull-up/pull-down) establecer un valor lógico (0 ó 1)en un pin (previamente configurado como salida) o leer el valor lógico de un pin (configurado como entrada).</p>
<p>El siguiente código, <a href="https://github.com/espressif/esp-idf/tree/master/examples/peripherals/gpio/generic_gpio">extraído del ejemplo de GPIO proporcionado en la distribución ESP-IDF</a>, muestra cómo configurar los pines GPIO18 y GPIO19 como salida. Observa cómo se construye la máscara de bits <code>GPIO_OUTPUT_PIN_SEL</code> para indicar a <code>gpio_config()</code> qué pines se configuran.</p>
<pre><code class="language-c">#define GPIO_OUTPUT_IO_0 18
#define GPIO_OUTPUT_IO_1 19
#define GPIO_OUTPUT_PIN_SEL ((1ULL&lt;&lt;GPIO_OUTPUT_IO_0) | (1ULL&lt;&lt;GPIO_OUTPUT_IO_1))
gpio_config_t io_conf;
io_conf.intr_type = GPIO_PIN_INTR_DISABLE; 
io_conf.mode = GPIO_MODE_OUTPUT; 
io_conf.pin_bit_mask = GPIO_OUTPUT_PIN_SEL; 
io_conf.pull_down_en = 0; 
io_conf.pull_up_en = 0; 
gpio_config(&amp;io_conf);
</code></pre>
<p>Posteriormente, podemos establecer el valor lógico de la salida con una llamada similar a <code>gpio_set_level(GPIO_OUTPUT_IO_1, valor);</code>, siendo <code>valor</code> igual a 0 ó 1.</p>
<p>De forma similar el siguiente código configura los pines 4 y 5 como entrada:</p>
<pre><code class="language-c">
    #define GPIO_INPUT_IO_0 4
    #define GPIO_INPUT_IO_1 5
    #define GPIO_INPUT_PIN_SEL ((1ULL&lt;&lt;GPIO_INPUT_IO_0) | (1ULL&lt;&lt;GPIO_INPUT_IO_1))
    gpio_config_t io_conf;  
    io_conf.pin_bit_mask = GPIO_INPUT_PIN_SEL;
    io_conf.mode = GPIO_MODE_INPUT;
    gpio_config(&amp;io_conf);
</code></pre>
<p>Posteriormente, podremos leer el valor lógico de esos pines con una llamada a <code>gpio_get_level()</code>.</p>
<div class="admonition note">
<p class="admonition-title">Busca información</p>
<p>En relación al código anterior: en la configuración anterior, los pines de entrada deben muestrearse periódicamente para conocer su estado. Investiga cómo configurar los pines como entrada de modo que generen una interrupción cuando se produce un flanco (subida, bajado o ambos).</p>
</div>
<h2 id="esp-idf-high-resolution-timer">ESP-IDF: High Resolution Timer</h2>
<p>Un <em>Timer</em> es un temporizador que podemos programar para que nos <em>avise</em> transcurrido un cierto tiempo. Es similar a una cuenta atrás con alarma y es un mecanismo perfecto para planificar tareas periódicas. El <em>aviso</em> será asíncrono, por lo que no sabemos en qué punto de nuestro código estaremos cuando se dispare la alarma.</p>
<p>ESP-IDF ofrece un API para el uso de <em>timers</em> que, a su vez, utlizan los <em>timers</em> de 64 bits disponibles en el hardware para garantizar una precisión de hasta 50us. </p>
<p>Cuando programamos un <em>timer</em> podemos optar por 2 comportamientos:</p>
<ul>
<li><em>One-shot</em> (<code>esp_timer_start_once()</code>), que programrá el <em>timer</em> para que genere una única alarma transcurrido el plazo establecido.</li>
<li><em>Continuo</em> (<code>esp_timer_start_periodic()</code>) que re-programará el <em>timer</em> de forma automática cada vez que la cuenta llegue a 0. Este mecanismo es el idóneo para muestreos periódicos.</li>
</ul>
<p>Cuando el <em>timer</em> genere la alarma, se ejecutará un <em>callback</em>, una función que habremos definido previamente (y asociado a ese <em>timer</em>). Dicha función se ejecutará en el contexto de una tarea específica (<code>ESP_TIMER_TASK</code>) o en el de una rutina de tratamiento de interrupción (<code>ESP_TIMER_ISR</code>). En nuestro caso, es aconsejable usar el primer mecanismo (tarea específica).</p>
<p>En la <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/esp_timer.html">documentación de ESP-IDF</a> podéis encontrar el resto de llamadas relevantes para crear y configurar <em>timers</em>. Es muy recomendable, asimismo, estudiar los <a href="https://github.com/espressif/esp-idf/tree/master/examples/system/esp_timer">ejemplos disponibles en la distribución</a></p>
<p>A continuación se incluye un ejemplo de uso, extraíado de la distribución de ESP-IDF:</p>
<pre><code class="language-c">void app_main() { 
     ...
    const esp_timer_create_args_t periodic_timer_args = {
         .callback = &amp;periodic_timer_callback,
         .name = &quot;periodic&quot; };
    esp_timer_handle_t periodic_timer; esp_timer_create(&amp;periodic_timer_args, &amp;periodic_timer);
     ...
    esp_timer_start_periodic(periodic_timer, 500000); ....
    esp_timer_stop(periodic_timer); ...
    esp_timer_delete(periodic_timer); 
}

static void periodic_timer_callback(void* arg) { 
    int64_t time_since_boot = esp_timer_get_time();
    printf(&quot;Periodic timer called, time since boot: %lld us&quot;,time_since_boot);
}
</code></pre>
<h3 id="encendido-de-leds-con-gpio-y-timer">Encendido de LEDs con GPIO y timer</h3>
<p>La placa de desarrollo ESP32-C3-DevKit-RUST-1 tiene dos LEDs, uno de ellos conectado</p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Configura el  GPIO asociado al LED (GPIO 7) como salida. Programa un <em>timer</em> para cambiar el estado del LED cada segundo. </p>
</div>
<h2 id="ejercicio-final">Ejercicio final</h2>
<p>Completa este ejercicio después de haber resuelto los anteriores. De cara la entrega de la práctica, <strong>sólo es necesario entregar este ejercicio</strong></p>
<div class="admonition danger">
<p class="admonition-title">Tareas</p>
<p>Partiendo del ejemplo <em>Blink</em> (usando el denominado <em>LED_STRIP</em> en GPIO 2, no como la usamos el primer día), crea una applicación que:</p>
<ul>
<li>Incluya el componente <code>shtc3</code> en tu proyecto.</li>
<li>Muestree la temperatura cada segundo utilizando un <em>timer</em>.</li>
<li>Muestre el progreso de la temperatura en el LED programable de la placa. Si la temperatura es inferior a 20 grados, estará apagado. Por cada grado que suba la temperatura, se modificará el color/intensidad del LED.<ul>
<li>Para variar el color/intensidad, sólo debes cambiar los 3 últimos argumentos de la llamada <code>led_strip_set_pixel()</code> del código de ejemplo. </li>
</ul>
</li>
<li>Se programará un segundo timer que mostrará por pantalla (puerto serie) la última medida de temperatura realizada cada 10 segundos. </li>
<li>[Opcional] Configura el GPIO 9, al que está conectado el botón BOOT, para que genere interrupciones cuando soltemos el botón. ¿Qué valor lógico se lee del GPIO 9 con el botón pulsado?. Consulta <a href="https://docs.espressif.com/projects/esp-idf/en/v5.3.1/esp32/api-reference/peripherals/gpio.html">la documentación de GPIO</a> y el <a href="https://github.com/espressif/esp-idf/tree/v5.3.1/examples/peripherals/gpio/generic_gpio">ejemplo de GPIO genérico</a> para entender cómo configurar un GPIO como entrada por interrupciones.</li>
</ul>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
