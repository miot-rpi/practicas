<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 8 - Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-I</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P1b/index.md" class="dropdown-item">Práctica 1 (segunda parte)</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-II</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_III/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5/" class="dropdown-item">Práctica 5 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5_II/" class="dropdown-item">Práctica 5 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">ANIOT</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../P7/index2/" class="dropdown-item">Práctica 7 (adicional)</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">LSI</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../LSI/Lab0/" class="dropdown-item">Práctica 0</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab5/" class="dropdown-item">Práctica 5</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P7/index2/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../LSI/Lab0/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#practica-8-arranque-seguro-y-encriptacion" class="nav-link">Práctica 8. Arranque seguro y encriptación</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#material-de-consulta" class="nav-link">Material de consulta</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#emulador-qemu-para-esp32" class="nav-link">Emulador QEMU para ESP32</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#arranque-seguro" class="nav-link">Arranque seguro</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#encriptacion-de-flash" class="nav-link">Encriptación de FLASH</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#encriptacion-de-nvs" class="nav-link">Encriptación de NVS</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-8-arranque-seguro-y-encriptacion">Práctica 8. Arranque seguro y encriptación</h1>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo de esta práctica es familiarizarse con las técnicas y herramientas que ofrece ESP-IDF
para integrar arranque seguro y encriptación de flash en nuestros proyectos.</p>
<p>Trabajaremos los siguientes aspectos:</p>
<ul>
<li>QEMU como plataforma de emulación para desarrollar aspectos relacionados con arranque seguro y encriptación.</li>
<li>Arranque seguro y firmado de binarios.</li>
<li>Encriptación de flash y NVS.</li>
</ul>
<h2 id="material-de-consulta">Material de consulta</h2>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/tools/qemu.html">QEMU con soporte para ESP32</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/v5.3.1/esp32/security/secure-boot-v2.html">Secure Boot v2</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/v5.3.1/esp32/security/flash-encryption.html">Encriptación FLASH</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-reference/storage/nvs_encryption.html">Encriptación NVS</a></li>
</ul>
<h2 id="emulador-qemu-para-esp32">Emulador QEMU para ESP32</h2>
<p>Debido a que, durante esta prática, modificaremos algunos aspectos de nuestros proyectos
que no son reversibles, es conveniente no utilizar una placa física para su desarrollo.</p>
<div class="admonition danger">
<p class="admonition-title">Nota importante</p>
<p>Mantén desconectadas tus placas durante <strong>toda esta práctica</strong>. No las necesitarás y 
cualquier error podría ser irreversible o dejar la placa inutilizable.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Recordatorio de la nota importante</p>
<p>Repetimos: mantén desconectadas tus placas durante <strong>toda esta práctica</strong>. No las necesitarás y 
cualquier error podría ser irreversible o dejar la placa inutilizable.</p>
</div>
<p>QEMU es un emulador de procesadores de código abierto. Proporciona multitud
de soporte para hardware y dispositivos, con capacidad para ejecutar en ellos
cualquier sistema operativo. En conjunción con KVM, QEMU es capaz de ejecutar
máquinas virtuales con un rendimiento similar al nativo. </p>
<p>Espressif ha desarrollado y mantiene un <em>fork</em> del proyecto QEMU, dando soporte tanto
a procesadores con arquitectura Xtensa (ESP32) como RISC-V (ESP32-C3 y similares). Además,
el <em>fork</em> de Espressif para el ESP32 proporciona no solo emulación de CPU, sino de los
periféricos más comunes para el ESP32. Para más información sobre las capacidades
del <em>fork</em>, se sugiere consultar la <a href="https://github.com/espressif/esp-toolchain-docs/tree/main/qemu/esp32">documentación específica</a> proporcionada por Espressif.</p>
<p>La herramienta <code>idf.py</code>, proporcionada en la instalación por defecto de ESP-IDF, 
proporciona la funcionalidad necesaria para ejecutar y depurar aplicaciones en QEMU.
Es la forma más conveniente de testear aplicaciones y funcionalidades críticas sin 
necesidad de tener que flashearlas en <em>hardware</em> real.</p>
<div class="admonition danger">
<p class="admonition-title">Nota importante</p>
<p>Se sugiere el uso de una instalación nativa, virtual o a través de WSL de Linux para
el desarrollo de esta práctica. También se ofrece soporte en MacOS.</p>
</div>
<h3 id="prerequisitos-e-instalacion-de-qemu">Prerequisitos e instalación de QEMU</h3>
<p>Antes de comenzar, es necesario instalar ciertos prerequisitos necesarios de cara a
la instalación de QEMU. Dependiendo de tu distribución o sistema operativo:</p>
<ul>
<li>Ubuntu/Debian:</li>
</ul>
<pre><code class="language-sh">sudo apt-get install -y libgcrypt20 libglib2.0-0 libpixman-1-0 libsdl2-2.0-0 libslirp0
</code></pre>
<ul>
<li>Arch:</li>
</ul>
<pre><code class="language-sh">sudo pacman -S --needed libgcrypt glib2 pixman sdl2 libslirp
</code></pre>
<ul>
<li>macOS:</li>
</ul>
<pre><code class="language-sh">brew install libgcrypt glib pixman sdl2 libslirp
</code></pre>
<p>A continuación, instala los binarios de QEMU con el siguiente comando:</p>
<pre><code class="language-sh">python $IDF_PATH/tools/idf_tools.py install qemu-xtensa qemu-riscv32
</code></pre>
<p>Observa que con esto instalarás el emulador para Xtensa (ESP32) y RISC-V (ESP32-C3),
por lo que podrás emular tus dos placas generando proyectos como si fueras a utilizarlas
de la forma habitual.</p>
<p>Tras la instalación, y antes de su uso en cualquier sesión, recuerda ejecutar
<code>. ./export.sh</code> en el directorio de la instalación de ESP-IDF.</p>
<h3 id="uso-de-qemu">Uso de QEMU</h3>
<h4 id="ejecucion-de-una-aplicacion">Ejecución de una aplicación</h4>
<p>Para ejecutar una aplicación IDF en QEMU, simplemente es necesario construirla de 
forma habitual para una de las arquitecturas soportadas por el emulador (en nuestro
caso, ESP32 o ESP32-C3), y ejecutar el siguiente comando:</p>
<pre><code class="language-sh">idf.py qemu monitor
</code></pre>
<p>Este comando construirá la aplicación (si no lo está ya), arrancará QEMU y abrirá
un monitor IDF, conectándolo al puerto UART emulado. Así, veremos la salida por
consola igual que si se tratase de una ejecución en una placa física.</p>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>En esta práctica, se sugiere trabajar con un proyecto sencillo que no incluya
demasiada funcionalidad adicional (uso de periféricos, por ejemplo). Un buen ejemplo
es <code>blink</code>. Clona el proyecto, constrúyelo y ejecútalo con el anterior comando.
Anota la salida que observas, e intenta determinar (a la vista de la invocación
a <code>qemu</code> que se realiza) cuáles son sus principales parámetros de ejecución. </p>
</div>
<h4 id="depuracion-actividad-opcional">Depuración (actividad opcional)</h4>
<p>Para depurar una aplicación en QEMU, utiliza el siguiente comando:</p>
<pre><code class="language-sh">idf.py qemu gdb
</code></pre>
<p>Este comando permite construir la aplicación, arranca QEMU con un servidor GDB
activado, y abre una terminal interactiva GDB. Este comando es muy útil para depurar
un binario construido, por ejemplo, para nuestros ESP32, ya que no proporcionan
capacidades de depuración en chip (en el caso de los ESP32-C3, esto sí es posible).</p>
<p>En este caso, para observar la salida del programa mientras estás depurando, utiliza
dos terminales:</p>
<ul>
<li>En la primera, ejecuta el siguiente comando, que arranca QEMU y el monitor IDF, 
e indica al primero que espere a una conexión entrante GDB:</li>
</ul>
<pre><code class="language-sh">idf.py qemu --gdb monitor
</code></pre>
<ul>
<li>En la segunda, ejecuta el siguiente comando, que inicia una sesión GDB y la conecta
a QEMU. Desde esta sesión puedes depurar el código, y la salida será visible en la 
primera:</li>
</ul>
<pre><code class="language-sh">idf.py gdb
</code></pre>
<div class="admonition note">
<p class="admonition-title">Tarea (opcional)</p>
<p>Depura tu proyecto <code>blink</code> estableciendo un <em>breakpont</em> en la función <code>app_main</code>, y ejecútalo paso a paso observando la salida por pantalla.</p>
</div>
<h4 id="emulacion-de-efuse">Emulación de eFuse</h4>
<p>QEMU soporta también la emulación de eFuse, clave para el desarrollo de la práctica, ya
que es una forma muy adecuada de probar aspectos de seguridad como arranque seguro y
encriptación de flash, sin dejar a las placas físicas en estados irreversibles.</p>
<p>La herramienta <code>idf.py</code> es la encargada de programar eFuses. Al ejecutar cualquiera de
los siguientes comandos, se programan los eFuses del procesador emulado por QEMU a través
del fichero <code>qemu_efuse.bin</code>, que se utiliza como habrás observado como
argumento en la ejecución. Por ejemplo:</p>
<pre><code class="language-sh">idf.py qemu efuse-burn FLASH_CRYPT_CNT 1
idf.py qemu efuse-burn-key flash_encryption my_flash_encryption_key.bin
</code></pre>
<p>Para mostrar un resumen del contenido de los eFuse, ejecuta:</p>
<pre><code class="language-sh">idf.py qemu efuse-summary
</code></pre>
<h4 id="especificacion-del-fichero-de-imagen">Especificación del fichero de imagen</h4>
<p>Por defecto, QEMU usa un fichero de imagen llamado <code>qemu_flash.bin</code> que se construye
en el directorio de construcción (<code>build</code>). Este fichero se genera en base a la información
que se incluye en un fichero llamado <code>flash_args</code> que reside en el mismo directorio. Para
usar otro fichero alternativo, podemos ejecutar:</p>
<pre><code class="language-sh">idf.py qemu --flash-file fichero.bin monitor
</code></pre>
<h2 id="arranque-seguro">Arranque seguro</h2>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>En esta parte de la práctica, se sugiere que sigas trabajando con el mismo proyecto que elegiste en la primera (se sugiere <code>blink</code>). En todo caso, trabaja sobre un directorio nuevo para no perder el trabajo realizado en el apartado anterior, por ejemplo, <code>blink_secure</code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Revisa las diapositivas de clase para recordar el background, funcionamiento y etapas de la verificación de bootloader e imágenes proporcionadas por el proceso de arranque seguro.</p>
</div>
<h3 id="como-habilitar-el-arranque-seguro">¿Cómo habilitar el arranque seguro?</h3>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Sigue los siguientes pasos para configurar tu proyecto para arranque en modo seguro, documentando todos los pasos y posibles observaciones en la memoria.</p>
</div>
<ol>
<li>
<p>Selecciona como target ESP32.  Abre el menú de configuración del proyecto.  En <code>Security Features</code> habilita 
la opción <em>Enable hardware Secure Boot in Bootloader</em> para habilitar el 
arranque seguro. Deberás también especificar el esquema de firma RSA y la versión
2 de Secure Boot en las opciones 
<em>App signing scheme</em> y <em>Select Secure Boot version</em>. Si no te aparecen, 
pasa al punto 2 para habilitarlo y podrás seleccionarlas.</p>
</li>
<li>
<p>Para los ESP32, Secure Boot V2 solo está disponible para ESP32 revisión 
ECO3 en adelante. Para ver la opción "Secure Boot V2", la revisión del chip 
debe cambiarse a la revisión 3 (ESP32-ECO3). Para cambiar la revisión del chip, 
configura la opción <em>Minimum Supported ESP32 Revision</em> a Rev 3 en 
<em>Hardware Settings -&gt; Chip revision -&gt; Minimum Supported ESP32 revision</em>.</p>
</li>
<li>
<p>Especifica la ruta a la clave de firma de arranque seguro, 
relativa al directorio del proyecto. Puedes dejar su valor por defecto
(debería ser <code>secure_boot_signing_key.pem</code>) o usar otro.</p>
</li>
<li>
<p><strong>Importante</strong>: selecciona también la opción para que el bootloader forme parte
del proceso de flasheo cuando se usa arranque seguro (estará deshabilitada por 
defecto). La opción se denomina <em>Flash bootloader along with other artifacts 
using the default flash command</em>.</p>
</li>
<li>
<p>Selecciona el modo de descarga de ROM UART deseado en 
"UART ROM download mode". 
De forma predeterminada, el modo de descarga de ROM UART se ha mantenido 
habilitado para evitar deshabilitarlo permanentemente en la fase de desarrollo; 
esta opción es potencialmente insegura. Se recomienda deshabilitar el modo de descarga UART para mayor seguridad.</p>
</li>
<li>
<p>Opcionalmente, puedes aumentar la información mostrada por el <em>bootloader</em> aumentando
el valor de la opción <em>Bootloader log verbosity</em> a Info o Verbose. Ten cuidado porque esto
aumentará el tamaño del bootloader, y probablemente debas aumentar entonces el <em>offset</em> 
de la tabla de particiones a un valor mucho mayor al establecido por defecto (opción
<em>Offset of partition table</em> a 0xe000 como máximo para dar cabida al bootloader.</p>
</li>
</ol>
<p>Guarda la configuración (añade si lo deseas más opciones), y abandona la fase de configuración.</p>
<p>La primera vez que ejecute la construcción con <code>idf.py build</code>, 
si no se encuentra la clave de firma, 
se imprimirá un mensaje de error con un comando para generar una 
clave de firma a través del comando:</p>
<pre><code class="language-sh">espsecure.py generate_signing_key
</code></pre>
<div class="admonition danger">
<p class="admonition-title">Importante</p>
<p>Una clave de firma generada de esta manera utilizará la mejor fuente de 
números aleatorios disponible para el sistema operativo y tu instalación 
de Python (<code>/dev/urandom</code> en OSX/Linux y <code>CryptGenRandom()</code> en Windows). 
Si esta fuente de números aleatorios es débil, entonces la clave privada será débil.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Importante</p>
<p>Para entornos de producción, se recomienda generar el par de claves 
mediante <code>openssl</code> u otro programa de cifrado estándar de la industria. 
Tienes más información sobre cómo hacer esto <a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/security/secure-boot-v2.html#generating-secure-boot-signing-key">aquí</a>. De todos modos, dejamos esta parte como <strong>opcional</strong> en la práctica.</p>
</div>
<ol>
<li>
<p>Tras la ejecución de la orden <code>idf.py build</code> de forma exitosa, se habrán creado las imágenes para el <em>bootloader</em>, tabla de particiones e imagen de aplicación individualmente en el directorio de construcción. Identifícalas.</p>
</li>
<li>
<p>La imagen final a flashear debería generarse fusionando el <em>bootloader</em>, la tabla
de particiones y la imagen de aplicación. Una forma sencilla, si se ha seguido el paso
4, es utilizar la herramienta <code>esptool.py</code> de la siguiente manera:</p>
</li>
</ol>
<pre><code class="language-sh">(cd build; esptool.py --chip esp32c3 merge_bin --fill-flash-size 4MB -o flash_image.bin @flash_args)
</code></pre>
<ol>
<li>
<p>Como vamos a trabajar con QEMU, tenemos ya lista la imagen que se ejecutará en el emulador. Si trabajasemos con una placa real, pasaríamos en este punto por una fase de flasheado de la imagen.</p>
</li>
<li>
<p>Monitoriza la ejecución en QEMU siguiendo la forma de trabajar de ejemplos anteriores. Documenta lo que ves en la salida (en referencia al arranque seguro).</p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Fíjate en el proceso de verificación de bloques de firmas y de imágenes (incluyendo bootloader e imagen de aplicación). Comprueba que concuerdan con los explicados en clase y en la documentación de ESP-IDF enlazada al inicio de esta memoria. </p>
</div>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>¿Qué ocurriría si un compañero te pasa su imagen de aplicación o su <em>bootloader</em>, y tú lo integras en la imagen que emulas? ¿Y que ocurriría si usas tus imágenes con el fichero de firma de tu compañero/a? Intenta ver qué ocurre en el proceso de verificación de firmas en esos casos. De la misma forma, intenta ver qué ocurre si modificas un byte en la imagen firmada (no hagas esto con el <em>bootloader</em>).</p>
</div>
<ol>
<li>Si has seguido el paso 4, Ejecutar para crear un cargador de arranque habilitado para arranque seguro. La salida de la compilación incluirá un mensaje para un comando de actualización, utilizando .idf.py bootloaderesptool.py write_flash</li>
</ol>
<h2 id="encriptacion-de-flash">Encriptación de FLASH</h2>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Sigue los siguientes pasos para configurar tu proyecto para integrar la encriptación de flash, documentando todos los pasos y posibles observaciones en la memoria. Como en anteriores ejercicios, utiliza el mismo proyecto (<code>blink</code>) pero trabaja en una nueva carpeta, por ejemplo <code>blink_encrypted</code>. Parte del proyecto en blanco, no del que integra el arranque seguro.</p>
</div>
<p>La encriptación de flash tiene como objetivo encriptar los contenidos de la memoria
flash del ESP32. Cuando se habilita, el firmware se flashea en claro, y se encripta al 
vuelo (<em>in-place</em>) en el primer arranque. Así, una simple lectura de flash deja de 
ser suficiente como para recuperar los datos almacenados.</p>
<p>Esta característica puede o no habilitarse junto al arranque seguro, aunque en esta práctica<strong>no las combinaremos</strong>.</p>
<p>Cuando se habilita, los siguientes tipos de partición se encriptan por defecto:</p>
<ul>
<li><em>Second stage bootloader</em>.</li>
<li>Tabla de particiones.</li>
<li>NVS.</li>
<li>OTADATA.</li>
<li>Todas las particiones de tipo <em>app</em>.o</li>
</ul>
<p>Tienes una referencia sobre los eFuses a activar en la <a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/security/flash-encryption.html#relevant-efuses">documentación oficial</a>.</p>
<h3 id="como-funciona-la-encriptacion">Cómo funciona la encriptación</h3>
<p>Asumiendo que se ha activado la encriptación, ésta procede de la siguiente manera:</p>
<ol>
<li>En el primer arranque, los datos en flash están desencriptados (almacenados en claro).</li>
<li>El bootloader lee el eFuse <em>FLASH_CRYPT_CNT</em>. Si su valor es 0, configura el bloque de encriptación (la activa).</li>
<li>El bootloader chequea si hay una clave válida presente en eFuse. Si es el caso, no se genera una nueva. Si no lo es se procede a la generación de una clave y se almacena en el eFuse <em>flash_encryption</em>.</li>
<li>El hardware de encriptación encripta los contenidos de la flash. Este proceso puede ser lento.</li>
<li>El bootloader fija la activación modificando el valor del eFuse FLASH_CRYPT_CNT.</li>
<li>El dispositivo se resetea.</li>
</ol>
<h3 id="como-se-activa-la-encriptacion-modo-development">Cómo se activa la encriptación (modo <em>development</em>)</h3>
<p>En el menú de configuración, simplemente busca y activa la opción <em>Enable Flash Encryption on Boot</em>.</p>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Activa la encriptación de FLASH en tu proyecto <code>blink</code>. Observa y anota las fases por las que pasa el proceso de arranque (añade logs al bootloader) y comprueba si coinciden con las fases anteriormente mencionadas. ¿Notas alguna penalización de rendimiento evidente en alguna fase?</p>
</div>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Tras observar el funcionamiento con el proyecto <code>blink</code>, sería conveniente observar el efecto de la encriptación en los datos almacenados en flash. Para ello, usaremos el ejemplo <code>flash_encryption</code> de ESP-IDF. Clónalo y chequea si está o no activa la encriptación. A continuación, flashea y ejecuta (en QEMU) el código. Observa la salida. Cambia la funcionalidad de encriptación y vuelve a observarla. ¿Qué ves en pantalla? Estudia el código e intenta entender qué está pasando, y por qué en un caso el contenido de la flash es "entendible", y en otro no. ¿Qué funciones usa el código para realizar la lectura con desencriptación y en crudo?</p>
</div>
<h2 id="encriptacion-de-nvs">Encriptación de NVS</h2>
<p>De forma independiente a la encriptación de FLASH, es posible llevar a cabo un proceso de encriptación únicamente de los datos almacenados en NVS en forma clave-valor. Esta solución aporta cierta seguridad (en una parte de los datos), y a la vez no empeora el rendimiento como sí hace la encriptación total de flash.</p>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>El ejemplo <code>nvs_encryption_hmac</code> propone una forma muy sencilla de observar el efecto de la encriptación de NVS sobre el contenido que se almacena en la partición NVS de la flash. Compílalo y ejecútalo tal con NVS desactivado (busca la opción correspondiente en los menús de configuración). ¿Qué observas? A continuación, activa la encriptación NVS. ¿Qué observas? <strong>IMPORTANTE: este proyecto debe configurarse para ESP32-C3, ya que solo él tiene soporte para HMAC, técnica usada para encriptar NVS. Además, la opción eFuse key ID storing the HMAC key debe fijarse a 3</strong>. En todo caso, la ejecución se emulará vía QEMU. Recuerda: <strong>no conectes tu placa</strong>.</p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="../../js/mathjax.js"></script>
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
