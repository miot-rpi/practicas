<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 8 - Master IoT UCM - Prácticas RPI/LSI</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/LSI</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Calendario</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">LSI <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../LSI/Lab0/">Laboratorio 0</a>
</li>
                                    
<li >
    <a href="../../LSI/Lab1/">Laboratorio 1</a>
</li>
                                    
<li >
    <a href="../../LSI/Lab2/">Laboratorio 2</a>
</li>
                                    
<li >
    <a href="../../LSI/Lab3/">Laboratorio 3</a>
</li>
                                    
<li >
    <a href="../../LSI/Lab4/">Laboratorio 4</a>
</li>
                                    
<li >
    <a href="../../LSI/Lab5/">Laboratorio 5</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">RPI-I <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../RPI-I/P1/">Práctica 1</a>
</li>
                                    
<li >
    <a href="../../RPI-I/P2/">Práctica 2</a>
</li>
                                    
<li >
    <a href="../../RPI-I/P3/">Práctica 3</a>
</li>
                                    
<li >
    <a href="../../RPI-I/P4/">Práctica 4</a>
</li>
                                    
<li >
    <a href="../../RPI-I/P5/">Práctica 5</a>
</li>
                                    
<li >
    <a href="../../RPI-I/P6/">Práctica 6</a>
</li>
                                    
<li >
    <a href="../../RPI-I/P7/">Práctica 7</a>
</li>
                                    
<li >
    <a href="../../RPI-I/P8/">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">RPI-II <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../RPI-II/P1_I/">Práctica 1 (I)</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P1_II/">Práctica 1 (II)</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P6/">Práctica 2 (I)</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P6-II/">Práctica 2 (II)</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P5/">Práctica 3</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P7/">Práctica 4</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P3/">Práctica 5</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P10/">Práctica 6</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P8/">Práctica 7</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P11/">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">ANIOT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../P1/">Práctica 1</a>
</li>
                                    
<li >
    <a href="../P2/">Práctica 2</a>
</li>
                                    
<li >
    <a href="../P3/">Práctica 3</a>
</li>
                                    
<li >
    <a href="../P4/">Práctica 4</a>
</li>
                                    
<li >
    <a href="../P5/">Práctica 5</a>
</li>
                                    
<li >
    <a href="../P6/">Práctica 6</a>
</li>
                                    
<li >
    <a href="../P7/">Práctica 7</a>
</li>
                                    
<li class="active">
    <a href="./">Práctica 8</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../P7/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="disabled">
                                <a rel="prev" >
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#practica-8-modos-de-bajo-consumo">Práctica 8. Modos de bajo consumo</a></li>
            <li><a href="#objetivos">Objetivos</a></li>
            <li><a href="#material-de-consulta">Material de consulta</a></li>
            <li><a href="#modos-de-bajos-consumo">Modos de bajos consumo</a></li>
            <li><a href="#gestor-automatico-de-consunmo">Gestor automático de consunmo</a></li>
            <li><a href="#ejercicios-basicos">Ejercicios básicos</a></li>
            <li><a href="#ejercicio-avanzado">Ejercicio avanzado</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="practica-8-modos-de-bajo-consumo">Práctica 8. Modos de bajo consumo</h1>
<p>Esta práctica se desarrollará el 29 de noviembre.</p>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo de esta práctica es  conocer los diferentes modos de bajo consumo que ofrece el ESP32 y la interfaz que expone ESP-IDF para usarlos.</p>
<p>Trabajaremos los siguientes aspectos:
* Paso explícito a <em>light-sleep</em> y a <em>deep-sleep</em>.
* Probar diferentes mecanismos para volver de modos de bajo consumo.
* Usar el gestor automático de ahorro energético.</p>
<h2 id="material-de-consulta">Material de consulta</h2>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/sleep_modes.html">Descripción de modos de bajo consumo</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/power_management.html">Gestión automática de consumo</a></li>
<li><a href="https://github.com/espressif/esp-idf/tree/439a709c4298b0f613d09b47fc0b7b9728fc5733/examples/system/light_sleep">Ejemplo sobre light-sleep</a></li>
</ul>
<h2 id="modos-de-bajos-consumo">Modos de bajos consumo</h2>
<p>ESP32 ofrece dos modos de ahorro de consumo energético: <em>Light-sleep</em> y <em>Deep-sleep</em>.</p>
<p>En el modo <em>light-sleep</em> se corta la señal de reloj de los periféricos digitales, la mayor parte de la RAM y la CPU; además, se reduce la tensión de alimentación, pero se mantiene por encima de la necesaria para retener la información. Así, el sistema no puede ejecutar ninguna tarea, pero no perdemos la información almacenada en registros y memoria. Al salir de <em>light-sleep</em> los periféricos digitales, RAM y CPU continúan su operación como si nada hubiera pasado.</p>
<p>En el modo <em>deep-sleep</em> la CPU, la mayor parte de la RAM y los periféricos cuyo señal de reloj viene de <em>APB_CLK</em> se apagan por completo. Las únicas partes del chip que mantienen alimentación son:</p>
<ul>
<li>Controlador RTC (Real Time Clock). Para mantener la hora del sistema</li>
<li>Co-procesador ULP (<em>ultra-lowpower</em>).</li>
<li>RTC fast memory</li>
<li>RTC slow memory</li>
</ul>
<p>Hay varias fuentes que permiten despertar al sistema cuando se encuentra en <em>deep-sleep</em> o en <em>ligth-sleep</em>. Podemos especificar varias fuentes de manera que el sistema despierte ante cualquier de ellas. Para configurarlas, ESP-IDF proporciona llamadas de la forma <code>esp_sleep_enable_X_wakeup()´; para deshabilitarlas, existe</code>esp_sleep_disable_wakeup_source()`.</p>
<p>Tras configurar la(s) fuente(s) que nos permitirán salir del modo de bajo consumo, podemos entrar en uno de los dos llamando a <code>esp_light_sleep_start()</code> or <code>esp_deep_sleep_start()</code>. Tanto Wi-Fi como Bluetooth dejarán de funcionar y deberían apagarse antes de entrar en modos de bajo consumo. Si la conexión Wi-Fi debe mantenerse, será necesario utlizar el gestor automático de ahorro energético.</p>
<h2 id="gestor-automatico-de-consunmo">Gestor automático de consunmo</h2>
<p>El <em>Power Manager</em> proporcionado por ESP-IDF permite controlar la frecuencia las señales de reloj de la CPU y del bus APB, e incluso pasar a <em>ligth-sleep</em> en períodos de inactividad. Asimismo permite el uso y creación de <em>cerrojos</em> que, en determinadas fases de nuestra aplicación, limitan las acciones del gestor de consumo por determinadas necesidades (mantener una velocidad de APB, mantener interrupciones activas...).</p>
<p>El gestor automático se puede habilitar en tiempo de compilación (a través de <em>menuconfig</em>) usando la opción <code>CONFIG_PM_ENABLE</code>. Habilitar esta opción aumenta la latencia del tratamiento de interrupciones y disminuye la precisión del reloj del sistema (utilizado para mantener la hora, <em>timers</em>...).</p>
<p>Además de hablitar la opción en tiempo de compilación, es necesario configurar su uso en ejecución llamando a <code>esp_pm_configure()</code> que recibe un argumento de tipo <code>esp_pm_config_esp32_t</code> que tiene tres campos:</p>
<ul>
<li><code>max_freq_mhz</code>: frecuencia de CPU máxima en MHz. Es la frecuencia que se utilizará cuando el algún componente adquiera le cerrojo 'ESP_PM_CPU_FREQ_MAX'. Lo habitual es que se deje a la frecuencia por defecto (240MHZ).</li>
<li><code>min_freq_mhz</code>: frecuencia mínima en MHz. Es la frecuencia que se usará si se adquiere el cerrojo  <code>ESP_PM_APB_FREQ_MAX</code>.</li>
<li><code>light_sleep_enable</code>: indica si el sistema debería pasar automáticamente al modo <em>light-sleep</em> en períodos de inactividad (con ningún cerrojo adquirido por ningún componente). Es un valor <code>true</code> o <code>false</code>.</li>
</ul>
<p>Para poder habilitar la tercera opción (<code>light_sleep_enable</code>), debemos habilitar la funcionalidad <em>Tickless Idle</em> en <em>Menuconfig</em> con la opción <code>CONFIG_FREERTOS_USE_TICKLESS_IDLE</code>. En caso contrario, <code>esp_pm_configure()</code> devolverá el error <em>ESP_ERR_NOT_SUPPORTED</em> si tratamos de habiltar la opción <code>light_sleep_enable</code>.</p>
<p>Si todo está configurado correctamente y no hay ningún cerrojo adquirido, el sistema podrá pasar al modo <em>light-sleep</em> tras un período de inactividad. El sistema permanecerá en dicho modo  en función de eventos como:</p>
<ul>
<li>Tareas de FreeRTOS bloqueadas por algún <em>timeout</em> finito (como <code>vTaskDelay()</code>).</li>
<li><em>Timers</em> registrados con el API de <em>High resolution timer</em></li>
</ul>
<p>El sistema saldrá de <em>light-sleep</em> para tratar el evento más próximo. Si queremos que nuestros <em>timers</em> no nos saquen de <em>light-sleep</em> los podemos inicializar con la opción <code>skip_unhandled_events</code>.</p>
<h2 id="ejercicios-basicos">Ejercicios básicos</h2>
<p>Vamos a partir  <a href="https://github.com/espressif/esp-idf/tree/439a709c4298b0f613d09b47fc0b7b9728fc5733/examples/system/light_sleep">del ejemplo que entra manualmente en <em>light-sleep</em></a>. </p>
<div class="admonition danger">
<p class="admonition-title">Tareas</p>
<ul>
<li>Hacer funcionar el ejemplo, permitiendo que volvamos de <em>light-sleep</em> tanto por un <em>timer</em> como por GPIO.</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<ul>
<li>¿Qué número de GPIO está configurado por defecto para despertar al sistema? ¿Está conectado dicho GPIO a algún elemento de la placa <em>ESP Devkit-c</em> que estamos usando? <a href="https://dl.espressif.com/dl/schematics/esp32_devkitc_v4-sch.pdf">Puedes tratar de responder consultando el esquemático de la placa</a></li>
</ul>
</div>
<div class="admonition danger">
<p class="admonition-title">Tareas</p>
<ul>
<li>Incluir un <em>timer</em> en el código. La aplicación arrancará, configurará un <em>timer</em> para que se ejecute su <em>callback</em> cada 0.5 segundos, y se dormirá durante 3 segundos (con <code>vTaskDelay()</code>). Tras despertar del <em>delay</em>, pasará a <em>light-sleep</em> (configuraremos el mecanismo de despertar para que lo haga en 5 segundos, si no usamos el GPIO correspondiente). El <em>callback</em> del timer imprimirá un mensaje que incluirá el valor devuelto por <code>esp_timer_get_time()</code>. </li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<ul>
<li>¿Qué observas en la ejecución de los <em>timer</em>?¿Se ejecutan en el instante adecuado?¿Se pierde alguno?</li>
</ul>
</div>
<div class="admonition danger">
<p class="admonition-title">Tareas</p>
<ul>
<li>Modifica el código anterior para que, tras 5 pasos por <em>ligth-sleep</em>, pasemos a <em>deep-sleep</em>. Incluye código para determinar el motivo por el que hemos despertado de <em>deep-sleep</em> y muéstralo por pantalla.</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<ul>
<li>¿Qué diferencia se observa al volver de <em>deep-sleep</em> respecto a volver de <em>light-sleep</em>?</li>
</ul>
</div>
<div class="admonition danger">
<p class="admonition-title">Tareas</p>
<ul>
<li>Crea una nueva aplicación que haga uso del <em>Power manager</em>. La aplicación leerá el sensor <em>Hall</em> periódicamente usando un <em>High Precission Timer</em>. El sistema deberá pasar automáticamente a <em>light-sleep</em> tras un período de inactividad. Mide el consumo energético para comprobar el paso.</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<ul>
<li>¿Qué ocurre si habilitamos <code>skip_unhandled_events</code> en el <em>timer</em>?</li>
</ul>
</div>
<h2 id="ejercicio-avanzado">Ejercicio avanzado</h2>
<p>Integraremos el control de energía en la aplicación que hemos ido desarrollando a lo largo de estas prácticas (lectura periódica del sensor de temperatura).</p>
<div class="admonition danger">
<p class="admonition-title">Tareas</p>
<p>Completar la aplicación de modo que:</p>
<ul>
<li>Se realice una lectura periódica (cada 10 segundos) del sensor de temperatura. Este código estará en un componente.</li>
<li>Se configure el gestor de energía para que entre automáticamente en <em>light-sleep</em> cuando sea posible.</li>
<li>Tras 12 horas de funcionamiento, pasará al modo <em>deep-sleep</em> durante otras 12 horas (para pruebas, en lugar de 12 horas probadlo con 1 minuto).</li>
<li>Compruebe el motivo por el que se produce cada reinincio y lo anote en NVS.</li>
<li>Escriba en NVS la última medida del sensor tomada.</li>
</ul>
</div></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
