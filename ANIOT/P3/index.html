<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 3 - Master IoT UCM - Prácticas RPI</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-I <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-II <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_II/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6/" class="dropdown-item">Práctica 2 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6-II/" class="dropdown-item">Práctica 2 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P7/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P3/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P10/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P8/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">ANIOT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Práctica 3</a>
</li>
                                    
<li>
    <a href="../P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P2/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P4/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#practica-3-uso-de-timers-y-gpio" class="nav-link">Práctica 3. Uso de timers y GPIO.</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#material-de-consulta" class="nav-link">Material de consulta</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#introduccion" class="nav-link">Introducción</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#esp-idf-high-resolution-timer" class="nav-link">ESP-IDF: High Resolution Timer</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#esp-idf-gpio" class="nav-link">ESP - IDF: GPIO</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ejercicios-basicos" class="nav-link">Ejercicios básicos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ejercicios-avanzados" class="nav-link">Ejercicios avanzados</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-3-uso-de-timers-y-gpio">Práctica 3. Uso de timers y GPIO.</h1>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo  de esta práctica es conocer los mecanismos para la gestión de tareas
que ofrece FreeRTOS, concretamente en su porting  ESP-IDF (con alguna
particularidad por el hecho de estar adaptado a tener 2 cores).</p>
<p>Trabajaremos los siguientes aspectos del API de ESP-IDF:</p>
<ul>
<li>Familiarizarse con la API de <em>High Resolution Timers</em>  en ESP/IDF.</li>
<li>Utilización de elementos conectados a pines controlados por GPIO</li>
</ul>
<h2 id="material-de-consulta">Material de consulta</h2>
<p>Para ver los detalles de cada aspecto de esta práctica se recomienda la lectura de los siguientes enlaces:</p>
<ul>
<li><a href="hhttps://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/esp_timer.html">API de High Resolution Timers</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/gpio.html">Documentación sobre GPIO - ESP32</a></li>
</ul>
<h2 id="introduccion">Introducción</h2>
<p>Debe evitarse el uso de llamadas tipo <em>delay()</em> para la gestión de  tareas periódicas. No proporciona la precisión necesaria y obliga a realizar estimaciones del tiempo transcurrido entre dos llamadas para ajustar el tiempo de la siguiente espera.</p>
<p>Para solventar ese problema, lo más aconsejable es usar <em>Timers</em>, contadores hardware que interrumpen la ejecución cada cierto tiempo (programable). En esta práctica exploraremos el uso de los <em>timers</em> que proporciona ESP-IDF.</p>
<p>Asimismo, comenzaremos a examinar mecanismos básicos de entrada/salida. Concretamente, estudiaremos el uso del controlador de GPIO (<em>General Puropose Input/Output</em>) que permite interaccionar con los pines del SoC (algunos de ellos, disponibles en la placa).</p>
<h2 id="esp-idf-high-resolution-timer">ESP-IDF: High Resolution Timer</h2>
<p>Un <em>Timer</em> es un temporizador que podemos programar para que nos <em>avise</em> transcurrido un cierto tiempo. Es similar a una cuenta atrás con alarma y es un mecanismo perfecto para planificar tareas periódicas. El <em>aviso</em> será asíncrono, por lo que no sabemos en qué punto de nuestro código estaremos cuando se dispare la alarma.</p>
<p>ESP-IDF ofrece un API para el uso de <em>timers</em> que, a su vez, utlizan los <em>timers</em> de 64 bits disponibles en el hardware para garantizar una precisión de hasta 50us. </p>
<p>Cuando programamos un <em>timer</em> podemos optar por 2 comportamientos:</p>
<ul>
<li><em>One-shot</em> (<code>esp_timer_start_once()</code>), que programrá el <em>timer</em> para que genere una única alarma transcurrido el plazo establecido.</li>
<li><em>Continuo</em> (<code>esp_timer_start_periodic()</code>) que re-programará el <em>timer</em> de forma automática cada vez que la cuenta llegue a 0. Este mecanismo es el idóneo para muestreos periódicos.</li>
</ul>
<p>Cuando el <em>timer</em> genere la alarma, se ejecutará un <em>callback</em>, una función que habremos definido previamente (y asociado a ese <em>timer</em>). Dicha función se ejecutará en el contexto de una tarea específica (<code>ESP_TIMER_TASK</code>) o en el de una rutina de tratamiento de interrupción (<code>ESP_TIMER_ISR</code>). En nuestro caso, es aconsejable usar el primer mecanismo (tarea específica).</p>
<p>En la <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/esp_timer.html">documentación de ESP-IDF</a> podéis encontrar el resto de llamadas relevantes para crear y configurar <em>timers</em>. Es muy recomendable, asimismo, estudiar los <a href="https://github.com/espressif/esp-idf/tree/master/examples/system/esp_timer">ejemplos disponibles en la distribución</a></p>
<p>A continuación se incluye un ejemplo de uso, extraíado de la distribución de ESP-IDF:</p>
<pre><code class="language-c">void app_main() { 
     ...
    const esp_timer_create_args_t periodic_timer_args = {
         .callback = &amp;periodic_timer_callback,
         .name = &quot;periodic&quot; };
    esp_timer_handle_t periodic_timer; esp_timer_create(&amp;periodic_timer_args, &amp;periodic_timer);
     ...
    esp_timer_start_periodic(periodic_timer, 500000); ....
    esp_timer_stop(periodic_timer); ...
    esp_timer_delete(periodic_timer); 
}

static void periodic_timer_callback(void* arg) { 
    int64_t time_since_boot = esp_timer_get_time();
    printf(&quot;Periodic timer called, time since boot: %lld us&quot;,time_since_boot);
}
</code></pre>
<h2 id="esp-idf-gpio">ESP - IDF: GPIO</h2>
<p>Los controladores de GPIO (<em>General Purpose Input-Ouput</em>) permiten controlar ciertos pines de nuestro dispositivo para usarlos como entrada (por ejemplo, para conectar un botón) o salida (por ejemplo para conectar un LED) o con funciones <em>especiales</em> (que forme parte de un bus serie, por ejemplo). </p>
<p>El SoC ESP32 que usamos proporciona 40 GPIO <em>pads</em> (el SoC no tiene pines propiamente dichos, sino conectores, normalmente de superfície, que se deminan <em>pad</em>). El módulo WROOM-32 que usamos expone 38 de ellos, que son accesibles a traves de los pines (los conectores físicos a ambos lados de la placa) que incorpora nuestra placa DevKitC.</p>
<p>En la siguiente figura se muestra la disposición de los pines en la placa ESP32-DevKitC que usamos en nuestras prácticas: </p>
<p><img alt="pinout" src="img/esp32-devkitC-v4-pinout.png" /></p>
<p>En <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/hw-reference/esp32/get-started-devkitc.html">la web de Espressif</a> se pueden encontrar más detalles de la placa.</p>
<p><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/gpio.html">Como se indica en la documentación de  ESP-IDF</a>, algunos de esos pines tiene un propósito específico. Por ejemplo, GPIO6-11 y 16-17 no deben usarse porque están internamente conectados a la memoria SPI flash. También nos indica que los pines del canal 2 del ADC (ADC2) NO deben usarse mientras se utiliza Wi-Fi.  Es muy conveniente leer todas las restricciones para evitar problemas en nuestros desarrollos.</p>
<p>La documentación muestra también la API que ofrece ESP-IDF para configurar los pines (entrada o salida, uso de pull-up/pull-down) establecer un valor lógico (0 ó 1)en un pin (previamente configurado como salida) o leer el valor lógico de un pin (configurado como entrada).</p>
<p>El siguiente código, <a href="https://github.com/espressif/esp-idf/tree/master/examples/peripherals/gpio/generic_gpio">extraído del ejemplo de GPIO proporcionado en la distribución ESP-IDF</a>, muestra cómo configurar los pines GPIO18 y GPIO19 como salida. Observa cómo se construye la máscara de bits <code>GPIO_OUTPUT_PIN_SEL</code> para indicar a <code>gpio_config()</code> qué pines se configuran.</p>
<pre><code class="language-c">#define GPIO_OUTPUT_IO_0 18
#define GPIO_OUTPUT_IO_1 19
#define GPIO_OUTPUT_PIN_SEL ((1ULL&lt;&lt;GPIO_OUTPUT_IO_0) | (1ULL&lt;&lt;GPIO_OUTPUT_IO_1))
gpio_config_t io_conf;
io_conf.intr_type = GPIO_PIN_INTR_DISABLE; 
io_conf.mode = GPIO_MODE_OUTPUT; 
io_conf.pin_bit_mask = GPIO_OUTPUT_PIN_SEL; 
io_conf.pull_down_en = 0; 
io_conf.pull_up_en = 0; 
gpio_config(&amp;io_conf);
</code></pre>
<p>Posteriormente, podemos establecer el valor lógico de la salida con una llamada similar a <code>gpio_set_level(GPIO_OUTPUT_IO_1, valor);</code>, siendo <code>valor</code> igual a 0 ó 1.</p>
<p>De forma similar el siguiente código configura los pines 4 y 5 como entrada:</p>
<pre><code class="language-c">
    #define GPIO_INPUT_IO_0 4
    #define GPIO_INPUT_IO_1 5
    #define GPIO_INPUT_PIN_SEL ((1ULL&lt;&lt;GPIO_INPUT_IO_0) | (1ULL&lt;&lt;GPIO_INPUT_IO_1))
    gpio_config_t io_conf;  
    io_conf.pin_bit_mask = GPIO_INPUT_PIN_SEL;
    io_conf.mode = GPIO_MODE_INPUT;
    gpio_config(&amp;io_conf);
</code></pre>
<p>Posteriormente, podremos leer el valor lógico de esos pines con una llamada a <code>gpio_get_level()</code>.</p>
<h2 id="ejercicios-basicos">Ejercicios básicos</h2>
<h3 id="uso-de-timers">Uso de timers</h3>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Nuevamente procederemos a muestrear el sensor de efecto Hall, pero esta vez usando un <em>timer</em>. Crea un <em>timer</em> con un período de 2 segundos y realiza la lectura del sensor en el <em>callback</em>. Dicho <em>callback</em> generará un evento que desencadenará la escritura del valor leído en el puerto serie.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<p>¿Qué hará la tarea inicial (la que invoca a <code>app_main()</code>) tras configurar el <em>timer</em> y el <em>evento</em>?</p>
</div>
<h3 id="encendido-de-leds-con-gpio">Encendido de LEDs con GPIO</h3>
<p>El entrenador que está en el laboratorio, cuenta con 8 LEDs que podemos conectar a nuestro ESP32. Para ello, basta con conectar el pin de GPIO escogido (que configuraremos como entrada) al conector de un LED. También debemos asegurarnos <strong>de que las tierras son comunes</strong>. Para ello, conectaremos el pin de tierra del ESP32 al conector <em>GND</em> del entrenador.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Configura un GPIO como salida y conéctalo a un LED del entrenador del laboratorio. Programa un <em>timer</em> para cambiar el estado del LED cada segundo. Recuerda usar una tierra común.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<p>¿Qué diferencia hay entre habilitar el <em>pull-up</em> o el <em>pull-down</em> del GPIO elegido?</p>
</div>
<h3 id="lectura-con-gpio">Lectura  con GPIO</h3>
<p>Al configurar un pin de GPIO como entrada, podemos comprobar, por ejemplo. si un botón está pulsado </p>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<ul>
<li>¿Qué voltaje se observa en los botones y swithches del entrenador? ¿Podemos conectarlos a los pines del ESP32?.</li>
<li>Trata de conseguir una tensión de 3.3V usando el potenciómetro del entrenador. Puedes medir con el voltímetro para asegurarte de conseguir esa tensión.</li>
</ul>
</div>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Configura un pin GPIO como entrada y moniroiza su valor mediante un <em>timer</em>. Escribe por el puerto srie cada vez que se produzca un cambio en el nivel observado. Si usas el potenciómetro, <strong>ten mucho cuidado para no sobrepasar los 3.3V</strong>.</p>
</div>
<h2 id="ejercicios-avanzados">Ejercicios avanzados</h2>
<h3 id="contador-binario">Contador binario</h3>
<p>Crea un módulo (fichero C independiente) que gestione cuatro pines GPIO como salida y permita implementar un contador binario (de 0 a 15) al conectarlos a los LEDs del entrenador. El módulo tendrá un API que permitira:</p>
<ul>
<li>Resetear la cuenta. El contador volverá a 0.</li>
<li>Incrementar la cuenta. Se incrementará en uno, módulo 16.</li>
<li>Decrementar la cuenta. Se decrementará en uno, módulo 16.</li>
</ul>
<p>La aplicación principal reseteará el contador y arrancará un <em>timer</em> con un período inicial de  1 segundo. A cada segundo, se incrementará la cuenta.</p>
<p>Asimismo, se programará un pin GPIO como entrada. Se muestreará dicho pin con una período de 500ms. Cuando se perciba un cambio de nivel lógico, se modificará el sentido de la cuenta (ascendente - descendente).</p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Escribe una aplicación que implemente el comportamiento anterior.</p>
</div>
<h3 id="interrupciones">Interrupciones</h3>
<p>Las interrupciones son un mecanismo más eficiente que el muestreo para atender eventos externos. ESP-IDF ofrece la posibilidad de configurar los GPIO como entrada y fuente de interrupciones (no son la única fuente de interrupciones).</p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Modifica el ejercicio de lectura del GPIO para que funcione por interrupciones. </p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
