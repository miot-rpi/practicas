<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Práctica 5. Bus I2C. Sensor de temperatura - Master IoT UCM - Prácticas RPI/LSI/ANIOT</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">Master IoT UCM - Prácticas RPI/LSI/ANIOT</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">LSI <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../LSI/Lab0/" class="dropdown-item">Laboratorio 0</a>
</li>
                                    
<li>
    <a href="../../../LSI/Lab1/" class="dropdown-item">Laboratorio 1</a>
</li>
                                    
<li>
    <a href="../../../LSI/Lab2/" class="dropdown-item">Laboratorio 2</a>
</li>
                                    
<li>
    <a href="../../../LSI/Lab3/" class="dropdown-item">Laboratorio 3</a>
</li>
                                    
<li>
    <a href="../../../LSI/Lab4/" class="dropdown-item">Laboratorio 4</a>
</li>
                                    
<li>
    <a href="../../../LSI/Lab5/" class="dropdown-item">Laboratorio 5</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-I <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-II <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P1_II/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P6/" class="dropdown-item">Práctica 2 (I)</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P6-II/" class="dropdown-item">Práctica 2 (II)</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P5/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P7/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P3/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P10/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P8/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../../RPI-II/P11/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">ANIOT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#practica-5-bus-i2c-sensor-de-temperatura" class="nav-link">Práctica 5. Bus I2C. Sensor de temperatura</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#material-de-consulta" class="nav-link">Material de consulta</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#bus-i2c" class="nav-link">Bus I2C</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#interfaz-i2c-en-esp-idf" class="nav-link">Interfaz I2C en ESP-IDF</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sensor-si7021" class="nav-link">Sensor Si7021</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ejercicios-obligatorios" class="nav-link">Ejercicios obligatorios</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ejercicios-avanzados" class="nav-link">Ejercicios avanzados</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-5-bus-i2c-sensor-de-temperatura">Práctica 5. Bus I2C. Sensor de temperatura</h1>
<p>Esta práctica se desarrollará en <em>2 sesiones: el 25 de octubre y el 8 de noviembre.</em></p>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo de esta práctica es conocer el funcionamiento del bus I2C y la interfaz que ofrece ESP-IDF para su uso.
Trabajaremos los siguientes aspectos del API de ESP-IDF: 
* Configuración y uso del controlador I2C.
* Uso de sensor de temperatura y humedad (Si7021).</p>
<h2 id="material-de-consulta">Material de consulta</h2>
<p>Para ver los detalles de cada aspecto de esta práctica se recomienda la lectura de los siguientes enlaces:</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/i2c.html">Documentación del API de I2C</a></li>
<li><a href="https://www.i2c-bus.org/">Recurso online sobre I2C</a></li>
<li><a href="https://www.silabs.com/documents/public/data-sheets/Si7021-A20.pdf">Hoja de especificaciones del sensor Si7021</a></li>
</ul>
<h2 id="bus-i2c">Bus I2C</h2>
<p>Fue desarrollado en la empresa <strong>Philips</strong> (ahora <strong>NXP</strong>) en la década de los 80 con el objetivo de  comunicar circuitos integrados con número mínimo de pines. El nombre I2C viene de <em>Inter IC</em>. Se usa tanto la abreviatura I2C como IIC. En 2014, <em>NXP</em> publicó la Rev. 6 del protocolo.</p>
<p>Proporciona una conexión <em>serie síncrona unidireccional</em> (no permite envíos en dos direcciones de forma simultanea). La velocida máxima de comunicación era originalmente de 100 kbit/s, y muchas aplicaciones no requieren de velocidades mayores. Existe un <em>fast mode</em> a 400kbits/s, <em>fast mode plus</em>  (1Mbits/s), ambos compatibles hacia atrás y sin lógica adicional (aunque puede suponer ajustes en las resistencias de <em>pull-up</em> para controlar las corrientes requeridas).  La especificación  <em>high speed mode - HS I2C</em> permite conexiones a 3.4Mbits/s, pero exige lógica adicional. En nuestras pruebas, se recomienda mantener 400 kbits/s.</p>
<p>Las principales características de I2C son:
* Sólo require dos líneas: SDA y SCL. 
* No hay requerimientos estrictos de <em>baud rate</em> como en RS232, ya que el <em>master</em> genera la señal de reloj.
* Existe una relación sencilla <em>master/slave</em> entre todos los componentes.
* Permite tener varios <em>master</em> pues proporciona mecanismos de arbitraje y detección de colisiones.
* Cada dispositivo tiene una única dirección de 7-bits (en ocasiones, de 10 bits) que proporciona el fabricante.</p>
<h2 id="interfaz-i2c-en-esp-idf">Interfaz I2C en ESP-IDF</h2>
<p>ESP-IDF <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/i2c.html">proporciona un API</a> para el uso de dispositivos I2C. Permite usar el ESP32  tanto como <em>master</em> como en modo <em>slave</em>. Nuestro SoC ESP2 dispone de dos controladores, por lo que podríamos configurar uno como <em>master</em> y otro como <em>slave</em> (o cualquier otra combinación).</p>
<p>Los pasos para usar un dispositivo I2C son:</p>
<ul>
<li>Configuración de la conexión. Indcaremos qué pines usamos como SDA y como SCL, si queremos  habilitar <em>pull-up</em> (es aconsejable tener uno externo), el modo (<em>master/slave</em>) y la frecuencia de reloj en HZ. Todo ello se escribe en una estructura de tipo <code>i2c_configt_t</code>y se cconfigura mediante la llamada a <code>i2c_param_config()</code>.</li>
<li>Instalación del driver mediante la llamada <code>i2c_driver_install</code>, donde indicaremos, entre otras cosas, qué controlador I2C usaremos (0 o 1).</li>
<li>Realizar las escrituras y lecturas necesarias.</li>
</ul>
<p>Para comuicarnos con un sensor, configuraremos el ESP32 en modo <em>master</em>. Tras instalar el <em>driver</em> procederemos a iniciar la comunicación con el sensor:</p>
<p><img alt="escritura" src="img/i2c-espidf.png" /></p>
<p>Como se indica en la figura anterior, extraída de la web oficial de Espressif, debemos crear un paquete de comandos (<em>cmd_link</em>) mediante la llamda a <code>i2c_cmd_link_create()</code>. En ella incluiremos cada elemento del protocolo I2C:
* Bit de start.
* Dirección del dispositivo <em>slave</em> (7 bits).
* Bit de lectura/escritura.
* Secuencia de bytes que se desean escribir.</p>
<p>Es importante resaltar que, aunque lo que deseemos sea leer de un sensor (por ejemplo, leer la temperatura), es necesario escribir en el bus, pues lo primero que haremos será enviar la dirección (primer <em>write_byte</em>) y, habitualmente, un comando al dispositivo sensor.</p>
<p>También conviene resaltar que la comunicación no se produce hasta que no se llega a la llamada <code>i2c_master_cmd_begin()</code>.</p>
<p>En la siguiente figura se observa un patrón habitual para la lectura:</p>
<p><img alt="lectura" src="img/i2c_read.png" /></p>
<p>Nuevamente, la primera llamada (tras crear el enlace y el bit de <em>start</em>), es a <code>i2c_master_write_byte()</code>, pero esta vez se establecerá el bit de operación a lectura (el bit que se incluye tras los 7 bits de dirección del <em>slave</em>). Tras enviar ese primer byte, el ESP32 quedará a la escucha de bytes por parte del sensor mediante llamadas a <code>i2c_master_read()</code>.</p>
<p>Como en el ejemplo anterior, la comunicación no se produce hasta que no se llega a la llamada <code>i2c_master_cmd_begin()</code>, por lo que si queremos leer varios bytes debemos almacenarlos en posiciones diferentes de memoria y procesarlos después de esta llamada.</p>
<p>Existen también llamadas de más alto nivel, como <code>i2c_master_read_from_device()</code> y <code>i2c_master_write_read_device()</code> que permiten, en ocasiones, simplificar nuestro código.</p>
<h2 id="sensor-si7021">Sensor Si7021</h2>
<p>El Si7021 es un sensor de humedad y temperatura fabricado por <em>Silicon Labs</em>. Este sensor incopora un ADC internamente, que permite digitalizar las lecturas de los sensores y enviarlas a través del interfaz I2C integrado.</p>
<p><img alt="sensor" src="img/si7021.png" /></p>
<p>En el maletín del máster viene montado en una <a href="https://www.adafruit.com/product/3251">placa fabricada por <em>Adafruit</em></a>. Adfruit es una compañía fundada por Limor Fried con la intención de convertirse en un portal de referencia para el aprendizaje de electrónica y la fabricación de diseños para <em>makers</em> de todos los niveles. ¡Merece mucho la pena echar un vistazo a su <em>web</em>!</p>
<p>Dependiendo de la versión del PCB que haya en el maletín, puede que únicamente haya pines expuestos (<em>Vin</em>, <em>3Vo</em>, <em>GND</em>, <em>SCL</em> y <em>SDA</em>) o conectores <em>STEMMA QT</em>, compatible con los conectores <a href="https://www.sparkfun.com/qwiic"><em>Qwiic</em> de Sparkfun</a> (Sparkfun es otra compañía tan interesante como <em>Adafruit</em>). Lamentablemente, nuestra placa ESP32 DevKit-C no tiene conectores de ese tipo, por lo que necesitaremos conectar directamente los 4 cables: alimentación, tierra, SCL y SDA.</p>
<p>De acuerdo a las <a href="https://www.silabs.com/documents/public/data-sheets/Si7021-A20.pdf">especificaciones del sensor Si7021</a>, el voltaje de entrada no debe superar los 3.6V. La placa de <em>Adafruit</em> proporcionada tiene un regulador de voltaje que nos permite conectar tanto 3.3V como 5V. </p>
<p>La sección de la <a href="https://www.silabs.com/documents/public/data-sheets/Si7021-A20.pdf">hoja de especificaciones del sensor Si7021</a> informa acerca del interfaz I2C que ofrece el sensor. Nos indica los 7 bits de dirección del sensor, así como de los comandos disponibles (la mayoría de ellos de 1 byte). </p>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<p>La dirección del sensor es <code>1000000</code>(es decir, <code>0x40</code> expresado en hexadecimal). Si queremos hacer una operación de lectura (bit R/W a 1), ¿cómo construiremos el segundo argumento de la llamada a <code>i2c_master_write_byte()</code> que haremos tras <code>i2c_master_start()</code>?</p>
</div>
<p>La sección 5.1.2 del documento explica cómo obtener una medida de temperatura tras haber realizado una medidad de humedad. Para ello usa el comando 0xE0. En nuestro caso deberemos usar 0xE3 o 0xF3.</p>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<ul>
<li>¿Cuál es la diferencia entre 0xE3 y 0xF3? ¿Qué es <em>clock stretching</em>?</li>
<li>Dichos comandos devuelven 2 bytes, que leeremos en dos variables diferentes. ¿Cómo obtenemos posteriormente nuestro número de 16 bits para calcular la temperatura?</li>
</ul>
</div>
<h2 id="ejercicios-obligatorios">Ejercicios obligatorios</h2>
<h3 id="uso-de-i2ctools">Uso de i2ctools</h3>
<p>Compila y prueba el ejemplo <em>i2c_tools</em> de la carpeta de ejemplos (<em>examples/peripherals/i2c/i2c_tools</em>). Conecta el sensor a los pines indicados por defecto (también a Vcc y a tierra) y ejecuta al comando <code>i2cdetect</code>. Prueba a los distintos comandos disponibles para tratar de leer información del sensor.</p>
<h3 id="lectura-de-temperatura">Lectura de temperatura</h3>
<p>Crea una aplicación que monitorice la temperatura cada segundo usando un <em>timer</em>. Modulariza el código de modo que la funcionalidad relativa al sensor, quede en los ficheros <code>si7021.c</code> y <code>si7021.h</code>.</p>
<h2 id="ejercicios-avanzados">Ejercicios avanzados</h2>
<h3 id="uso-de-crc-en-sensor">Uso de CRC en sensor</h3>
<p>El sensor Si7021 permite el cálculo de un byte de <em>checksum</em> (CRC) para comprobar que no ha habido errores en el envío. Completa tu código anterior para leer dicho byte y comprobar que no ha habido errores. Conviene leer la sección 5.1 y una <a href="https://barrgroup.com/tech-talks/checksums-and-crcs">librería para el cálculo de CRC como la ofrecida por BARR</a>.</p>
<h3 id="aplicacion-con-fsm">Aplicación con FSM</h3>
<p>Escribe una aplicación que:</p>
<ul>
<li>Muestree el sensor de efecto Hall cada segundo.</li>
<li>Muestree la temperatura cada 2 segundos.</li>
<li>Encienda/apague LEDs (del entrenador) en función de la temperatura medida.</li>
<li>Muestre por puerto serie las lecturas temperatura y del sensor de efecto Hall cada 5 segundos (se mostrará una media de las medidas tomadas)</li>
<li>Por cada grado se incremente la tempertura  desde la medida inicial, se encenderá un nuevo LED. Incialmente habrá uno encendido. Cuando se decremente, bajaremos.</li>
<li>Se emitirán eventos para informar del incremento/decremento de un grado centígrado en la medida.</li>
<li>Si el sensor de efecto Hall varía su lectura en más de un 20% respecto a la anterior, emitirá un evento que hará que entremos en un modo en el que no se leerá la temperatura hasta que el sensor de efecto Hall vuelva a sus valores <em>normales</em>. Los LEDs parpadearán mientras permanezcamos en este modo.</li>
</ul>
<p>Cada dispositivo (efecto Hall, LEDs, sensor SI7021) estará en un módulo (ficheros .c/.h) diferente (se valorará el uso de <em>componentes</em> deESP-IDF). 
El código se estructurará en torno a una máquina de estados (FSM), que puede ser extremademente sencilla. Puede recibir  como entrada  información temporal (por ejemplo, el paso de un segundo) así como los eventos de incremento/decremento de la temperatura y de variación del sensor efecto Hall (<em>pero NO es obligatorio seguir esa propuesta</em>). Se aconseja usar  <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/freertos.html#queue-api">colas de FreeRTOS</a> para proporcionar la entrada a la FSM (unas tareas  de  escribirán en la cola. La tarea del FSM leerá de la cola. Deberéis crear un tipo de datos para modelar lo que se introduce en la cola)</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
