<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 1 - Master IoT UCM - Prácticas RPI/LSI/ANIOT</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/LSI/ANIOT</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">LSI <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../LSI/Lab0/" class="dropdown-item">Laboratorio 0</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab1/" class="dropdown-item">Laboratorio 1</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab2/" class="dropdown-item">Laboratorio 2</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab3/" class="dropdown-item">Laboratorio 3</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab4/" class="dropdown-item">Laboratorio 4</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab5/" class="dropdown-item">Laboratorio 5</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-I <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-II <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_II/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6/" class="dropdown-item">Práctica 2 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6-II/" class="dropdown-item">Práctica 2 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P7/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P3/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P10/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P8/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P11/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">ANIOT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">Práctica 1</a>
</li>
                                    
<li>
    <a href="../P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../RPI-II/P11/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P2/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#practica-1-introduccion-al-entorno" class="nav-link">Práctica 1. Introducción al entorno</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#material-de-consulta" class="nav-link">Material de consulta</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#extension-esp-idf-para-vscode" class="nav-link">Extensión ESP-IDF para VSCode</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#configuracion-de-un-proyecto" class="nav-link">Configuración de un proyecto</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-1-introduccion-al-entorno">Práctica 1. Introducción al entorno</h1>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo de esta práctica es la introducción al entorno de desarrollo proporcionado por
Espressif para sus SoC de la familia ESP32, utilizando
la extensión de ESP-IDF existente en VSCode.</p>
<p>Aprovecharemos para ver varios aspectos del entorno ESP-IDF:</p>
<ul>
<li>Configuración del proyecto mediante menuconfig</li>
<li>Inclusión de parámetros de configuración mediante Kconfig</li>
<li>Presentación del mapa de memoria y uso del heap</li>
</ul>
<h2 id="material-de-consulta">Material de consulta</h2>
<p>Para ver los detalles de cada aspecto de esta práctica se recomienda la lectura de los siguientes
enlaces:</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/stable/get-started/index.html">Guía básica ESP-IDF</a>. Si queremos usar directamente las herramientas de Espressif, conviene conocer el flujo de trabajo básico en línea de comandos.</li>
<li><a href="https://github.com/espressif/vscode-esp-idf-extension">Extensión ESP-IDF para VSCode </a>. Documentación de la extensión de ESP-IDF para VSCode.</li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-reference/index.html">API de ESP-IDF</a></li>
<li><a href="https://github.com/torvalds/linux/blob/master/Documentation/kbuild/kconfig-language.rst">Kbuild</a>. Definición del lenguaje KConfig</li>
<li><a href="https://dl.espressif.com/dl/schematics/esp32_devkitc_v4-sch.pdf">Esquemáticos placa DevKitC-v4</a></li>
</ul>
<h2 id="extension-esp-idf-para-vscode">Extensión ESP-IDF para VSCode</h2>
<p>ESP-IDF es el entorno de desarrollo oficial de Espressif para las series de SoC ESP32, ESP32-S y ESP32-
C. Está basado en <a href="https://www.freertos.org/">FreeRTOS</a>, uno de los sistemas operativos
de tiempo real para microcontroladores más utilizado en la actualidad. En su <a href="https://docs.
espressif.com/projects/esp-idf/en/stable/esp32/get-started/index.html">get-started-guide</a> queda
descrito el proceso de instalación de las herramientas nativas en línea de comando.  En nuestro caso, utilizaremos 
la extensión oficial de Espressif de VSCode.</p>
<p>La primera parte de esta sesión consistirá en la instalación de dicha extensión y su configuración
para volcar un ejemplo en nuestra placa ESP32. La documentación proporcionada por
Espressif se encuentra en <a href="https://github.com/espressif/vscode-esp-idf-extension/blob/master/docs/tutorial/install.md">su repositorio de GitHub</a>.
A partir de ahí, es posible encontrar enlaces a diferentes tutoriales que explican
con detalle el proceso de instalación, configuración, desarrollo...</p>
<ul>
<li>
<p>En primer lugar, sigue los pasos indicados en su <a href="https://github.com/espressif/vscode-esp-idf-extension/blob/master/docs/tutorial/install.md">guía de instalación</a> para instalar
de la extensión en VSCode. <strong>Realiza este paso antes de venir al laboratorio</strong>, pues la instalación tardará varios minutos. Podéis saltar el paso 6 (OPCIONAL) y basta con elegir la opción <em>EXPRESS</em></p>
</li>
<li>
<p>A continuación, sigue los pasos del <a href="https://github.com/espressif/vscode-esp-idf-extension/blob/master/docs/tutorial/basic_use.md">ejemplo básico</a> para volcar en la placa el código del
ejemplo <em>Blink</em>. Recuerda esocger <em>esp32-ESP32 Chip (Via USB-Bridge)</em> como  <em>Device Target</em>. Por ahora, salta los pasos 5 y 6 (configuración) y procede directamente a la compilación y descarga en la placa.</p>
</li>
<li>
<p>El nombre asociado al puerto serie al que se conecta la placa dependerá del sistema
operativo usado. En Linux será algo similar  <em>/dev/ttyUSB0</em>. <strong>IMPORTANTE</strong>: usando la placa ESP32-Devkit-c (del maletín), debes usar UART como método de programar el dispositivo (y no JTAG como aparece por defecto).</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Cuestiones</p>
<ul>
<li>¿Qué versión es la actualmente estable de ESP-IDF?</li>
<li>¿Cuál es la salida estándar por defecto de nuestro proyecto?</li>
<li>¿En qué unidades debemos expresar el argumento de <code>vTaskDelay()</code>? Investiga</li>
</ul>
</div>
<p>la macro pdTICKS_TO_MS. ¿Cómo se reescribiría esa línea usando dicha
macro?</p>
<h2 id="configuracion-de-un-proyecto">Configuración de un proyecto</h2>
<p>ESP-IDF, en su porting de FreeRTOS, ofrece un mecanismo de configuración del proyecto,
que permite especificar qué servicios de ESP-IDF necesitaremos usar y establecer parámetros de
dichos servicios. Asimismo, permite definir nuestros propios parámetros de configuración mediante
el lenguaje [KConfig]https://github.com/torvalds/linux/blob/master/Documentation/kbuild/kconfig-language.rst).</p>
<p>Para realizar dicha configuración, debemos ejecutar el comando <code>menuconfig</code> de la paleta
de comandos proporcionadas por la extensión de ESP-IDF (paso 5 del tutorial usado en el paso anterior). En la nueva ventanda podremos activar/desactivar módulos del sistema operativo y configurar valores de dichos módulos.</p>
<p>Como se puede ver en la siguiente figura, el proyecto <em>Blink</em> incorpora algunas opciones propias: <em>BLINK LED Type</em>, <em>Blink GPIO number</em> y  <em>Blink period</em>.</p>
<p><img alt="pinout" src="img/menuconfig.png" /></p>
<p>Para que dichas opciones figuren en el menú de edición de configuraciones, se debe editar un fichero de texto <em>Kconfig.projbuild</em> presente en la carpeta principal ('main') del proyecto. Concretamente, el contenido del proyecto inicial es el siguiente:</p>
<pre><code class="language-bash">menu &quot;Example Configuration&quot;

    choice BLINK_LED
        prompt &quot;Blink LED type&quot;
        default BLINK_LED_GPIO if IDF_TARGET_ESP32
        default BLINK_LED_RMT
        help
            Defines the default peripheral for blink example

        config BLINK_LED_GPIO
            bool &quot;GPIO&quot;
        config BLINK_LED_RMT
            bool &quot;RMT - Addressable LED&quot;
    endchoice

    config BLINK_LED_RMT_CHANNEL
        depends on BLINK_LED_RMT
        int &quot;RMT Channel&quot;
        range 0 7
        default 0
        help
            Set the RMT peripheral channel.
            ESP32 RMT channel from 0 to 7
            ESP32-S2 RMT channel from 0 to 3
            ESP32-S3 RMT channel from 0 to 3
            ESP32-C3 RMT channel from 0 to 1

    config BLINK_GPIO
        int &quot;Blink GPIO number&quot;
        range 0 48
        default 8 if IDF_TARGET_ESP32C3 || IDF_TARGET_ESP32H2
        default 18 if IDF_TARGET_ESP32S2
        default 48 if IDF_TARGET_ESP32S3
        default 5
        help
            GPIO number (IOxx) to blink on and off or the RMT signal for the addressable LED.
            Some GPIOs are used for other purposes (flash connections, etc.) and cannot be used to blink.

    config BLINK_PERIOD
        int &quot;Blink period in ms&quot;
        range 10 3600000
        default 1000
        help
            Define the blinking period in milliseconds.

endmenu
</code></pre>
<p>El lenguaje <a href="https://github.com/torvalds/linux/blob/master/Documentation/kbuild/kconfig-language.rst">KConfig</a> es casi autoexplicativo, y resulta sencillo ver la correspondencia entre este contenido y el menú que se muestra en la figura anterior.</p>
<p>Al construir el proyecto, se procesará el fichero <code>Kconfig.projbuild</code> que dará lugar a una versión del fichero <code>sdkconfig</code> con los valores escogidos para cada opción. </p>
<pre><code class="language-bash">#
# Example Configuration
#
CONFIG_BLINK_LED_GPIO=y
# CONFIG_BLINK_LED_RMT is not set
CONFIG_BLINK_GPIO=5
CONFIG_BLINK_PERIOD=1000
# end of Example Configuration
</code></pre>
<p>Como se puede observar, el fichero <code>sdkconfig</code> recoge una serie de macros a las que podremos referirnos en nuestro código para actuar en función de sus valores. En el código de <em>blink</em> podemos encontrar ejemplos de ese uso:</p>
<pre><code class="language-c">#define BLINK_GPIO CONFIG_BLINK_GPIO

#ifdef CONFIG_BLINK_LED_RMT
  static led_strip_t *pStrip_a;
  static void blink_led(void)
   ...

#elif CONFIG_BLINK_LED_GPIO
    static void blink_led(void)
    ...
#endif

void app_main(void)
{

    /* Configure the peripheral according to the LED type */
    configure_led();

    while (1) {
        ESP_LOGI(TAG, &quot;Turning the LED %s!&quot;, s_led_state == true ? &quot;ON&quot; : &quot;OFF&quot;);
        blink_led();
        /* Toggle the LED state */
        s_led_state = !s_led_state;
        vTaskDelay(CONFIG_BLINK_PERIOD / portTICK_PERIOD_MS);
    }
}
</code></pre>
<div class="admonition note">
<p class="admonition-title">Cuestiones</p>
<ul>
<li>¿Por qué no parpadea el LED de la placa? ¿Dónde está conectado ese LED? (compruébalo en <a href="https://dl.espressif.com/dl/schematics/esp32_devkitc_v4-sch.pdf">los esquemáticos placa DevKitC-v4</a>)</li>
<li>Cambia la frecuencia de parpadeo usando <code>menuconfig</code>. Compila de nuevo y comprueba que el cambio ha surtido efecto</li>
<li>Conecta la placa con el ESP32 a un LED del entrenador del laboratorio. ¿Puedes usar cualquier pin de la placa? </li>
</ul>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
