<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://iot-da.github.io/ANIOT/P7/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 7. Over-The-Air Updates (OTA) - Internet of Things and Data Analytics</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Internet of Things and Data Analytics</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../General/index.md" class="nav-link">General info.</a>
                            </li>
                            <li class="navitem">
                                <a href="../../News/index.md" class="nav-link">News</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Subjects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../Subjects/IOTNA/index.md" class="dropdown-item">IOTNA</a>
</li>
                                    
<li>
    <a href="../../Subjects/MDM/index.md" class="dropdown-item">MDM</a>
</li>
                                    
<li>
    <a href="../../Subjects/SID/index.md" class="dropdown-item">SID</a>
</li>
                                    
<li>
    <a href="../../Subjects/IA/index.md" class="dropdown-item">IA</a>
</li>
                                    
<li>
    <a href="../../Subjects/NP1/index.md" class="dropdown-item">NP1</a>
</li>
                                    
<li>
    <a href="../../Subjects/NP2/index.md" class="dropdown-item">NP2</a>
</li>
                                    
<li>
    <a href="../../Subjects/SEC/index.md" class="dropdown-item">SEC</a>
</li>
                                    
<li>
    <a href="../../Subjects/EDGE/index.md" class="dropdown-item">EDGE</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../Contact/index.md" class="nav-link">Contact</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-light">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#practica-7-over-the-air-updates-ota" class="nav-link">Práctica 7. Over-The-Air Updates (OTA)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#material-de-consulta" class="nav-link">Material de consulta</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#over-the-air-update-ota" class="nav-link">Over-The-Air Update (OTA)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ota-rollback" class="nav-link">OTA rollback</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#seguridad" class="nav-link">Seguridad</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ejercicios-basicos" class="nav-link">Ejercicios básicos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ejercicio-avanzado" class="nav-link">Ejercicio avanzado</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-7-over-the-air-updates-ota">Práctica 7. Over-The-Air Updates (OTA)</h1>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo de esta práctica es familiarizarse con el concepto de OTA, la actualización del <em>firmware</em> de forma remota. Específicamente, usaremos el interfaz simplificado que ofrece ESP-IDF para realizar la actualización de aplicaciones.</p>
<p>Trabajaremos los siguientes aspectos:</p>
<ul>
<li>Actualización de <em>firmware</em> mendiante HTTPS.</li>
<li>Incorporación de certificados en nuestra aplicación.</li>
<li>Firmado de binarios.</li>
</ul>
<h2 id="material-de-consulta">Material de consulta</h2>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/ota.html">Documentación sobre el mecanismo de OTA</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/security/secure-boot-v2.html">Documentación sobre el proceso de arranque segurlo</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/partition-tables.html">Documentación sobre la tabla de particiones de ESP-IDF</a></li>
<li><a href="https://github.com/espressif/esp-idf/tree/master/examples/system/ota">Ejemplos de OTA proporicionados por ESP-IDF</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/build-system.html#embedding-binary-data">Documentación sobre cómo incluir datos binarios/texto en la app</a></li>
<li><a href="https://medium.com/talpor/ssl-tls-authentication-explained-86f00064280">Tutorial básico sobre TLS</a> </li>
</ul>
<h2 id="over-the-air-update-ota">Over-The-Air Update (OTA)</h2>
<p><em>OTA</em> es el nombre que suele dar al proceso de actualización de <em>firmware</em> de forma remota, independientemente del mecanismo de comunicación utilizado (WiFi, Bluetooth, Ethernet...).
Dicho proceso implica la recepción de una nueva imagen, su escritura y comprobación en un dispositivo de almacenamiento (no volátil), y el posterior arranque a partor de la nueva imagen.</p>
<p>En un despliegue IoT, la funcionalidad OTA es imprescindible. Debe contemplarse desde el inicio en el diseño de la aplicación, porque su buen funcionamiento es crítico.</p>
<h3 id="particiones-y-tabla-de-particiones">Particiones y tabla de particiones</h3>
<p>Habitualmente, la imagen que se recibe vía red se almanceará en una <strong>partición</strong> diferente a la que se esté actualizando para ejecutar en el dispositivo. Una partición es una región de un dispositivo de almacenamiento que se gestiona de forma independiente. Se puede ver como un dispositivo virtual en sí mismo.</p>
<p>La <em>tabla de particiones</em> es la estructura que almacena la división del dispositivo de almacenamiento en particiones. La tabla indica el tamaño, tipo y ubicación de cada una. Se suele almacenar en una posición fija del propio dispositivo y ser de tamaño fijo.</p>
<p>En el caso concreto del ESP32 utilizado, la tabla de particiones se almacena en la <em>flash</em> (único dispositivo de almacenamiento presente), en el desplazamiento 0x8000 (32KiB más allá del comienzo de la <em>flash</em>). Tiene un tamaño de 3072 bytes, más un <em>checksum</em> MD5 almacenado tras la tabla para garantizar la integridad. Por tanto, se asigna un sector de <em>flash</em> (4KiB) para almacenar la tabla.</p>
<p>Por defecto, el contenido de la tabla en ESP32 es:</p>
<pre><code class="language-c"># ESP-IDF Partition Table
# Name,   Type, SubType, Offset,  Size, Flags
nvs,      data, nvs,     0x9000,  0x6000,
phy_init, data, phy,     0xf000,  0x1000,
factory,  app,  factory, 0x10000, 1M,
</code></pre>
<p>Como se puede observar, justo tras la propia tabla (recordemos, en el desplazamiento <em>0x8000</em> y de tamaño un sector), se encuentra una partición de tipo <em>nvs</em> (<em>Non-Volatile Storage</em> API) cuyo cometido se observó en prácticas anteriores (almacenamiento de pares clave-valor). Esta partición, de 6 sectores (24KiB) por defecto, almacena infomración de la interfaz WiFi (entre otras) si se utiliza <em>WIFI_STORAGE_FLASH</em> como argumento de <em>esp_wifi_set_storage()</em> (y así es por defecto). Se recomienda que el mínimo de esta partición sea de 3 sectores, y que se haga mayor de 6 si se prevé almacenar mucha información propia de la aplicación.</p>
<p>La partición <em>phy_init</em> almacena datos de configuración para la inicialización del interfaz PHY. Por defecto, esta partición no se utiliza y los datos de inicialización del PHY se compilan en el propio binario de la aplicación. Si queremos que se cargue la configuración PHY desde esta partición (para, por ejemplo, particularizar el calibrado por dispositivo) debemos habilitar <code>CONFIG_ESP_PHY_INIT_DATA_IN_PARTITION</code> en <em>menuconfig</em> y volcar explícitamente la partición, ya que no se hace por defecto.</p>
<p>Finalmente, la partición <em>factory</em> de tipo <em>app</em> y subtipo <em>factory</em> es la partición donde escribiremos nuestro código (fichero <code>.bin</code> generado a partir del <code>.elf</code>) cuando volquemos el proyecto en la placa (<code>idf.py flash -p &lt;port&gt;</code>).</p>
<h3 id="particiones-para-ota">Particiones para OTA</h3>
<p>En ESP-IDF, si nuestro proyecto quiere incorporar la posibilidad de actualizarse de forma remota, debemos preverlo desde el comienzo, pues son necesarias varias particiones específicas:</p>
<pre><code class="language-c"># Name,   Type, SubType,  Offset,   Size,  Flags
nvs,      data, nvs,      0x9000,  0x4000
otadata,  data, ota,      0xd000,  0x2000
phy_init, data, phy,      0xf000,  0x1000
factory,  app,  factory,  0x10000,  1M
ota_0,    app,  ota_0,    ,         1M
ota_1,    app,  ota_1,    ,         1M
nvs_key,  data, nvs_keys, ,        0x1000
</code></pre>
<p>Comparando con la tabla anterior, vemos dos tipo de particiones nuevas:</p>
<ul>
<li><em>otadata</em> de tipo <em>ota</em>. Ocupa dos sectores y mantiene la información sobre las particiones <em>ota_<n></em> existentes y su estado. Inicialmente, se debe inicializar a 0xFF (todo <em>unos</em>) para indicar que el arranque se debe hacer desde la partición <em>factory</em></li>
<li><em>ota_0</em> y <em>ota_1</em>. Son dos particiones similares a <em>factory</em>, que almacenarán futuras imágenes recibidas por un interfaz de red. ESP-IDF exige que al menos tengamos dos de estas particiones, pero podemos incluir más.</li>
</ul>
<h2 id="ota-rollback">OTA <em>rollback</em></h2>
<p>ESP-IDF incluye la posibilidad de hacer <em>rollback</em> tras recibir una nueva imagen. La secuencia de estados por los que pasa una partición es la siguiente:</p>
<p><img alt="estados OTA" src="img/estadosOTA.png" /></p>
<p>Un posible código para usar esta funcionalidad sería:</p>
<pre><code class="language-c">void app_main(void) {
...
const esp_partition_t *running = esp_ota_get_running_partition();
esp_ota_img_states_t ota_state;

if (esp_ota_get_state_partition(running, &amp;ota_state) == ESP_OK) {
  if (ota_state == ESP_OTA_IMG_PENDING_VERIFY) {
   // run diagnostic function ...   
   bool diagnostic_is_ok = diagnostic();
   if (diagnostic_is_ok) {
     ESP_LOGI(TAG, &quot;Diagnostics completed successfully! Continuing execution ...&quot;);
     esp_ota_mark_app_valid_cancel_rollback();
   } else {
    ESP_LOGE(TAG, &quot;Diagnostics failed! Start rollback to the previous version ...&quot;);
    esp_ota_mark_app_invalid_rollback_and_reboot();
   }
  }
}
</code></pre>
<p>Como se puede comprobar en la figura y en el código, en un arranque que se produce tras escribir una nueva imagen en <em>flash</em> deberíamos seguir los siguientes pasos:</p>
<ul>
<li>Conseguir el manejador de la partición activa (la que está ejecutando la imagen actualemnte) mediante <code>esp_ota_get_running_partition()</code></li>
<li>Conseguir el estado de dicha partición con <code>esp_ota_get_state_partition()</code></li>
<li>Realizar un diagnóstico para determinar si esta nueva imagen funciona adecuadamente (llamada a <code>diagnostic()</code> en el código de ejemplo). Esta función la debemos desarrollar nosotros mismos, no forma parte de ESP-IDF porque es específica de nuestra aplicación. También es importante resaltar que no es una comprobación de la integridad de la imagen o un proceso de autenticación. La integridad se comprueba tras el envío. Para la autenticación (garantizar que el remitente es quien debe ser) podemos obligar a que la imagen venga firmada. ESP-IDF sí ofrece funcionalidad para esta comprobación.</li>
<li>Si la funcionalidad de la nueva imagen es correcta, llamaremos a <code>esp_ota_mark_app_valid_cancel_rollback()</code> y el estado de esa partición pasará a <code>ESP_OTA_IMG_VALID</code>. Los arranques posteriores (tras <em>reset</em>) seguirán siendo desde esta partición.</li>
<li>Si la funcionalidad de la nueva imagen no es correcta, llamaremos a  <code>esp_ota_mark_app_invalid_rollback_and_reboot()</code> y el estado de esa partición pasará a <code>ESP_OTA_IMG_INVALID</code>. No se volerá a tratar de arrancar esta imange, y se volverá a marcar como activa la partición OTA que estuviéramos usando antes de iniciar el proceso de actualización.</li>
</ul>
<h2 id="seguridad">Seguridad</h2>
<p>Hay varios aspectos que debemos considerar en la seguridad de la operación OTA:</p>
<ul>
<li>El servidor del que descargamos la nueva imagen es de confianza (<em>autenticación</em>). Usar HTTPS es una opción segura, almacenando el certificado público de dicho servidor (o una cadena de certificados de confianza) en el nodo. <ul>
<li>Algunos dispositivos disponen de hardware específico para almacenar este tipo de secretos <em>compartidos</em> (claves públicas; también claves privadas en ocasiones), pero no es el caso de nuestro ESP32.</li>
<li>Al usar HTTPS, se usará el protocolo TLS para garantizar la  autenticación, integridad y confidencialidad de  las comunicaciones. Para ello, debemos usar certificados TLS: una clave pública con cierta información incorporada. Este certificiado puede ser autofirmado, como haremos en esta práctica, o podemos tener que usar una entidad certificadora (CA - Certification Authority).</li>
<li>Revisad las <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/build-system.html#embedding-binary-data">opciones de compilación para saber cómo podemos incrustar el certificado en nuestro binario</a></li>
</ul>
</li>
<li>La imagen recibida es de confianza. Parte de este aspecto queda cubierto por la garantía de <em>integridad</em> de TLS, pero podemos ir un paso más allá: podemos requerir que la imagen recibida esté firmada. Nuevamente, exigirá la generación de un par de claves para la firma del binario (con la clave privada) y su comprobación (con la clave pública). Puedes <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/security/secure-boot-v2.html#signed-app-verification-without-hardware-secure-boot">leer acerca de este proceso en la documentación de ESP-IDF</a></li>
</ul>
<p><strong>IMPORTANTE</strong>  NO habilitéis nunca el arranque seguro (Secure Boot) en <em>menuconfig</em>. Una vez activado, no podemos desactivarlo, y supondría un problema para el hardware del laboratorio. Es posible habilitar únicamente la verficación de la APP sin el arranque segruo completo.</p>
<h2 id="ejercicios-basicos">Ejercicios básicos</h2>
<p>Vamos a partir  <a href="https://github.com/espressif/esp-idf/tree/master/examples/system/ota/simple_ota_example">del ejemplo de OTA básico</a>. Estudia el código, y responde a las siguientes preguntas:</p>
<div class="admonition note">
<p class="admonition-title">Cuestión</p>
<ul>
<li>¿Qué entradas tiene la tabla de particiones usada?</li>
<li>¿Cómo se llama el fichero de certificado que se incluirá en el binario?</li>
<li>¿Cómo y dónde se indica que se debe incluir el certificado?</li>
<li>¿Qué es el símbolo <em>server_cert_pem_start</em>?</li>
</ul>
</div>
<div class="admonition danger">
<p class="admonition-title">Tareas</p>
<ul>
<li>Hacer funcionar el ejemplo conectando a un servidor que estará ejecutando en el equipo del profesor. Se usará <a href="file/ca_cert.pem">este certificado para la conexión segura por HTTP</a> y la red WiFi creada en el laboratorio. Se proporcionaraán los credenciales de la WiFi y la IP del servidor durante el laboratorio.</li>
<li>Alterar un byte del fichero del certificado y probar nuevamente.</li>
<li>[Seguir los pasos del ejemplo]((https://github.com/espressif/esp-idf/tree/master/examples/system/ota) para crear vuestro propio servidor HTTPS y certificado y probad de nuevo.</li>
</ul>
</div>
<h2 id="ejercicio-avanzado">Ejercicio avanzado</h2>
<p>Integraremos OTA en la aplicación que hemos ido desarrollando a lo largo de estas prácticas (lectura periódica del sensor de temperatura).</p>
<div class="admonition danger">
<p class="admonition-title">Tareas</p>
<p>La aplicación inicial corresponderá con una aplicación similar a la de prácticas anteriores: una lectura periódica del sensor de temperatura. Se añadirá la siguiente funcionalidad: </p>
<ul>
<li>Cuando se reciba un evento externo (la pulsación de un botón o la lectura del sensor de infrarrojos de una distancia menor que un umbral), la aplicación se conectará al servidor HTTPS predefinido y se bajará la nueva imagen (si se usa MQTT, la URL del servidor y el nombre de la nueva imagen se pueden comunicar en el mensaje; pero el certificado debería estar preinstalado). </li>
<li>Se desarrollará una función de auto-diagnóstico (<em>self-test</em>) que permita decidir si la nueva imagen se comporta de forma correcta.</li>
<li>Se utilizará la opción de <em>rollback</em> para indicar si la nueva imagen se elige para futuros arranques o se marca como inválida.</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Para investigar...</p>
<p>HTTPS (SSL/TLS) no exige tener pre-almacenado el certificado de cada servidor al que nos queramos conectar. Es el propio servidor el que envía el certificado, firmado con la clave privada de una <em>autoridad certificador</em> (<em>CA</em>) que sí debemos conocer. Es un papel similar al de un notario, que valida el certificado de un servidor para que podamos confiar en su identidad.</p>
<p><strong>Investiga</strong> qué ofrece ESP-IDF para configurar así nuestro sistema, de modo que no tengamos que cargar el certificado de un servidor concreto, sino el de una CA (o una cadena de CAs). Enlaces recomendados para empezar:</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/esp_crt_bundle.html">ESP x509 Certififcate Budle</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/esp_tls.html">ESP-TLS</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/mbedtls.html">Mbed TLS</a></li>
</ul>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
