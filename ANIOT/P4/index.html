<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 4 - Master IoT UCM - Prácticas RPI</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-I <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-II <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-II/P1/index.md" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6/" class="dropdown-item">Práctica 2 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6-II/" class="dropdown-item">Práctica 2 (II)</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">ANIOT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P3/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P5/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#practica-4-entradasalida-uso-de-adc" class="nav-link">Práctica 4. Entrada/Salida. Uso de ADC.</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#material-de-consulta" class="nav-link">Material de consulta</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#conversor-analogico-digital-adc" class="nav-link">Conversor Analógico-Digital (ADC)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ejercicios-obligatorios" class="nav-link">Ejercicios obligatorios</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ejercicio-avanzado" class="nav-link">Ejercicio avanzado</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-4-entradasalida-uso-de-adc">Práctica 4. Entrada/Salida. Uso de ADC.</h1>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo  de esta práctica es continuar conociendo los mecanismos de entrada/salida ofrecidos
por ESP-IDF para interaccionar con dispositivos usando ESP32.</p>
<p>Trabajaremos los siguientes aspectos del API de ESP-IDF:</p>
<ul>
<li>Uso de un conversor analógico-digital (ADC).</li>
<li>Uso de un sensor de infrarrojos para medir distancias.</li>
</ul>
<h2 id="material-de-consulta">Material de consulta</h2>
<p>Para ver los detalles de cada aspecto de esta práctica se recomienda la lectura de los siguientes enlaces:</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/stable/api-reference/peripherals/adc.html"> Documentación del API de ESP-IDF para los 2 ADCs disponibles</a>.  </li>
<li>La hoja de especificaciones del sensor de infrarrojos SHARP GP2Y0A41SK, disponible en el Campus Virtual</li>
<li><a href="https://wiki.analog.com/university/courses/electronics/text/chapter-20">Más información sobre la operación de una ADC</a></li>
</ul>
<h2 id="conversor-analogico-digital-adc">Conversor Analógico-Digital (ADC)</h2>
<p>Un sensor permite <em>capturar</em> magnitudes físicas (temperatura, presión, distancia, intensidad lumínica...)  y transformarlas en una señal eléctrica analógica mediante un transductor.
Un conversor analógico-digital (ADC) muestrea esas señales analógicas y las transforma en una señal digital, que podemos procesar en nuestra CPU.</p>
<p>Un ADC muestrea periódicamente una señal analógica y asigna un valor digital a cada muestra (<em>sampling</em> y <em>quantization</em>). El valor se obtiene al dividir el valor del voltaje de entrada muestreado por un voltaje de referencia  y multiplicándolo por el número de niveles digitales. El valor resultante  se representa como un entero, en un formato adecuado para su almacenamiento en memoria y su uso por parte de nuestro procesador. </p>
<p>La <strong>resolución</strong> de un ADC indica cuántos bits tiene la salida (es decir, cuántos bits emplea para codificar cada muestra que toma de la señala de entrada analógica) La siguiente figura muestra un ejemplo de la cuantización de una señal analógica (en gris) y su transformación a una serie de valores, cada uno de ellos codificados usando 3 bits.</p>
<p><img alt="cuantiza" src="img/cuantiza-3bits.png" /></p>
<p>Otro factor relevante a la hora de escoger un ADC es su <em>frecuencia de muestreo</em>. De acuerdo al <em>Teorema del muestreo</em> para que la señal muestreada <em>x(nT)</em> represente fielmente la señal analógica <em>x(t)</em>:
* <em>x(t)</em> debe ser una señal limitada en banda de ancho de banda <em>fN</em>.
* La frecuencia de muestreo <em>fs</em> debe ser al menos el doble de la máxima frecuencia de la señal analógica <em>x(t)</em>.</p>
<p>### ADCs en nuestro ESP32
 El ESP32 dispone de 2 ADCs tipo SAR (<em>Succesive Aproximation-Register</em>) de 12 bit (es configurable entre 9 y 12 bits). El voltaje de referencia es 1100mV, por lo que deberíamos adaptar la señal de entrada a ese rango para obtener la mayor precisión. </p>
<p>Hay 2 ADCs disponibles que ofrecen un total de 18 canales: 8 en el <em>ADC1</em> (GPIO32 - GPIO39) y 10 más  en el <em>ADC2</em> (GPIO0, GPIO2, GPIO4, GPIO12 - GPIO15, GOIO25 - GPIO27. <strong>Es mejor evitar el uso de GPIO2, GPIO2 y GPIO15</strong> como canal de ADC. <a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-reference/peripherals/adc.html">Consultad la documentación para más detalles</a>). Es decir, podríamos muestrear hasta 18 señales analógicas diferentes, conectando cada una a un pin GPIO diferente. Es importante recordar que no podemos usar un mismo GPIO para varios propósitos simultáneamente (por ejemplo, como entrada digital y como ADC).</p>
<div class="admonition note">
<p class="admonition-title">ADC2 y WiFI</p>
<p>Recuerda que la radio WiFi usa el  ADC2. Por tanto, tu aplicación no debe usar ningún canal del ADC2 si está utilizando la radio WiFi.</p>
</div>
<h4 id="voltaje-de-referencia-atenuacion">Voltaje de referencia: atenuación</h4>
<p>Aunque el voltaje de referencia indicado por Espressif es de 1100mV, cada placa sufrirá pequeñas variaciones durante su fabricación, que moverán ligeramente dicha referencia. Para solventarlo, las placas se someten a una calibración tras su fabricación. Todos nuestros SoCs están calibrados y su referencia real está presenta en memoria no volátil (eFuse).</p>
<p>El ESP32 permite atenuar  la señal de entrada para adaptarla al rango de referencia (aunque siempre resulta aconsejable hacerlo con un circuito externo si es posible). </p>
<table>
<thead>
<tr>
<th>Atenuación</th>
<th>Rango medible en la entrada </th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ADC_ATTEN_DB_0</code></td>
<td>100 mV ~ 950 mV</td>
</tr>
<tr>
<td><code>ADC_ATTEN_DB_2_5</code></td>
<td>100 mV ~ 1250 mV</td>
</tr>
<tr>
<td><code>ADC_ATTEN_DB_6</code></td>
<td>150 mV ~ 1750 mV</td>
</tr>
<tr>
<td> <code>ADC_ATTEN_DB_11</code></td>
<td>150 mV ~ 2450 mV</td>
</tr>
</tbody>
</table>
<h4 id="lectura-de-la-salida-del-adc">Lectura de la salida del ADC</h4>
<p>Podemos leer directamente la salida del ADC (entero de 12 bits, por defecto) con la llamada <code>adc1_get_raw()</code> (<code>adc1_get_raw()</code> para el ADC2). </p>
<p>Para calcular el valor del voltaje de entrada a partir de la lectura proporcionada por el ADC podemos hacer el siguiente cálculo:</p>
<pre><code class="language-c">Vout = Dout * Vmax / Dmax 
</code></pre>
<p>donde <em>Vout</em> es el valor del voltaje a la entrada (en V), <em>Dout</em> es la lectura obtenida del ADC (entero de 12 bits), <em>Vmax</em> es el valor máximo medible a la entrada (dependerá de la atenuación) y <em>Dmax</em> es el valor máximo de la salida del ADC, que es 4095 si usamos 12 bits.</p>
<p>Podemos evitar hacer nosotros los cálculos llamando a  <code>esp_adc_cal_raw_to_voltage()</code>, que devuelve el valor del voltaje medido (en mV) aplicando los factores de calibración específicos para el ADC de nuestro ESP32.</p>
<h4 id="configuracion-adc">Configuración ADC</h4>
<p>Es necesario configurar el ADC antes de comenzar a hacer lecturas:
* Para el ADC1, es necesario configurar la precisión y la atenuación llamando a las funciones  <code>adc1_config_width()</code>  y <code>adc1_config_channel_atten()</code>, respectivamente.
* Para el ADC2, es necesario configurar la atenuación llamando a <code>adc2_config_channel_atten()</code>. La precisión se indicará en cada lectura.</p>
<p>La configuración de la atenuación se realiza de forma independiente para cada canal. 
Puedes consultar [ejemplos de uso del ADC en los ejemplos de ESP-IDF(https://github.com/espressif/esp-idf/tree/v4.4.2/examples/peripherals/adc/single_read).</p>
<div class="admonition note">
<p class="admonition-title">Sensor Hall</p>
<p>El sensor de efecto Hall usado con anterioridad, aunque interno al ESP32, usa 2 canales del ADC1, los canales 0 y 3. Por tanto, si se usa dicho sensor, no debe usarse el GPIO 36 ni el  GPIO 39.</p>
</div>
<h4 id="toma-de-medidas-con-adc">Toma de medidas con ADC</h4>
<p>El ADC es un elemento muy susceptible al ruido, especialmente si el ADC no es de buena calidad (y el del ESP32, no lo es). Por ello, <a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-reference/peripherals/adc.html">la documentación de ESP-IDF</a> propone colocar un condesador de <em>bypass</em> a la entrada del pin y realizar un muestreo múltiple en el momento de tomar una medida. Nótese que ambas soluciones disminuyen significativamente las frecuencias máximas que podremos medir; para nuestros objetivos (medir temperatura, humedad ambiente...), no suponen mayor problema.</p>
<p>El <em>muestreo múltiple</em> consiste simplemente en tomar más de una medida del ADC y realizar la media, en lugar de tomar una única medida. Como se puede ver en la siguiente figura, extraída de  <a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/api-reference/peripherals/adc.html">la documentación de ESP-IDF</a>, realizar una múltiples lecturas del ADC para cada muestra proporciona valores mucho más estables:</p>
<p><img alt="NoiseADC" src="img/adc-noise-graph.jpg" /></p>
<p>En <a href="https://deepbluembedded.com/esp32-adc-tutorial-read-analog-voltage-arduino/">este enlace podéis leer un buen tutorial sobre el uso del ADC</a>. Incluye sugerencias para acondicionar la señal y ejemplos de calibrado, aunque usa el entorno de Arduino, y no ESP-IDF.</p>
<h3 id="lectura-del-sensor-de-infrarrojos">Lectura del sensor de infrarrojos</h3>
<p>El sensor GP2Y0A41SK0F de Sharp permite medir distancias de entre 4 y 30cm usando infrarrojos. Combina un PSD (<em>Position Sensitive Detector</em>) y IR-LED (<em>infrared
emitting diode</em>) de manera que puede emitir luz infrarroja y determinar cuándo ha vuelto al sensor tras reflejarse en un obstáculo cercano. Ese tiempo de vuelo se utiliza para determinar la distancia al objeto.</p>
<p>De acuerdo a la hoja de especificaciones que se puede encontrar en el Campus Virtual, este sensor proporciona una tensión en función de la distancia al obejto más cercano. La siguiente figura muestra esa relación (figura extraída de la hoja de especificaciones del sensor):</p>
<p><img alt="distToVolt" src="img/Sharp-curve.png" /></p>
<p>Dicha curva nos indica que, para una distancia de 8cm debemos esperar un voltaje de salida de aprox. 1.58V. Para 22cm, veremos 0.6V en la salida del sensor.  Es importante observar que, para distancias inferiores a 4cm, los valores obtenidos en la salida no nos permiten discriminar la distancia de forma correcta.</p>
<p>Por tanto, bastará con conectar la salida del sensor (cable amarillo) a un canal ADC de nuestro ESP32 y medir el voltaje que saca el sensor (ojo: no el valor <em>raw</em> del ADC, sino el valor de voltaje que ofrece el sensor). </p>
<div class="admonition note">
<p class="admonition-title">Voltaje a distancia</p>
<p>Una vez conseguido el voltaje que está devolviendo el sensor, ¿qué expresión usarás en el código para obtener la distancia en centímetros?</p>
</div>
<p>En la página 3 de la hoja de especificaciones del GP2Y0A41SK0F se nos indica que Vcc = 4.5 - 5.5 V. Por tanto, debemos alimentar el sensor con 5V (cable rojo del sensor al pin de 5V; cable negro a pin de tierra). De acuerdo a la figura anterior (en página 4 de la hoja de especificaciones), el voltaje de salida del sensor es siempre inferior a 3.3V por lo que en principio no debería ser un problema conectar directamente dicha salida (cable amarillo) a un pin GPIO del ESP32</p>
<div class="admonition danger">
<p class="admonition-title">Voltaje de entrada en ESP32</p>
<p>El ESP32 funciona a 3.3V, lo que significa que nunca deberíamos presentarle un voltaje mayor de 3.3V en ningún pin (configurado como entrada o como ADC). Espressif no especifica claramente si dispone de circuito de protección en todos los pines, por lo que debemos obrar con cautela. En este ejercicio, conectaremos directamente el sensor de ifnrarrojos a un pin, pero de acuerdo a la hoja de especificaciones (página 3, primera tabla), el voltaje de salida podría ser de Vcc (5V en nuestro caso), potencialmente dañando el ESP32. Dicha salida se dará en situaciones extarordinarias de reflexión, y no deberían producirse en nuestras pruebas (usaremos un folio en blanco). Pero, para mayor robustez y seguridad, convendría adaptar la señal con un divisor de tensión o un op-amp.</p>
</div>
<h2 id="ejercicios-obligatorios">Ejercicios obligatorios</h2>
<h3 id="lectura-de-fuente-de-tension-variable">Lectura de fuente de tensión variable</h3>
<h3 id="lectura-de-distancias">Lectura de distancias</h3>
<h2 id="ejercicio-avanzado">Ejercicio avanzado</h2>
<p>Aplicación que:</p>
<ul>
<li>Muestree la distancia cada 2 segundos </li>
<li>Muestree el sensor de efecto Hall cada segundo </li>
<li>Enciende/apaga LED con una frecuencia variable (o mostrar en binario la distancia?5 bits)</li>
<li>Compruebe si se pulsa un botón. Si es así, cambia la frecuencia de parpadeo del LED (2s, 1s, 0.5s)</li>
<li>Se muestra por puerto serie las lecturas de distancia y Hall y los cambios en frecuencia de parpadeo</li>
<li>Cada dispositivo, tendrá su propio fichero con un interfaz definido para su uso.</li>
</ul>
<p>Sin llegar a implementarlas todas, proponed varias alternativas de diseño: usando un único <em>timer</em> para todos, usando un <em>timer</em> para cada muestreo/LED... </p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
