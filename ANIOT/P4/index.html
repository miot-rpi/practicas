<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 4 - Master IoT UCM - Prácticas RPI/ANIOT/LSI (25/26)</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/ANIOT/LSI (25/26)</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-I</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">LAB1. Introducción al entorno de desarrollo ESP-IDF</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">LAB2. WiFi en el ESP32</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">LAB3. WiFi: provisionamiento y ahorro de energía</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">LAB4. ESP WiFi Mesh</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">LAB5. BLE: servidor GATT</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">LAB6. BLE: cliente GATT</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">LAB7. BLE Mesh</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P8/" class="dropdown-item">LAB8. 802.15.4 y Thread</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P9/" class="dropdown-item">LAB9. 6LoWPAN y simulador Cooja</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P10/" class="dropdown-item">LAB10. LoRa y LoRaWan</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-II</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_III/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P4/" class="dropdown-item">Práctica 4 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P4_II/" class="dropdown-item">Práctica 4 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">ANIOT</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../P1b/" class="dropdown-item">Práctica 1b</a>
</li>
                                    
<li>
    <a href="../P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../P7/index2/" class="dropdown-item">Práctica 7 (adicional)</a>
</li>
                                    
<li>
    <a href="../P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">LSI</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../LSI/Lab0/" class="dropdown-item">Práctica 0</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab6/" class="dropdown-item">Práctica 6</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P3/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P5/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#practica-4-bus-i2c-sensor-de-temperatura" class="nav-link">Práctica 4. Bus I2C. Sensor de temperatura</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#material-de-consulta" class="nav-link">Material de consulta</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#bus-i2c" class="nav-link">Bus I2C</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#nueva-interfaz-i2c-en-esp-idf" class="nav-link">Nueva interfaz I2C en ESP-IDF</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#interfaz-i2c-en-esp-idf-antiguo-driver" class="nav-link">Interfaz I2C en ESP-IDF (antiguo driver)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#sensor-si7021" class="nav-link">Sensor Si7021</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#ejercicios-obligatorios" class="nav-link">Ejercicios obligatorios</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#ejercicios-opcionales" class="nav-link">Ejercicios opcionales</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-4-bus-i2c-sensor-de-temperatura">Práctica 4. Bus I2C. Sensor de temperatura</h1>
<h2 id="objetivos">Objetivos</h2>
<p>El objetivo de esta práctica es conocer el funcionamiento del bus I2C y la interfaz que ofrece ESP-IDF para su uso.
Trabajaremos los siguientes aspectos del API de ESP-IDF: 
* Configuración y uso del controlador I2C.
* Uso de sensor de temperatura y humedad (Si7021).
* Uso del sensor ICM-42670-P (IMU)</p>
<h2 id="material-de-consulta">Material de consulta</h2>
<p>Para ver los detalles de cada aspecto de esta práctica se recomienda la lectura de los siguientes enlaces:</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/peripherals/i2c.html">Documentación del API de I2C</a></li>
<li><a href="https://www.i2c-bus.org/">Recurso online sobre I2C</a></li>
<li><a href="https://www.silabs.com/documents/public/data-sheets/Si7021-A20.pdf">Hoja de especificaciones del sensor Si7021</a></li>
</ul>
<h2 id="bus-i2c">Bus I2C</h2>
<p>Fue desarrollado en la empresa <strong>Philips</strong> (ahora <strong>NXP</strong>) en la década de los 80 con el objetivo de  comunicar circuitos integrados con número mínimo de pines. El nombre I2C viene de <em>Inter IC</em>. Se usa tanto la abreviatura I2C como IIC. En 2014, <em>NXP</em> publicó la Rev. 6 del protocolo.</p>
<p>Proporciona una conexión <em>serie síncrona unidireccional</em> (no permite envíos en dos direcciones de forma simultanea). La velocida máxima de comunicación era originalmente de 100 kbit/s, y muchas aplicaciones no requieren de velocidades mayores. Existe un <em>fast mode</em> a 400kbits/s, <em>fast mode plus</em>  (1Mbits/s), ambos compatibles hacia atrás y sin lógica adicional (aunque puede suponer ajustes en las resistencias de <em>pull-up</em> para controlar las corrientes requeridas).  La especificación  <em>high speed mode - HS I2C</em> permite conexiones a 3.4Mbits/s, pero exige lógica adicional. En nuestras pruebas, se recomienda mantener 400 kbits/s.</p>
<p>Las principales características de I2C son:
* Sólo require dos líneas: SDA y SCL. 
* No hay requerimientos estrictos de <em>baud rate</em> como en RS232, ya que el <em>master</em> genera la señal de reloj.
* Existe una relación sencilla <em>master/slave</em> entre todos los componentes.
* Permite tener varios <em>master</em> pues proporciona mecanismos de arbitraje y detección de colisiones.
* Cada dispositivo tiene una única dirección de 7-bits (en ocasiones, de 10 bits) que proporciona el fabricante.</p>
<h2 id="nueva-interfaz-i2c-en-esp-idf">Nueva interfaz I2C en ESP-IDF</h2>
<p>ESP-IDF ha cambiado completamente el interfaz para el uso de dispositivos I2C, simplificando significativamente su uso. La nueva estructura puede observarse en la siguiente figura, obtenida de la <a href="https://docs.espressif.com/projects/esp-idf/en/v5.3.1/esp32/api-reference/peripherals/i2c.html">documentación de ESP-IDF</a>.</p>
<p><img alt="estructura" src="img/i2c-structure.png" />
(fuente: ESP-IDF Programming Guide)</p>
<p>Consulta la <a href="https://docs.espressif.com/projects/esp-idf/en/v5.3.1/esp32/api-reference/peripherals/i2c.html">documentación de  ESP-IDF sobre I2C</a> para ver los detalles de la API. A continuación, resumimos lo más relevante.</p>
<p>El uso de dispositivos I2C con ESP-IDF sigue las siguientes etapas:</p>
<ul>
<li>
<p><strong>Inicialización e instanciación del master bus driver</strong>. Es necesario obtener un <em>handle</em>  del bus I2C que se vaya a utilizar. En el SoC montado en la placa ESP32 Devkit-c hay 2 controladores I2C, mientras que en el SoC montado en la placa ESP32-C3 Rust Board sólo hay uno. Esta acción debe hacerse una única vez en toda la aplicación.</p>
</li>
<li>
<p><strong>Especificar y condigurar el dispositivo al que conectaremos</strong>. Deberemos añadir al bus  cada dispositivo I2C que conectemos a nuestro ESP32, obteniendo así un <em>handle</em> que será el que finalmente utilizaremos en las llamadas de lectura/escritrura.</p>
</li>
<li>
<p><strong>Lectura y escritura del dispositivo</strong>. A partir de ese punto, podemos realizar transacciones con el dispositivo.</p>
</li>
<li>
<p><strong>Liberar recursos</strong>. Como en cualquier otro caso, una vez se haya finalizado con el uso de los recursos, conviene liberarlos para evitar <em>memory leaks</em>.</p>
</li>
</ul>
<h3 id="inicializacion-e-instanciacion-del-master-bus-driver">Inicialización e instanciación del master bus driver</h3>
<p>ESP-IDF proporciona 2 llamadas para configurar el bus I2C (pin SDA, pin SCL, señal de reloj...) e instanciar el bus para obtener un <strong>handle</strong>. A continuación se incluye un extracto de código con un ejemplo:</p>
<pre><code class="language-c">
static i2c_master_bus_handle_t i2c_handle;
i2c_master_bus_config_t bus_config = {
        .clk_source = I2C_CLK_SRC_DEFAULT,
        .i2c_port = I2C_NUM_0,
        .scl_io_num = 8,
        .sda_io_num = 10,
        .glitch_ignore_cnt = 7,
        .flags.enable_internal_pullup = true,
};

ESP_ERROR_CHECK(i2c_new_master_bus(&amp;bus_config, &amp;i2c_handle));

</code></pre>
<h3 id="especificar-y-condigurar-el-dispositivo-al-que-conectaremos">Especificar y condigurar el dispositivo al que conectaremos</h3>
<p>Para cada dispositivo I2C que conectemos a nuestro bus (recuerda que podemos conectar múltiples dispositivos a las mismas líneas SDA/SCL) debemos obtener un <em>handle</em> especificando aspectos como su dirección, la velocidad del bus, la longitud de la dirección (7 bits por defecto, pero puede ser 10 bits)...</p>
<p>Se incluye un pequeño extracto de código como ejemplo:</p>
<pre><code class="language-c">
i2c_master_dev_handle_t dev_handle;
const i2c_device_config_t i2c_dev_cfg = {
        .device_address = 0x43,
        .scl_speed_hz = 400000,
    };
i2c_master_bus_add_device(i2c_bus, &amp;i2c_dev_cfg, &amp;dev_handle);

</code></pre>
<h3 id="lectura-y-escritura-del-dispositivo">Lectura y escritura del dispositivo</h3>
<p>Una vez hemos obtenido el <em>handle</em> del dispositivo, podemos proceder a enviar comandos (mediante una escritura al dispositivo) y leer los valores enviados por el sensor (o escribir si se trata de un dispositivo de salida).</p>
<p>Para ello, ESP-IDF proporciona varias funciones. A continuación se incluye el prototipo de las más habituales:</p>
<pre><code class="language-c">
// Trasnmite write_size bytes de información disponibles en write_buffer al dispositivo i2c_dev
esp_err_t i2c_master_transmit(i2c_master_dev_handle_t i2c_dev, const uint8_t *write_buffer, size_t write_size, int xfer_timeout_ms);

// Solicita read_size bytes de información al dispositivo i2c_dev para almancenarnos en read_buffer
esp_err_t i2c_master_receive(i2c_master_dev_handle_t i2c_dev, uint8_t *read_buffer, size_t read_size, int xfer_timeout_ms);

// Opreación de escritura I2C seguida de lectura
esp_err_t i2c_master_transmit_receive(i2c_master_dev_handle_t i2c_dev, const uint8_t *write_buffer, size_t write_size, uint8_t *read_buffer, size_t read_size, int xfer_timeout_ms);

</code></pre>
<p>Habitualmente, se enviará primero un comando con la función <strong>i2c_master_transmit()</strong> y posteriormente se recibirá la información con <strong>i2c_master_receive()</strong>.</p>
<h2 id="interfaz-i2c-en-esp-idf-antiguo-driver">Interfaz I2C en ESP-IDF (antiguo driver)</h2>
<p>ESP-IDF proporcionaba este API para el uso de dispositivos I2C. Permite usar el ESP32  tanto como <em>master</em> como en modo <em>slave</em>. Nuestro SoC ESP2 dispone de dos controladores, por lo que podríamos configurar uno como <em>master</em> y otro como <em>slave</em> (o cualquier otra combinación).</p>
<p>Los pasos para usar un dispositivo I2C son:</p>
<ul>
<li>Configuración de la conexión. Indcaremos qué pines usamos como SDA y como SCL, si queremos  habilitar <em>pull-up</em> (es aconsejable tener uno externo), el modo (<em>master/slave</em>) y la frecuencia de reloj en HZ. Todo ello se escribe en una estructura de tipo <code>i2c_configt_t</code>y se cconfigura mediante la llamada a <code>i2c_param_config()</code>.</li>
<li>Instalación del driver mediante la llamada <code>i2c_driver_install</code>, donde indicaremos, entre otras cosas, qué controlador I2C usaremos (0 o 1).</li>
<li>Realizar las escrituras y lecturas necesarias.</li>
</ul>
<p>Para comuicarnos con un sensor, configuraremos el ESP32 en modo <em>master</em>. Tras instalar el <em>driver</em> procederemos a iniciar la comunicación con el sensor:</p>
<p><img alt="escritura" src="img/i2c-espidf.png" /></p>
<p>Como se indica en la figura anterior, extraída de la web oficial de Espressif, debemos crear un paquete de comandos (<em>cmd_link</em>) mediante la llamda a <code>i2c_cmd_link_create()</code>. En ella incluiremos cada elemento del protocolo I2C:
* Bit de start.
* Dirección del dispositivo <em>slave</em> (7 bits).
* Bit de lectura/escritura.
* Secuencia de bytes que se desean escribir.</p>
<p>Es importante resaltar que, aunque lo que deseemos sea leer de un sensor (por ejemplo, leer la temperatura), es necesario escribir en el bus, pues lo primero que haremos será enviar la dirección (primer <em>write_byte</em>) y, habitualmente, un comando al dispositivo sensor.</p>
<p>También conviene resaltar que la comunicación no se produce hasta que no se llega a la llamada <code>i2c_master_cmd_begin()</code>.</p>
<p>En la siguiente figura se observa un patrón habitual para la lectura:</p>
<p><img alt="lectura" src="img/i2c_read.png" /></p>
<p>Nuevamente, la primera llamada (tras crear el enlace y el bit de <em>start</em>), es a <code>i2c_master_write_byte()</code>, pero esta vez se establecerá el bit de operación a lectura (el bit que se incluye tras los 7 bits de dirección del <em>slave</em>). Tras enviar ese primer byte, el ESP32 quedará a la escucha de bytes por parte del sensor mediante llamadas a <code>i2c_master_read()</code>.</p>
<p>Como en el ejemplo anterior, la comunicación no se produce hasta que no se llega a la llamada <code>i2c_master_cmd_begin()</code>, por lo que si queremos leer varios bytes debemos almacenarlos en posiciones diferentes de memoria y procesarlos después de esta llamada.</p>
<p>Existen también llamadas de más alto nivel, como <code>i2c_master_read_from_device()</code> y <code>i2c_master_write_read_device()</code> que permiten, en ocasiones, simplificar nuestro código.</p>
<h2 id="sensor-si7021">Sensor Si7021</h2>
<p>El Si7021 es un sensor de humedad y temperatura fabricado por <em>Silicon Labs</em>. Este sensor incopora un ADC internamente, que permite digitalizar las lecturas de los sensores y enviarlas a través del interfaz I2C integrado.</p>
<p><img alt="sensor" src="img/si7021.png" /></p>
<p>En el maletín del máster viene montado en una <a href="https://www.adafruit.com/product/3251">placa fabricada por <em>Adafruit</em></a>. Adfruit es una compañía fundada por Limor Fried con la intención de convertirse en un portal de referencia para el aprendizaje de electrónica y la fabricación de diseños para <em>makers</em> de todos los niveles. ¡Merece mucho la pena echar un vistazo a su <em>web</em>!</p>
<p>Dependiendo de la versión del PCB que haya en el maletín, puede que únicamente haya pines expuestos (<em>Vin</em>, <em>3Vo</em>, <em>GND</em>, <em>SCL</em> y <em>SDA</em>) o conectores <em>STEMMA QT</em>, compatible con los conectores <a href="https://www.sparkfun.com/qwiic"><em>Qwiic</em> de Sparkfun</a> (Sparkfun es otra compañía tan interesante como <em>Adafruit</em>). Lamentablemente, nuestra placa ESP32 DevKit-C no tiene conectores de ese tipo, por lo que necesitaremos conectar directamente los 4 cables: alimentación, tierra, SCL y SDA.</p>
<p>De acuerdo a las <a href="https://www.silabs.com/documents/public/data-sheets/Si7021-A20.pdf">especificaciones del sensor Si7021</a>, el voltaje de entrada no debe superar los 3.6V. La placa de <em>Adafruit</em> proporcionada tiene un regulador de voltaje que nos permite conectar tanto 3.3V como 5V. </p>
<p>La sección de la <a href="https://www.silabs.com/documents/public/data-sheets/Si7021-A20.pdf">hoja de especificaciones del sensor Si7021</a> informa acerca del interfaz I2C que ofrece el sensor. Nos indica los 7 bits de dirección del sensor, así como de los comandos disponibles (la mayoría de ellos de 1 byte). </p>
<p>La sección 5.1.2 del documento explica cómo obtener una medida de temperatura tras haber realizado una medidad de humedad. Para ello usa el <strong>comando 0xE0</strong>. En nuestro caso <strong>deberemos usar 0xE3 o 0xF3</strong> para la lectura de la temperatura. Una vez leiodos los dos bytes, se puede calcular la temperatura de acuerdo a la fórmula descrita en el datasheet:</p>
<div class="arithmatex">\[\begin{equation}
\text{Temperature (°C)} = \frac{175.72 *\text{Raw_Temp}}{65536.0f} - 46.85
\end{equation}\]</div>
<div class="admonition danger">
<p class="admonition-title">i2ctools (opcional)</p>
<p>Compila y prueba el ejemplo <em>i2c_tools</em> de la carpeta de ejemplos (<em>examples/peripherals/i2c/i2c_tools</em>). Conecta el sensor a los pines indicados por defecto (también a Vcc y a tierra) y ejecuta al comando <code>i2cdetect</code>. Prueba a los distintos comandos disponibles para tratar de leer información del sensor.</p>
</div>
<h2 id="ejercicios-obligatorios">Ejercicios obligatorios</h2>
<h3 id="usar-sensor-si7021-en-esp32-devkit-c">Usar sensor Si7021 en ESP32 devkit-c</h3>
<p>Escribe un código que monitorice la temperatura leyendo el sensor Si7021 conectado al ESP32 devkit-c v4 (placa antigua).  Utiliza el nuevo driver para realizar la implementación. Para ello puedes seguir el siguiente template:</p>
<pre><code class="language-c">#define I2C_SDA_PIN     ...
#define I2C_SCL_PIN     ...
#define I2C_FREQ_HZ      100000
#define I2C_DEV_ADDR     0x40    // Dirección I2C del Si7021

static const char *TAG = &quot;si7021&quot;;

static float si7021_read_temperature(i2c_master_dev_handle_t dev)
{
    ...
    uint16_t raw = ...;
    float temp_c = ((175.72f * raw) / 65536.0f) - 46.85f;
    return temp_c;
}

static float si7021_read_humidity(i2c_master_dev_handle_t dev)
{

    uint16_t raw = ...;
    float rh = ((125.0f * raw) / 65536.0f) - 6.0f;
    if (rh &gt; 100.0f) rh = 100.0f;
    if (rh &lt; 0.0f) rh = 0.0f;
    return rh;
}

void app_main(void)
{
    // Configurar el bus I2C
    i2c_master_bus_config_t bus_config = {
        .i2c_port = I2C_NUM_0,
        .sda_io_num = I2C_SDA_PIN,
        .scl_io_num = I2C_SCL_PIN,
        .clk_source = I2C_CLK_SRC_DEFAULT,
        .glitch_ignore_cnt = 7,
        .flags.enable_internal_pullup = true,
    };

    i2c_master_bus_handle_t bus_handle;
    ESP_ERROR_CHECK(i2c_new_master_bus(&amp;bus_config, &amp;bus_handle));

    // Añadir el dispositivo Si7021
    i2c_device_config_t dev_config = {
        .dev_addr_length = I2C_ADDR_BIT_LEN_7,
        .device_address = I2C_DEV_ADDR,
        .scl_speed_hz = I2C_FREQ_HZ,
    };

    i2c_master_dev_handle_t si7021;
    ESP_ERROR_CHECK(i2c_master_bus_add_device(bus_handle, &amp;dev_config, &amp;si7021));

    // Bucle principal: alternar lecturas cada segundo
    while (1) {
        float temp = si7021_read_temperature(si7021);
        if (temp &gt; -100.0f)
            ESP_LOGI(TAG, &quot; Temperatura: %.2f °C&quot;, temp);
        vTaskDelay(pdMS_TO_TICKS(1000));  // Esperar 1 segundo

        float hum = si7021_read_humidity(si7021);
        if (hum &gt;= 0.0f)
            ESP_LOGI(TAG, &quot; Humedad: %.2f %%&quot;, hum);
        vTaskDelay(pdMS_TO_TICKS(1000));  // Esperar 1 segundo antes del siguiente ciclo
    }

    // Limpieza
    ESP_ERROR_CHECK(i2c_master_bus_rm_device(si7021));
    ESP_ERROR_CHECK(i2c_del_master_bus(bus_handle));
}
</code></pre>
<h3 id="usar-componente-icm-42670-p-con-nuevo-driver">Usar componente ICM-42670-P con nuevo driver</h3>
<p>El <a href="https://components.espressif.com/">registro de componentes de IDF</a> incluye un componente para utilizar la IMU incluida en la placa ESP-RUST-BOARD (con el SoC ESP32-C3):<a href="https://components.espressif.com/components/espressif/icm42670/versions/2.0.0">ICM42607/ICM42670 6-Axis MotionTracking (Accelerometer and Gyroscope)</a>.</p>
<p>Crea una aplicación que monitorice el estado del acelerómetro y determine si la placa está boca arriba o boca abajo. El LED RGB cambiará de color en función de la orientación, y se imprimirá por terminal el estado actual.</p>
<p>Recuerda que, antes de poder usar cualquier dispositivo I2C, es necesario instanciar el controlador de bus I2C que vayamos a utilizar (en este caso, el úinico disponible en esta placa).</p>
<pre><code class="language-c">
static i2c_master_bus_handle_t i2c_handle;
static void i2c_bus_init(void)
{
    i2c_master_bus_config_t bus_config = {
        .clk_source = I2C_CLK_SRC_DEFAULT,
        .i2c_port = I2C_NUM_0,
        .scl_io_num = 8,
        .sda_io_num = 10,
        .glitch_ignore_cnt = 7,
        .flags.enable_internal_pullup = true,
    };

    ESP_ERROR_CHECK(i2c_new_master_bus(&amp;bus_config, &amp;i2c_handle));
}

</code></pre>
<p>Asimismo, tras crear el <em>handle</em> del dispositivo, es necesario configurarlo. El componente ofrece una llamada para ello: <em>icm42670_config()</em>. Puedes usar el siguiente código de configuración:</p>
<pre><code class="language-c">
    /* Configuration of the accelerometer and gyroscope */
    const icm42670_cfg_t imu_cfg = {
        .acce_fs = ACCE_FS_2G,
        .acce_odr = ACCE_ODR_400HZ,
        .gyro_fs = GYRO_FS_2000DPS,
        .gyro_odr = GYRO_ODR_400HZ,
    };
   ret = icm42670_config(icm42670, &amp;imu_cfg);

</code></pre>
<p>Es muy recomendable consultar la carpeta <em>test_apps</em> incluida en el propio componente para aprender a utilizarlo. </p>
<div class="admonition note">
<p class="admonition-title">Cuestiones</p>
<ul>
<li>¿Qué dirección tiene el dispositivo I2C?</li>
<li>¿Qué llamada de ESP-IDF utiliza el código para determinar el <em>device id</em>? ¿Qué comando se envía?</li>
<li>Antes de usar el acelerómetro, es necesario activarlo con la llamada <code>icm42670_acce_set_pwr(icm42670, ACCE_PWR_LOWNOISE);</code>. Describe las transacciones en el bus I2C que se desencadena esa llamada. Usa un formato similar a: <code>START | 0x34 WR  | 0x44 ACK | ... | STOP | START ....</code></li>
<li>¿Qué comando se utiliza para leer el valor en crudo (<em>raw</em>) del acelerómetro?</li>
<li>¿Cuántos bytes se leen tras enviar el comando de lectura de acelerómetro <em>raw</em>? ¿A qué se corresponde cada byte?</li>
</ul>
</div>
<h2 id="ejercicios-opcionales">Ejercicios opcionales</h2>
<h3 id="uso-de-crc-en-sensor">Uso de CRC en sensor</h3>
<p>El sensor Si7021 permite el cálculo de un byte de <em>checksum</em> (CRC) para comprobar que no ha habido errores en el envío. Completa el código del componente para leer dicho byte y comprobar que no ha habido errores. Conviene leer la sección 5.1 y una <a href="https://barrgroup.com/tech-talks/checksums-and-crcs">librería para el cálculo de CRC como la ofrecida por BARR</a>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="../../js/mathjax.js"></script>
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
