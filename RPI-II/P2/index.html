<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 2 - Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-I</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P1b/index.md" class="dropdown-item">Práctica 1 (segunda parte)</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-II</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../P1_III/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Práctica 2</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 5 (I)</a>
</li>
                                    
<li>
    <a href="../P5_II/" class="dropdown-item">Práctica 5 (II)</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">ANIOT</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../ANIOT/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P1_III/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P3/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#practica-2-seguridad-tls-y-dtls" class="nav-link">Práctica 2. Seguridad (TLS y DTLS)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#wolfssl" class="nav-link">WolfSSL</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#clienteservidor-tls-ejemplo-basico-en-host" class="nav-link">Cliente/servidor TLS. Ejemplo básico en host</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#clienteservidor-dtls-ejemplo-basico-en-host" class="nav-link">Cliente/servidor DTLS. Ejemplo básico en host</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#tls-en-el-esp32-el-componente-wolfssl-version-572" class="nav-link">TLS en el ESP32. El componente wolfSSL (version 5.7.2)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#tls-en-el-esp32-el-componente-esp-tls" class="nav-link">TLS en el ESP32. El componente ESP-TLS</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-2-seguridad-tls-y-dtls">Práctica 2. Seguridad (TLS y DTLS)</h1>
<h2 id="objetivos">Objetivos</h2>
<ul>
<li>Observar el comportamiento de TLS y DTLS para el intercambio cifrado de mensajes.</li>
<li>Conocer las diferencias básicas entre TLS y DTLS.</li>
<li>Conocer una API básica de programación de sistemas cliente/servidor usando TLS y DTLS (WolfSSL).</li>
<li>Conocer una API básica de programación de sistemas cliente/servidor en ESP-IDF (ESP-TLS/WolfSSL).</li>
</ul>
<h2 id="wolfssl">WolfSSL</h2>
<p>De las principales librerías que implementan protocolos de seguridad, sin duda alguna la más eficiente es <a href="https://www.wolfssl.com/">WolfSSL</a> y es por ello que esta práctica se centra en ella.</p>
<h3 id="instalacion-linux">Instalación (Linux)</h3>
<p>Aunque se pueden emplear paquetes binarios de la propia distribución de Linux, es recomendable partir del código fuente y compilarlo/instalarlo.</p>
<p>Por lo tanto, lo primero es descargar el fichero <code>wolfssl-5.7.2.zip</code> de este <a href="https://www.wolfssl.com/download/">enlace</a> y descomprimirlo en una ruta sin espacios <em>(esta recomendación es aplicable a todas las prácticas)</em>.</p>
<p>Antes de proceder a su compilación es necesario instalar una serie de pre-requisitos:</p>
<pre><code class="language-sh">sudo apt install build-essential libtool-bin autoconf libevent-dev
</code></pre>
<p>Moverse al directorio descomprimido para configurar y construir la librería:</p>
<pre><code class="language-sh">./configure --enable-dtls  --enable-dtls13 
make
sudo make install
</code></pre>
<p>Dependiendo de la versión del fichero comprimido que se emplee es 
posible que el fichero <code>./configure</code> no este presente y sea preciso 
generarlo mediante el script <code>./autogen.sh</code>.</p>
<p>Cabe destacar el siguiente mensaje que aparece tras realizar la 
instalación mediante <code>make install</code>:</p>
<pre><code>----------------------------------------------------------------------
Libraries have been installed in:
   /usr/local/lib

If you ever happen to want to link against installed libraries
in a given directory, LIBDIR, you must either use libtool, and
specify the full pathname of the library, or use the '-LLIBDIR'
flag during linking and do at least one of the following:
   - add LIBDIR to the 'LD_LIBRARY_PATH' environment variable
     during execution
   - add LIBDIR to the 'LD_RUN_PATH' environment variable
     during linking
   - use the '-Wl,-rpath -Wl,LIBDIR' linker flag
   - have your system administrator add LIBDIR to '/etc/ld.so.conf'

See any operating system documentation about shared libraries for
more information, such as the ld(1) and ld.so(8) manual pages.
----------------------------------------------------------------------
</code></pre>
<p>Esta información es preciso tenerla en cuenta a la hora compilar y ejecutar 
binarios que empleen esta librería. En particular si no estuviese ya
el directorio <code>/usr/local/lib</code> en las rutas de búsqueda establecidas por la 
variable de entorno <code>LD_LIBRARY_PATH</code> sería preciso añadirlo con el siguiente
comando:</p>
<pre><code>export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
</code></pre>
<p>Esto puede realizarse cada vez que sea preciso o de forma automática al inicio 
de sesión modificando el fichero <code>.bashrc</code>:</p>
<pre><code>echo &quot;export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH&quot; &gt;&gt; $HOME/.bashrc
</code></pre>
<h2 id="clienteservidor-tls-ejemplo-basico-en-host">Cliente/servidor TLS. Ejemplo básico en host</h2>
<p>El repositorio <a href="https://github.com/wolfSSL/wolfssl-examples.git"><code>wolfssl-examples</code></a> contiene aplicaciones de ejemplo, escritas en C, que demuestran cómo usar la biblioteca WolfSSL.</p>
<p>Aunque sólo vamos a usar un par de ellas, lo más sencillo es clonar el repositorio completo:</p>
<pre><code class="language-sh">git clone https://github.com/wolfSSL/wolfssl-examples.git
cd wolfssl-examples/
</code></pre>
<h3 id="servidor-tls">Servidor TLS</h3>
<p>Analizaremos en primer lugar el código básico del servidor TLS. Para ello, 
observa el contenido del fichero <code>tls/server-tls.c</code>.</p>
<h3 id="cabeceras-y-constantes">Cabeceras y constantes</h3>
<p>El uso de WolfSSL requiere la inclusión de dos cabeceras básicas:</p>
<pre><code class="language-c">#include &lt;wolfssl/options.h&gt;
#include &lt;wolfssl/ssl.h&gt;
</code></pre>
<p>Además, ya que serán necesarios en el desarrollo, definiremos las rutas al
certificado (clave pública) del servidor y su clave privada:</p>
<pre><code class="language-c">#define CERT_FILE &quot;../certs/server-cert.pem&quot;
#define KEY_FILE  &quot;../certs/server-key.pem&quot;
</code></pre>
<p>Observa además que el puerto de escucha del servidor será el <code>11111</code>.</p>
<h3 id="objetos-basicos-wolfssl-contexto-y-objeto-ssl">Objetos básicos WolfSSL. Contexto y objeto SSL</h3>
<p>Definiremos dos objetos básicos que se utilizarán de forma recurrente
en el código:</p>
<pre><code class="language-c">WOLFSSL_CTX* ctx;
WOLFSSL*     ssl;
</code></pre>
<p>El contexto (<code>ctx</code>) incluye valores globales para cada conexión SSL, incluyendo
información sobre certificados. Es posible utilizar un mismo contexto para 
múltiples conexiones, siempre que compartan características. Para crear un 
nuevo contexto, utilizaremos la función <code>wolfSSL_CTX_new</code> como sigue:</p>
<pre><code class="language-c">/* Create and initialize WOLFSSL_CTX */
if ((ctx = wolfSSL_CTX_new(wolfTLSv1_2_server_method())) == NULL) {
  fprintf(stderr, &quot;ERROR: failed to create WOLFSSL_CTX\n&quot;);
  return -1;
}
</code></pre>
<p>El argumento proporcionado incluye información sobre la versión de protocolo
a utilizar. Actualmente, WolfSSL soporta SSL 3.0,
TLS 1.1, TLS 1.2,  DTLS 1.0 y DTLS 1.2. En este caso, para la parte cliente,
las funciones a utilizar como argumento serían:</p>
<ul>
<li><code>wolfSSLv3_server_method();     // SSLv3</code></li>
<li><code>wolfTLSv1_server_method();     // TLSv1</code></li>
<li><code>wolfTLSv1_1_server_method();   // TLSv1.1</code></li>
<li><code>wolfTLSv1_2_server_method();   // TLSv1.2</code></li>
<li><code>wolfDTLSv1_server_method();    // DTLS</code></li>
<li><code>wolfDTLSv1_2_server_method();  // DTLS 1.2</code></li>
</ul>
<p>En segundo lugar, es necesario cargar nuestra CA (Autoridad Certificadora)
en el contexto, para que cualquier cliente pueda verificar, en el momento de
su conexión, la identidad del servidor. Para ello, usamos la función
<code>wolfSSL_CTX_use_certificate_file</code> de la siguiente manera:</p>
<pre><code class="language-c">/* Load server certificates into WOLFSSL_CTX */
if (wolfSSL_CTX_use_certificate_file(ctx, CERT_FILE, SSL_FILETYPE_PEM)
        != SSL_SUCCESS) {
  fprintf(stderr, &quot;ERROR: failed to load %s, please check the file.\n&quot;,
                CERT_FILE);
  return -1;
}
</code></pre>
<p>Del mismo modo, el servidor deberá incluir su clave privada en formato PEM:</p>
<pre><code class="language-c">/* Load server key into WOLFSSL_CTX */
if (wolfSSL_CTX_use_PrivateKey_file(ctx, KEY_FILE, SSL_FILETYPE_PEM)
        != SSL_SUCCESS) {
  fprintf(stderr, &quot;ERROR: failed to load %s, please check the file.\n&quot;,
                KEY_FILE);
  return -1;
}
</code></pre>
<p>A continuación, observa como el código de escucha y aceptación de conexiones
entrantes no difieren de cualquier código que hayas desarrollado previamente
para aceptar conexiones entrantes TCP (<code>bind</code>, + <code>listen</code> + <code>accept</code>).</p>
<p>Justo tras la conexión (<code>accept</code>), resulta necesario crear un nuevo objeto
SSL, así como asociar el descriptor de socket con la nueva sesión (conexión)
TLS:</p>
<pre><code class="language-c">/* Create a WOLFSSL object */
if ((ssl = wolfSSL_new(ctx)) == NULL) {
  fprintf(stderr, &quot;ERROR: failed to create WOLFSSL object\n&quot;);
  return -1;
}

/* Attach wolfSSL to the socket */
wolfSSL_set_fd(ssl, connd);

/* Establish TLS connection */
ret = wolfSSL_accept(ssl);
if (ret != SSL_SUCCESS) {
  fprintf(stderr, &quot;wolfSSL_accept error = %d\n&quot;,
                wolfSSL_get_error(ssl, ret));
  return -1;
}
</code></pre>
<p>A partir de este punto, podemos enviar y recibir datos a través del socket
(y por tanto de la conexión TLS) de forma muy similar a como lo hacemos 
con el enfoque clásico. Así, para recibir datos:</p>
<pre><code class="language-c">if (wolfSSL_read(ssl, buff, sizeof(buff)-1) == -1) {
  fprintf(stderr, &quot;ERROR: failed to read\n&quot;);
  return -1;
}
</code></pre>
<p>Y para enviar datos de vuelta:</p>
<pre><code class="language-c">/* Reply back to the client */
if (wolfSSL_write(ssl, buff, len) != len) {
  fprintf(stderr, &quot;ERROR: failed to write\n&quot;);
  return -1;
}
</code></pre>
<p>Por último, finalizaremos la conexión con la invocación de la función
<code>wolfSSL_free(ssl)</code>.</p>
<div class="admonition note tarea">
<p class="admonition-title">Note</p>
<p>El cliente proporcionado sigue una estrategia de implementación similar.
Compara ambos códigos (cliente y servidor) y asegúrate de entender las
diferencias entre ellos.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Tarea entregable</p>
<p>Compila y ejecuta el sistema cliente/servidor TLS y obtén capturas de
tráfico tanto de las fases de establecimiento de conexión como de las
fases de transferencia de datos. En base a lo aprendido en las clases
de teoría y la documentación adicional sobre TLS y wolfSSL, redacta 
un breve informe que resuma el proceso de <em>handshake</em> y transferencia
de datos en TLS tomando como base los paquetes reales observados para
esta conexión.</p>
</div>
<h2 id="clienteservidor-dtls-ejemplo-basico-en-host">Cliente/servidor DTLS. Ejemplo básico en host</h2>
<p>El desarrollo de un sistema básico cliente/servidor con soporte DTLS utilizando
WolfSSL es muy similar al visto anteriormente para TLS. Observa el contenido del fichero <code>dtls/server-dtls.c</code>.</p>
<p>Eel código sigue una filosofía similar a TLS, adaptado, obviamente,
a las características de UDP (tipo de socket, ausencia de conexión, etc.), por
lo que se deja como ejercicio su análisis y ejecución.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea entregable</p>
<p>Analiza, compila y ejecuta los códigos correspondientes al sistema cliente/servidor
DTLS. Realiza capturas de tráfico y compáralas, paquete a paquete, con las generadas
para un patrón de tráfico similar en el caso de TLS. Incide en sus similitudes
y diferencias, tanto a nivel de <em>handshake</em> como de transferencia de datos. Observa,
en este último caso, la aparición de nuevos campos de encabezado en los envíos
de datos DTLS. ¿Cuál/cuáles son esos campos y por qué aparecen? Realiza una comparativa
del tráfico total generado en ambos casos para exactamente la misma cantidad de datos 
transferidos.</p>
</div>
<h2 id="tls-en-el-esp32-el-componente-wolfssl-version-572">TLS en el ESP32. El componente wolfSSL (version 5.7.2)</h2>
<p>La librería WolfSSL está disponible como <a href="https://components.espressif.com/components/wolfssl/wolfssl/versions/5.7.2?language=en">componente de Espressif</a>. A continuación veremos un ejemplo de uso de cliente TLS apto para conectarse el servidor anterior.</p>
<p>Aunque es posible usar el GUI de la Extensión de ESP-IDF de VSCode, por brevedad vamos a realizar los pasos desde línea de comandos en el terminal <code>ESP-IDF Terminal</code>.</p>
<p>Moverse a la carpeta dónde se quiera importar el ejemplo y ejecutar el siguiente comando.</p>
<pre><code>idf.py create-project-from-example &quot;wolfssl/wolfssl^5.7.2:wolfssl_client&quot;
cd wolfssl_client`
</code></pre>
<p>Ejecuta la utilidad <code>menuconfig</code> :</p>
<pre><code>idf.py menuconfig
</code></pre>
<p>Y configura los diferentes parámetros para el dispositivo objetivo, junto con la configuración local de WiFi:</p>
<ul>
<li>Host de destino: <code>CONFIG_WOLFSSL_TARGET_HOST</code> (en nuestro caso del del host en el que se ejecute el servidor TLS)</li>
<li>Puerto de destino: <code>CONFIG_WOLFSSL_TARGET_PORT</code> (por defecto 11111)</li>
<li>SSID de WiFi de ejemplo: <code>CONFIG_EXAMPLE_WIFI_SSID</code></li>
<li>Contraseña de WiFi de ejemplo: <code>CONFIG_EXAMPLE_WIFI_PASSWORD</code></li>
</ul>
<p>Cabe señalar que los <em>makefiles</em> de este ejemplo no requieren la instalación de wolfSSL copiando archivos localmente.</p>
<p>Es preciso señalar que hay un pequeño error en el código de ejemplo y preciso realizar la siguiente modificación del fichero <code>main\include\client-tls.h</code> o de lo contrario no usa la dirección destino configurada previamente:</p>
<pre><code class="language-c">/* See main/Kconfig.projbuild for default configuration settings */
#ifdef CONFIG_WOLFSSL_TARGET_HOST
    #define TLS_SMP_TARGET_HOST         CONFIG_WOLFSSL_TARGET_HOST
#else
    #define TLS_SMP_TARGET_HOST         &quot;192.168.1.41&quot;
#endif
</code></pre>
<p>A continuación se puede compilar y cargar el firmware para ver el ejemplo en acción.</p>
<pre><code class="language-shell">idf.py build
idf.py flash
idf.py monitor
</code></pre>
<div class="admonition danger">
<p class="admonition-title">Tarea entregable</p>
<p>Compila y ejecuta el cliente TLS en el ESP32, y consigue que interactúe con
el servidor TLS que probaste anteriormente en el <em>host</em>. Comprueba que, efectivamente,
los datos se transfieren cifrados entre ambos extremos, y que el intercambio de 
paquetes es similar al que observaste entre cliente y servidor en el <em>host</em>. </p>
</div>
<div class="admonition danger">
<p class="admonition-title">Tarea entregable</p>
<p>Repite el mismo proceso para el cliente DTLS.</p>
</div>
<h2 id="tls-en-el-esp32-el-componente-esp-tls">TLS en el ESP32. El componente ESP-TLS</h2>
<p>ESP-IDF proporciona un componente (ESP-TLS) que ofrece una interfaz (<a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/esp_tls.html">API</a>)
simplificada para acceder a funcionalidad básica TLS. Aún así, ofrece 
una funcionalidad suficientemente amplia como para implementar casos de uso
comunes en entornos IoT. </p>
<p>La API de ESP-TLS es sencilla, y se basa en el uso de cuatro funciones básicas:</p>
<h3 id="establecimiento-de-conexion-tls-esp_tls_conn_new_sync">Establecimiento de conexión TLS (<code>esp_tls_conn_new_sync()</code>)</h3>
<ul>
<li>Prototipo:</li>
</ul>
<pre><code class="language-c">int esp_tls_conn_new_sync(const char *hostname, int hostlen, int port, const esp_tls_cfg_t *cfg, esp_tls_t *tls)
</code></pre>
<ul>
<li>
<p>Descripción: Crea una nueva conexión TLS/SSL bloqueante, estableciendo dicha
  conexión contra un servidor establecido. </p>
</li>
<li>
<p>Parámetros: </p>
<ul>
<li><code>hostname</code>: Identificación del host.</li>
<li><code>hostlen</code>: Longitud del parámetro <code>hostname</code>.</li>
<li><code>port</code>: Puerto de conexión con el host.</li>
<li><code>cfg</code>: Configuración de la conexión TLS.</li>
<li><code>tls</code>: Puntero a <code>esp_tls_t</code> (manejador de la conexión). Devuelve <code>NULL</code> si se produce un error en la conexión.</li>
</ul>
</li>
</ul>
<h3 id="destruccion-de-conexion-tls-esp_tls_conn_delete">Destrucción de conexión TLS (<code>esp_tls_conn_delete()</code>)</h3>
<pre><code class="language-c"> void esp_tls_server_session_delete(esp_tls_t *tls)
</code></pre>
<ul>
<li>
<p>Descripción: Cierra la conexión TLS/SSL. </p>
</li>
<li>
<p>Parámetros: </p>
<ul>
<li><code>tls</code>: Manejador de la conexión.</li>
</ul>
</li>
</ul>
<h3 id="escritura-de-datos-esp_tls_conn_read">Escritura de datos (<code>esp_tls_conn_read()</code>)</h3>
<pre><code class="language-c">ssize_t esp_tls_conn_write(esp_tls_t *tls, const void *data, size_t datalen)
</code></pre>
<ul>
<li>
<p>Descripción: Escribe en la conexión TLS/SSL indicada el contenido del buffer
  <code>data</code>.</p>
</li>
<li>
<p>Parámetros: </p>
<ul>
<li><code>tls</code>: Manejador de la conexión. </li>
<li><code>data</code>: Buffer de envío.</li>
<li><code>datalen</code>: Longitud del buffer de envío (o número máximo 
   de bytes a escribir).</li>
</ul>
</li>
<li>
<p>Valor de retorno: </p>
<ul>
<li><code>&gt;=0</code>: éxito en el envío. Número de bytes efectivamente enviados.</li>
<li><code>&lt;0</code>: error en el envío.</li>
</ul>
</li>
</ul>
<h3 id="lectura-de-datos-esp_tls_conn_read">Lectura de datos (<code>esp_tls_conn_read()</code>)</h3>
<pre><code class="language-c">ssize_t esp_tls_conn_read(esp_tls_t *tls, void *data, size_t datalen)
</code></pre>
<ul>
<li>
<p>Descripción: Lee desde la conexión TLS/SSL indicada hacia el buffer <code>data</code>.</p>
</li>
<li>
<p>Parámetros: </p>
<ul>
<li><code>tls</code>: Manejador de la conexión. </li>
<li><code>data</code>: Buffer de recepción.</li>
<li><code>datalen</code>: Longitud del buffer de recepción (o número máximo 
   de bytes a leer).</li>
</ul>
</li>
<li>
<p>Valor de retorno: </p>
<ul>
<li><code>&gt;0</code>: éxito en la recepción. Número de bytes efectivamente leídos.</li>
<li><code>=0</code>: error en la recepción. La conexión se cerró.</li>
<li><code>&lt;0</code>: error en la recepción. </li>
</ul>
</li>
</ul>
<h3 id="estructura-basica-de-un-cliente-tcp-usando-esp-idf">Estructura básica de un cliente TCP usando ESP-IDF</h3>
<p>Un cliente TCP implementado sobre ESP-IDF para dar soporte TLS, 
requiere ciertas modificaciones con respecto a la versión sin TLS. 
De hecho, el uso de ESP-IDF simplifica el código del cliente. La
estructura básica resultaría:</p>
<pre><code class="language-c">/// Includes anteriores.
#include &quot;esp_tls.h&quot;

// Puede tomarse desde menuconfig.
#define HOST_IP_ADDR DIRECCION_DE_HOST
#define PORT PUERTO 

static const char *payload = &quot;Hola, mundo via TLS&quot;;

// ...

static void tls_client_task( void  *pvParameters )
{
  // ...

  // Configuración de ESP-TLS (vacío para opciones defecto).
  esp_tls_cfg_t cfg = { };

  // Creación de conexión.
  struct esp_tls tls;
  ret = esp_tls_conn_new_sync( HOST_IP_ADDR, longitud, PORT, &amp;cfg, &amp;tls);

  // Chequeo de errores.
  // ...

  // Envío de datos.
  ret = esp_tls_conn_write(tls, payload, strlen(payload));

  // Chequeo de errores.
  // ...

  // Lectura de datos
  ret = esp_tls_conn_read(tls, (char *)rx_buffer, 128);

  // Chequeo de errores.
  // ...

  // Destrucción de la conexión
  esp_tls_server_session_delete( tls );

  vTaskDelete( NULL );
}

void app_main( void )
{
  // ...
}
</code></pre>
<div class="admonition danger">
<p class="admonition-title">Tarea entregable</p>
<p>Estudia y prueba el ejemplo base <code>examples/protocols/https_request</code>. 
Opcionalmente, modifica este ejemplo para que interactue con el servidor 
TLS empleando previamente.</p>
</div>
<h4 id="desactivacion-de-la-comprobacion-de-certificado-de-servidor">Desactivación de la comprobación de certificado de servidor</h4>
<p>Basta con modificar la configuración del proyecto del siguiente modo:</p>
<pre><code># CONFIG_EXAMPLE_CLIENT_SESSION_TICKETS is not set
CONFIG_ESP_TLS_INSECURE=y
CONFIG_ESP_TLS_SKIP_SERVER_CERT_VERIFY=y
# CONFIG_MBEDTLS_CERTIFICATE_BUNDLE is not set
</code></pre>
<p>Y comentar estás líneas del fichero <code>https_request_example_main.c</code> para borrar la configuración de la entidad de certificación (de lo contrario prevalecería sobre la opción <code>CONFIG_ESP_TLS_SKIP_SERVER_CERT_VERIFY</code>):</p>
<pre><code class="language-c">  esp_tls_cfg_t cfg = {
  //    .cacert_buf = (const unsigned char *) server_root_cert_pem_start,
  //    .cacert_bytes = server_root_cert_pem_end - server_root_cert_pem_start,
  ...
  };
</code></pre>
<h4 id="servidor-web-de-test-con-certificado-autofirmado">Servidor web de test con certificado autofirmado</h4>
<p>Para comprobar el ejemplo <code>examples/protocols/https_request</code> con un servidor https local con certificado autofirmado se pueden emplear los siguientes comandos de <code>openssl</code>.</p>
<ul>
<li><em>Generación del certificado autofirmado.</em> Es preciso proporciona cierta información, entre otras cosas la dirección IP o nombre del host.</li>
</ul>
<pre><code class="language-sh">openssl openssl genrsa -out server.key 2048
</code></pre>
<pre><code class="language-sh">openssl openssl req -new -x509 -key server.key -out server.crt -days 365

You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:ES
State or Province Name (full name) [Some-State]:Madrid
Locality Name (eg, city) []:Madrid
Organization Name (eg, company) [Internet Widgits Pty Ltd]:UCM
Organizational Unit Name (eg, section) []:FDI
Common Name (e.g. server FQDN or YOUR name) []:&lt;IP HOST&gt;
Email Address []:lpinuel@ucm.es
</code></pre>
<ul>
<li><em>Arranque del servidor web</em>.</li>
</ul>
<pre><code class="language-sh">openssl openssl s_server -accept 8443 -cert server.crt -key server.key -www

Using default temp DH parameters
ACCEPT
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
