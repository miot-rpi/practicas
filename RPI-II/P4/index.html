<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 4 - Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-I <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P1b/index.md" class="dropdown-item">Práctica 1 (segunda parte)</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-II <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../P1_III/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="../P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 5 (I)</a>
</li>
                                    
<li>
    <a href="../P5_II/" class="dropdown-item">Práctica 5 (II)</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">ANIOT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../ANIOT/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P3/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P5/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-light">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#practica-4-protocolos-basicos-de-capa-de-aplicacion-websockets" class="nav-link">Práctica 4. Protocolos básicos de capa de aplicación. Websockets</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#interactuando-con-un-navegador-web" class="nav-link">Interactuando con un navegador web</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#websockets-en-el-esp32" class="nav-link">Websockets en el ESP32</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sistema-clienteservidor-usando-websockets-en-python" class="nav-link">Sistema cliente/servidor usando Websockets en Python</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-4-protocolos-basicos-de-capa-de-aplicacion-websockets">Práctica 4. Protocolos básicos de capa de aplicación. Websockets</h1>
<h2 id="objetivos">Objetivos</h2>
<ul>
<li>Estudiar el intercambio de mensajes entre un cliente y un servidor 
  <em>websockets</em>, tanto en la fase de <em>handshake</em> como de intercambio de datos.</li>
<li>Conseguir interactuar con un servidor <em>websockets</em> utilizando un navegador
  web como cliente.</li>
<li>Estudiar el componente <em>websockets client</em> en ESP-IDF.</li>
<li>Conocer el módulo Python <em>websockets</em> para desarrollar sistemas básicos
  cliente/servidor utilizando <em>websockets</em> (opcional).</li>
</ul>
<h2 id="interactuando-con-un-navegador-web">Interactuando con un navegador web</h2>
<p>Los <em>websockets</em> permiten el envío asíncrono bidireccional de información, entre un cliente y servidor web. La manera más sencilla de usarlos es mediante un navegador web convencional ya que la mayoría de ellos soportan este tipo de comunicación a través de <em>scripts Javascript</em>.</p>
<p>Como servidor emplearemos un ejemplo de referencia (<a href="https://github.com/websockets/websocket-echo-server">websocket-echo-server</a>) que devuelve los mensajes recibidos. El análisis del código de este servidor queda fuera del ámbito de la presente práctica.</p>
<p>Para instalar el servidor se precisa de los siguientes comandos:</p>
<pre><code class="language-sh">git clone https://github.com/websockets/websocket-echo-server.git
cd websocket-echo-server
npm ci --production
node index.js
</code></pre>
<p>Alternativamente, si no se quiere instalar software adicional en el host, se puede emplear un <em>Docker container</em> siguiendo las instrucciones del mismo repositorio (<a href="https://github.com/websockets/websocket-echo-server?tab=readme-ov-file#running-the-server-in-a-docker-container">enlace</a>).</p>
<p>La configuración del servidor se lleva a cabo mediante las siguientes variables de entorno:</p>
<ul>
<li><code>BIND_ADDRESS</code>: dirección en la que escucha el servidor, por defecto <code>::</code>.</li>
<li><code>BIND_PORT</code>: puerto de escucha, por defecto <code>1337</code>.</li>
<li><code>HEARTBEAT_INTERVAL</code>: intervalo (en milisegundos) entre envíos de mensajes de <code>ping</code> a los clientes para comprobar el estado de las conexiones, por defecto es <code>30000</code>.</li>
<li><code>HIGH_WATER_MARK</code>: umbral (en bytes) para el buffer de salida de cada conexión, cuando se supera, el envío de datos se suspende hasta que se drene el buffer, por defeco es <code>16384</code>.</li>
<li><code>MAX_MESSAGE_SIZE</code>: máximo tamaño de mensaje (en bytes), por defecto es <code>65536</code>.</li>
</ul>
<p>Como cliente emplearemos la siguiente página web:</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;WebSocket Test&lt;/title&gt;
    &lt;script&gt;
        // Create new WebSocket connection
        var mySocket = new WebSocket(&quot;ws://[::1]:1337&quot;);

        // Associate listeners
        mySocket.onopen = function(evt) {
            console.log(&quot;WebSocket connection established.&quot;);

            // Send data when the connection is open
            mySocket.send(&quot;WebSocket Rocks!&quot;);
        };

        mySocket.onmessage = function(evt) {
            console.log(&quot;Received message: &quot; + evt.data);
        };

        mySocket.onclose = function(evt) {
            console.log(&quot;WebSocket closed with status: &quot; + evt.code);
        };

        mySocket.onerror = function(evt) {
            console.error(&quot;WebSocket error:&quot;, evt);
        };

        // Optionally close the WebSocket after 5 seconds
        setTimeout(function() {
            mySocket.close();
            console.log(&quot;WebSocket connection closed.&quot;);
        }, 5000);
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Check the Console for WebSocket output&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Ejecuta el servidor en el <em>host</em> y, tras guardar el código fuente del cliente en un fichero <code>cliente.html</code>, ábrelo con el navegador Chrome y activa las herramientas de desarrollo (<em>DevTools</em>) para poder visualizar los mensajes mostrados en consola.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Analiza el flujo TCP, HTTP y WS intercambiado mediante <em>Wireshark</em>.</p>
</div>
<h2 id="websockets-en-el-esp32">Websockets en el ESP32</h2>
<p>El soporte a nivel de cliente para el protocolo <em>websockets</em> está integrado
en ESP-IDF a través del componente <em>ESP websocket client</em>, cuya documentación
puede consultarse a través de este <a href="https://docs.espressif.com/projects/esp-protocols/esp_websocket_client/docs/latest/index.html">enlace</a>.</p>
<p>El componente <em>ESP websocket client</em> ofrece soporte para el protocolo <em>websocket</em>
tanto sobre TCP como sobre TLS. Como todos los componentes
en ESP-IDF, el componente <em>websocket</em> emite eventos que pueden ser tratados
por parte de la aplicación, entre los cuales destacan:</p>
<ul>
<li><code>WEBSOCKET_EVENT_CONNECTED</code>: se emite una vez el cliente se ha conectado
  al servidor, previo al intercambio de datos.</li>
<li><code>WEBSOCKET_EVENT_ERROR</code>: en caso de error.</li>
<li><code>WEBSOCKET_EVENT_CLOSED</code>: la conexión se ha cerrado limpiamente.</li>
<li><code>WEBSOCKET_EVENT_FINISH</code>: el thread cliente va a cerrarse.</li>
<li><code>WEBSOCKET_EVENT_DATA</code>: se emite al recibir datos desde el servidor.</li>
</ul>
<p>Este último evento es de especial interés para nosotros, ya que acarrea la
construcción de una estructura de tipo <code>esp_websocket_event_data_t</code> en la que
se almacena el mensaje recibido desde el servidor (tanto en sus campos de
control como de datos). Algunos campos de interés dentro de la estructura son:</p>
<ul>
<li><code>data_ptr</code>: puntero a los datos recibidos (<em>payload</em>).</li>
<li><code>data_len</code>: tamaño (en bytes) de los datos recibidos.</li>
<li><code>op_code</code>: código de operación asociado al mensaje recibido.</li>
</ul>
<p>La documentación del componente ofrece información sobre campos adicionales,
de menor interés para nosotros.</p>
<p>Observemos el código de una posible función manejadora de eventos del componente
<em>websocket</em>:</p>
<pre><code class="language-c">tatic void websocket_event_handler(void *handler_args, esp_event_base_t base, int32_t event_id, void *event_data)
{
    esp_websocket_event_data_t *data = (esp_websocket_event_data_t *)event_data;
    switch (event_id) {
    case WEBSOCKET_EVENT_CONNECTED:
        ESP_LOGI(TAG, &quot;WEBSOCKET_EVENT_CONNECTED&quot;);
        break;
    case WEBSOCKET_EVENT_DATA:
        ESP_LOGI(TAG, &quot;WEBSOCKET_EVENT_DATA&quot;);
        ESP_LOGI(TAG, &quot;Received opcode=%d&quot;, data-&gt;op_code);
        if (data-&gt;op_code == 0x2) { // Opcode 0x2 indicates binary data
            ESP_LOG_BUFFER_HEX(&quot;Received binary data&quot;, data-&gt;data_ptr, data-&gt;data_len);
        } else if (data-&gt;op_code == 0x08 &amp;&amp; data-&gt;data_len == 2) {
            ESP_LOGW(TAG, &quot;Received closed message with code=%d&quot;, 256 * data-&gt;data_ptr[0] + data-&gt;data_ptr[1]);
        } else {
            ESP_LOGW(TAG, &quot;Received=%.*s\n\n&quot;, data-&gt;data_len, (char *)data-&gt;data_ptr);
        }

        ESP_LOGW(TAG, &quot;Total payload length=%d, data_len=%d, current payload offset=%d\r\n&quot;, data-&gt;payload_len, data-&gt;data_len, data-&gt;payload_offset);

        xTimerReset(shutdown_signal_timer, portMAX_DELAY);
        break;
    case WEBSOCKET_EVENT_ERROR:
        ESP_LOGI(TAG, &quot;WEBSOCKET_EVENT_ERROR&quot;);
        break;
    case WEBSOCKET_EVENT_FINISH:
        ESP_LOGI(TAG, &quot;WEBSOCKET_EVENT_FINISH&quot;);
        break;
    }
}
</code></pre>
<p>Observa el código. En función del parámetro <code>event_id</code>, el manejador toma
un camino de ejecución u otro. Centrémonos en la recepción de un evento de
tipo <code>ẀEBSOCKET_EVENT_DATA</code>; a través de los distintos campos de la estructura
de información recibida (<code>esp_websocket_event_data_t</code>), es posible:</p>
<ol>
<li>Obtener y mostrar el código de la operación (<code>op_code</code>).</li>
<li>Mostrar el contenido del mensaje recibido   (<code>data_ptr</code>).</li>
<li>Mostrar el tamaño del mensaje recibido (<code>data_len</code> y <code>payload_len</code>).</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Preguntas</p>
<ul>
<li>¿Cuál es la diferencia entre los campos <code>data_len</code> y <code>payload_len</code>?</li>
<li>¿Por qué el programa realiza un tratamiento especial cuando 
<code>op_code == 8</code>?</li>
</ul>
</div>
<p>Dada la anterior función manejadora, la inicialización de un cliente
<em>websockets</em> en el ESP32 es sencilla, y se resume en los siguientes pasos:</p>
<ul>
<li><strong>Configuración de URI (host + puerto)</strong></li>
</ul>
<pre><code class="language-c">esp_websocket_client_config_t websocket_cfg = {};
websocket_cfg.uri = &quot;ws://localhost:1337&quot;;
esp_websocket_client_handle_t client = esp_websocket_client_init(&amp;websocket_cfg);
</code></pre>
<ul>
<li><strong>Asociación de manejador a eventos <em>Websocket</em></strong></li>
</ul>
<pre><code class="language-c">esp_websocket_register_events(client, WEBSOCKET_EVENT_ANY, websocket_event_handler, (void *)client);
</code></pre>
<ul>
<li><strong>Inicialización del cliente</strong></li>
</ul>
<pre><code class="language-c">esp_websocket_client_start(client);
</code></pre>
<p>A partir de este punto, la interacción con el servidor se puede realizar en 
base a funciones de envío de texto o binario:</p>
<pre><code class="language-c">int esp_websocket_client_send_text(esp_websocket_client_handle_t client, const char *data, int len, TickType_t timeout)

int esp_websocket_client_send_bin(esp_websocket_client_handle_t client, const char *data, int len, TickType_t timeout)
</code></pre>
<p>No existen funciones de recepción, ya que ésta es implícita y se notifica vía
eventos.</p>
<h3 id="ejemplo-basico-cliente-echo">Ejemplo básico: cliente <em>echo</em></h3>
<p>Estudiaremos a continuación el ejemplo de cliente proporcionado por el componente <code>espressif/esp_websocket_client</code> para lo cual es preciso descargar el código del repositorio <a href="https://github.com/espressif/esp-protocols.git">esp-protocols</a> ya sea mediante <code>git</code> o mediante fichero zip.</p>
<p>En este punto, configura, compila, flashea y monitoriza el ejemplo
<code>esp-protocols/components/esp_websocket_client/examples/target/</code>.</p>
<p>El ejemplo simplemente conecta con un servidor <em>echo</em> <em>Websockets</em> en la nube
(por defecto <code>wss://echo.websocket.events</code>). Dicho servidor simplemente espera, por
parte de cada cliente, el envío a través de la conexión de una cadena, 
respondiendo con la misma cadena en sentido contrario, siempre usando el 
mismo <em>socket</em>.</p>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Observa el código del ejemplo y su ejecución. Determina cuál es el
funcionamiento del ejemplo, y comprueba que los fragmentos de código 
anteriores tienen su función dentro del código completo. ¿Cómo implementa
el programa la espera limitada en tiempo si no se recibe ningún paquete
tras cierto período?</p>
</div>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Analiza las cosas especiales (ej. envíos parciales) mediante <em>Wireshark</em>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Modifica el ejemplo para que se envíen y se reciban datos en formato JSON. 
Nótese que el ejemplo ya dispone parcialmente de código para ello.</p>
</div>
<h2 id="sistema-clienteservidor-usando-websockets-en-python">Sistema cliente/servidor usando Websockets en Python</h2>
<p>El módulo <code>websockets</code> proporciona la funcionalidad necesaria tanto a nivel de cliente
como de servidor para implementar sistemas basados en dicho protocolo. Concretamente,
las funciones de alto nivel que proporciona están basadas en una API de bajo
nivel que implementa las dos fases principales del protocolo <em>websockets</em>:</p>
<ol>
<li><em>Handshake</em> de apertura de comunicación, en forma de peticiones <em>HTTP upgrade</em>.</li>
<li>Transferencia de datos, y finalización de la comunicación con un <em>handshake</em> de cierre
de conexión.</li>
</ol>
<p>La primera fase está diseñada para integrarse con software HTTP (cliente y servidor)
existente, y proporciona una implementación mínima para construir, parsear y 
validar peticiones y respuestas HTTP.</p>
<p>La segunda fase implementa el núcleo del protocolo <em>websockets</em>, y proporciona
una implementación completa basada en el 
módulo <a href="https://docs.python.org/3/library/asyncio.html">asyncio</a>) 
de Python. </p>
<p>Para utilizar el módulo <code>websockets</code> de Python, primero lo instalaremos vía
<code>pip</code>:</p>
<pre><code class="language-sh">pip install websockets
</code></pre>
<p>Un ejemplo básico se puede basar en un cliente que envía una cadena a un 
servidor, y queda a la espera de recibir un mensaje de respuesta por parte
de éste. </p>
<p>Desarrollar la parte servidora para dicha aplicación resulta sencillo. Observa
el siguiente código:</p>
<pre><code class="language-python">#!/usr/bin/env python

import asyncio
import websockets

async def hello(websocket, path):
    name = await websocket.recv()
    print(f&quot;&lt; {name}&quot;)

    greeting = f&quot;Hello {name}!&quot;

    await websocket.send(greeting)
    print(f&quot;&gt; {greeting}&quot;)

start_server = websockets.serve(hello, &quot;localhost&quot;, 8765)

asyncio.get_event_loop().run_until_complete(start_server)
asyncio.get_event_loop().run_forever()
</code></pre>
<p>El paradigma de programación utilizado en este ejemplo (basado en el 
módulo <a href="https://docs.python.org/3/library/asyncio.html">asyncio</a>) queda fuera
del propósito de la práctica (aunque se invita al alumno a estudiarlo, ya
que aporta importantes ventajas a nivel de sencillez de desarrollo en 
aplicaciones de red). En cualquier caso, el anterior servidor ejecuta
una (co)rutina manejadora <code>hello</code> para cada conexión <em>websocket</em> establecida; 
además, se cierra dicha conexión cuando dicha (co)rutina finaliza.</p>
<p>Concretamente, las funciones de interés en este caso son:</p>
<pre><code class="language-python">await websockets.server.serve(ws_handler, host=None, port=None, # ...
</code></pre>
<p>Crea, incializa y devuelve un objeto <em>servidor Websocket</em> asociado al 
host y puerto seleccionados. En un contexto de programación asíncrona (como
el del ejemplo, el servidor finaliza automáticamente al salir de dicho contexto).</p>
<p>Cuando un cliente conecta al host y puerto específicados, se acepta la conexión,
que es tratada por la (co)rutina <code>ws_handler</code> (en el ejemplo, <code>hello</code>). Antes
de delegar la conexión a la (co)rutina, se lleva a cabo el <em>handshake</em> de 
apertura <em>websocket</em>.</p>
<pre><code class="language-python">await recv()
</code></pre>
<p>Recibe el siguiente mensaje, devolviendo una cadena si el <em>frame</em> recibido
es de texto, o un <em>array</em> de bytes si es binario.</p>
<pre><code class="language-python">await send(message)
</code></pre>
<p>Envía un mensaje. <code>message</code> puede er una cadena, o un array de bytes. En 
el primer caso, se envía un <em>frame</em> de texto; en el segundo caso, 
un <em>frame</em> binario.</p>
<p>A continuación se muestra un ejemplo de cliente <em>websocket</em> para interactuar
con el anterior servidor:</p>
<pre><code class="language-python">#!/usr/bin/env python

import asyncio
import websockets

async def hello():
    uri = &quot;ws://localhost:8765&quot;
    async with websockets.connect(uri) as websocket:
        name = input(&quot;What's your name? &quot;)

        await websocket.send(name)
        print(f&quot;&gt; {name}&quot;)

        greeting = await websocket.recv()
        print(f&quot;&lt; {greeting}&quot;)

asyncio.get_event_loop().run_until_complete(hello())
</code></pre>
<p>El código en este caso es sencillo, ya que únicamente se basa en la planificación
(ejecución) de una (co)rutina llamada <code>hello</code>, que establece una conexión con
un servidor <em>websocket</em> vía <code>connect</code>, enviando y recibiendo un par de mensajes.</p>
<pre><code class="language-python">await websockets.client.connect(uri, # ...
</code></pre>
<p>Conecta con un servidor <em>websocket</em> en la URI determinada. La conexión se cierra
al abandonar el contexto asíncrono (es decir, la (co)rutina <code>hello</code>).</p>
<div class="admonition danger">
<p class="admonition-title">Tarea opcional</p>
<p>Crea un servidor Python que interactue con una versión derivada del cliente ESP32 anterior.</p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
