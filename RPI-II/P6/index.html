<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 2 (I) - Master IoT UCM - Prácticas RPI/LSI/ANIOT</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/LSI/ANIOT</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">LSI <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../LSI/Lab0/" class="dropdown-item">Laboratorio 0</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab1/" class="dropdown-item">Laboratorio 1</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab2/" class="dropdown-item">Laboratorio 2</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab3/" class="dropdown-item">Laboratorio 3</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab4/" class="dropdown-item">Laboratorio 4</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab5/" class="dropdown-item">Laboratorio 5</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-I <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">RPI-II <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../P1_II/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Práctica 2 (I)</a>
</li>
                                    
<li>
    <a href="../P6-II/" class="dropdown-item">Práctica 2 (II)</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../P7/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../P10/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../P8/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../P11/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">ANIOT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../ANIOT/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P9/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P9/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P9/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P9/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P9/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P9/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P9/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P1_II/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P6-II/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-light">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#practica-2-el-protocolo-mqtt-i-despliegue-de-clientes-y-servidoresbrokers-analisis-de-trafico" class="nav-link">Práctica 2. El protocolo MQTT (I). Despliegue de clientes y servidores/brokers. Análisis de tráfico</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#publicacionsuscripcion-contra-un-broker-en-la-nube" class="nav-link">Publicación/suscripción contra un broker en la nube</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#despliegue-de-un-broker-local-usando-eclipse-mosquitto" class="nav-link">Despliegue de un broker local usando Eclipse Mosquitto</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#wildcards" class="nav-link">Wildcards</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#desarrollo-de-un-clientes-locales-opcion-1-node-red" class="nav-link">Desarrollo de un clientes locales. Opción 1: Node-RED</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#desarrollo-de-un-clientes-locales-opcion-2-eclipse-paho" class="nav-link">Desarrollo de un clientes locales. Opción 2: Eclipse Paho</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-2-el-protocolo-mqtt-i-despliegue-de-clientes-y-servidoresbrokers-analisis-de-trafico">Práctica 2. El protocolo MQTT (I). Despliegue de clientes y servidores/<em>brokers</em>. Análisis de tráfico</h1>
<h2 id="objetivos">Objetivos</h2>
<ul>
<li>
<p>Familiarizarse con el uso de <em>brokers</em> y clientes de suscripción/publicación
utilizando MQTT.</p>
</li>
<li>
<p>Desplegar un sistema basado en MQTT local, incluyendo <em>broker</em> y clientes.</p>
</li>
<li>
<p>Utilizar Eclipse Paho para integrar funcionalidad MQTT en programas Python.</p>
</li>
<li>
<p>Familiarizarse con el uso de <em>wildcards</em> MQTT.</p>
</li>
</ul>
<h2 id="publicacionsuscripcion-contra-un-broker-en-la-nube">Publicación/suscripción contra un <em>broker</em> en la nube</h2>
<p>En la primera parte de la práctica, utilizaremos un servidor/<em>broker</em> disponible 
en la nube para su uso libre por parte de los usuarios (<em>test.mosquitto.org</em>). 
Este servidor suele utilizarse con fines de pruebas básicas y depuración, y hay
que ser consciente de que toda la información que en él se publica puede ser
leída por cualquier suscriptor. Debe tenerse este dato en cuenta a la hora
de publicar información sensible a través de MQTT cuando se use el servidor de
pruebas.</p>
<p>El servidor escucha en los siguientes puertos:</p>
<ul>
<li><strong>1883</strong>: MQTT, sin encriptación.</li>
<li><strong>8883</strong>: MQTT, con encriptación.</li>
<li><strong>8884</strong>: MQTT, con encriptación, certificado de cliente requerido.</li>
<li><strong>8080</strong>: MQTT sobre WebSockets, sin encriptación.</li>
<li><strong>8081</strong>: MQTT sobre WebSockets, con encriptación.</li>
</ul>
<p>Para realizar publicaciones/suscripciones contra el <em>broker</em> utilizaremos
la distribución <a href="https://mosquitto.org"><em>mosquitto</em></a> del proyecto Eclipse IoT.
Aunque <em>mosquitto</em> es principalmente una implementación de <em>broker</em> MQTT, nosotros
la utilizaremos en este paso a modo de cliente, lo que nos permitirá suscribirnos
o publicar sobre cualquier <em>topic</em> MQTT.</p>
<p>En primer lugar, instala <em>mosquitto</em>:</p>
<pre><code class="language-sh">sudo apt-get update
sudo apt-get install mosquitto mosquitto-clients mosquitto-dev libmosquitto*
</code></pre>
<p>Si todo ha ido bien, deberías disponer de dos binarios listos para ejecución:</p>
<ul>
<li><code>mosquitto_sub</code>: permite suscribirse a un determinado <em>topic</em> utilizando un 
<em>broker</em>.</li>
<li><code>mosquitto_pub</code>: permite publicar un mensaje asociado a un determinado <em>topic</em>
utilizando un <em>broker</em>.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Tarea 2.1</p>
<p>Observa la ayuda de ambas ordenes, utilizando el argumento <code>--help</code>. Identifica
los parámetros que te permitirán especificar el <em>broker</em> destino, el <em>topic</em>
a utilizar y, en el caso de la publicación, el <em>mensaje</em> a enviar. </p>
</div>
<p>Suscribámonos al <em>topic</em> <code>#</code> en el <em>broker</em>, utilizando para ello la orden:</p>
<pre><code class="language-sh">mosquitto_sub -h test.mosquitto.org  -t &quot;#&quot;
</code></pre>
<div class="admonition note">
<p class="admonition-title">Tarea 2.2</p>
<p>Pausa la salida en cuanto puedas. ¿A qué corresponden los mensajes que estás</p>
</div>
<p>obteniendo?</p>
<p>A continuación, vamos a realizar un proceso de publicación/suscripcion con un 
<em>topic</em> conocido (por ejemplo, <code>/MIOT/tunombre/</code>). Para publicar un mensaje
bajo dicho <em>topic</em>:</p>
<pre><code class="language-sh">mosquitto_pub -h test.mosquitto.org -t &quot;/MIOT/tunombre&quot; -m &quot;Hola, soy tunombre&quot;
</code></pre>
<div class="admonition note">
<p class="admonition-title">Tarea 2.3</p>
<p>Suscríbete al topic <code>/MIOT/tunombre</code> y observa si recibes los resultados 
tras la publicación correspondiente. ¿Cómo podrías suscribirte a todos
los mensajes publicados por compañeros?</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Tarea entregable</p>
<p>Realiza un análisis del intercambio de mensajes necesario para un proceso
de publicación/suscripción contra el <em>broker</em> de test. Incide en el tipo 
de protocolo de capa de transporte que utiliza MQTT, mensajes de datos
y control, sobrecarga del protocolo de capa de aplicación, y en general, 
cualquier aspecto que consideres de interés, incluyendo el uso de opciones
relativas a QoS.</p>
</div>
<h2 id="despliegue-de-un-broker-local-usando-eclipse-mosquitto">Despliegue de un broker local usando Eclipse Mosquitto</h2>
<p>El uso de un servidor remoto presenta ventajas (facilidad de uso), pero una gran
cantidad de inconvenientes (seguridad, imposibilidad de configuración avanzada, 
...)</p>
<p>En esta sección, configuraremos un broker <em>mosquitto</em> para el despliegue de una
infraestructura MQTT local o remota bajo nuestro control.</p>
<p>El arranque de un <em>broker</em> (servidor) <em>mosquitto</em> se realiza mediante el propio
comando <code>mosquitto</code>:</p>
<pre><code class="language-sh">mosquitto [-c config file] [ -d | --daemon ] [-p port number] [-v]
</code></pre>
<p>Sin embargo, en la mayoría de distribuciones Linux, el <em>broker</em> arranca por
defecto y se ejecuta constantemente en segundo plano. Para comprobar el estado
de funcionamiento del <em>broker</em>, basta con ejecutar:</p>
<pre><code class="language-sh">sudo service mosquitto status
</code></pre>
<p>Observarás un mensaje que indica que el servicio está activo. Las opciones
<code>restart</code>, <code>start</code> o <code>stop</code> te permitirán controlar el estado del <em>broker</em> en
todo momento.</p>
<div class="admonition note">
<p class="admonition-title">Tarea 2.4</p>
<p>Comprueba que, con el <em>broker</em> arrancado, puedes realizar un proceso de
suscripción/publicación contra el mismo.</p>
</div>
<p>El <em>broker</em> <em>mosquitto</em> permite monitorizar sus propias estadísticas e información
de estado utilizando el protocolo MQTT. Así, los <em>topics</em> <code>$SYS</code> retornan, bien
periódicamente o bien cuando sucede un evento de interés, la información
de estado del <em>broker</em>. Puedes consultar más detalles en la página de manual
de <em>mosquitto</em> (comando <code>man mosquitto</code>), en el epígrafe <em>BROKER STATUS</em>.</p>
<div class="admonition note">
<p class="admonition-title">Tarea 2.5</p>
<p>Comprueba el estado del <em>broker</em> mientras realizas procesos de suscripción/publicación
reportando bytes recibidos/enviados, número de conexiones activas e inactivas, 
y número de mensajes enviados/recibidos por el <em>broker</em>.</p>
</div>
<h2 id="wildcards">Wildcards</h2>
<p>Además de permitir el uso de <em>topics</em> completos para el proceso de suscripción,
los topics pueden incluir <em>wildcards</em> o comodines en su estructura. <code>+</code> es la
<em>wildcard</em> utilizada para obtener correspondencias con un único nivel de la 
jerarquía. Así, para un <em>topic</em> <code>a/b/c/d</code>, las siguientes suscripciones 
corresponderán con éxito:</p>
<ul>
<li><code>a/b/c/d</code></li>
<li><code>+/b/c/d</code></li>
<li><code>a/+/c/d</code></li>
<li><code>a/+/+/d</code></li>
<li><code>+/+/+/+</code></li>
</ul>
<p>Pero no las siguientes:</p>
<ul>
<li><code>a/b/c</code></li>
<li><code>b/+/c/d</code></li>
<li><code>+/+/+</code></li>
</ul>
<p>La segunda <em>wildcard</em> soportada es <code>#</code>, y permite corresponencias con cualquier
nivel sucesivo de la jerarquía.  Así, para un <em>topic</em> <code>a/b/c/d</code>, las siguientes suscripciones 
corresponderán con éxito:</p>
<ul>
<li><code>a/b/c/d</code></li>
<li><code>#</code></li>
<li><code>a/#</code></li>
<li><code>a/b/#</code></li>
<li><code>a/b/c/#</code></li>
<li><code>+/b/c/#</code></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Tarea 2.6</p>
<p>Experimenta con el uso de <em>wildcards</em> desde múltiples clientes suscriptores. Resultará de especial
interés observar (por ejemplo, con capturas de tráfico) el ahorro de mensajes asociado al uso de
<em>wildcards</em> que restrinjan qué mensajes son recibidos y por qué clientes.</p>
</div>
<h2 id="desarrollo-de-un-clientes-locales-opcion-1-node-red">Desarrollo de un clientes locales. Opción 1: Node-RED</h2>
<p>El despliegue de un cliente MQTT (ya sea suscriptor o publicador) utilizando Node-RED
resulta muy sencillo. Por defecto, Node-RED incorpora dos tipos de nodos que nos serán de
utilidad para nuestros despliegues:</p>
<ul>
<li>Nodo <em>MQTT-in</em>. Recibe datos desde un <em>broker</em> MQTT, y es por tanto el mecanismo recomendado para suscribirse a un determinado <em>topic</em>. El <em>topic</em> al que se suscribe uno de estos nodos es por defecto fijo, aunque puede ser configurado, en versiones modernas del nodo, como dinámico (campo <em>Action -&gt; Dynamic subscription</em>) del menú de configuración. </li>
<li>Nodo <em>MQTT-out</em>. Envía datos hacia un <em>broker</em> MQTT, y es por tanto el mecanismo recomendado para publicar un mensaje sobre un determinado <em>topic</em>. El topic bajo el que se publica un determinado dato puede ser fijo (configurado vía cuadro de diálogo de configuración) o variable (configurado como el contenido del campo <code>msg.topic</code> del mensaje recibido por el nodo <em>MQTT-out</em>).</li>
</ul>
<p>Ambos requerirán, desde su menú de configuración (accesible vía doble click en el nodo), de la configuración previa de un <em>broker</em> MQTT (llamado <em>server</em> en el cuadro de diálogo de configuración del nodo). En el caso de una instalación local, bastará con indicar <code>localhost</code> como localización de dicho servidor.</p>
<div class="admonition note">
<p class="admonition-title">Tarea 2.7</p>
<p>Experimenta con el uso de los nodos <em>MQTT-in</em> y <em>MQTT-out</em> enviando y recibiendo mensajes desde un broker local o remoto. Específicamente, asegúrate de saber cómo personalizar tanto el topic como el mensaje a publicar en un nodo de publicación, o el topic al que se 
suscribirá un nodo de suscripción.</p>
</div>
<h2 id="desarrollo-de-un-clientes-locales-opcion-2-eclipse-paho">Desarrollo de un clientes locales. Opción 2: Eclipse Paho</h2>
<p>Los clientes <code>mosquitto_pub</code> y <code>mosquitto_sub</code> son básicamente herramientas de
desarrollo y pruebas, pero resulta interesante conocer bibliotecas que permitan
la integración de MQTT en programas existentes. Una de ellas es 
<a href="https://www.eclipse.org/paho">Eclipse Paho</a>. Paho es una infraestructura
desarrollada en el proyecto Eclipse IoT para dar soporte a implementaciones
de protocolos de mensajería M2M e IoT, aunque, en este momento, su uso principal
se centra exclusivamente en MQTT.</p>
<p>En nuestro caso, utilizaremos la versión Python de la biblioteca, instalable
vía:</p>
<pre><code class="language-sh">pip install paho-mqtt
</code></pre>
<p>Dispones de la documentación del módulo a través de <a href="https://pypi.org/project/paho-mqtt/#usage-and-api">este enlace</a>.</p>
<p>El despliegue de un ejemplo sencillo para un cliente que se conecta a un <em>broker</em>
y se suscribe al tópico <code>$SYS</code>, imprimiendo los mensajes recibidos, resultaría,
utilizando Paho, en el siguiente código Python:</p>
<pre><code class="language-python">import paho.mqtt.client as mqtt

# Funcion callback invocada cuandl el cliente recibe un CONNACK desde el broker.
def on_connect(client, userdata, flags, rc):
    print(&quot;Connected with result code &quot;+str(rc))

    # Suscribirse en on_connect() asegura que si se pierde la conexión y 
    # se reestablece, las suscripciones se renovarán.
    client.subscribe(&quot;$SYS/#&quot;)

# Funcion callback al recibir un mensaje de publicacion (PUBLISH) desde el 
# broker.
def on_message(client, userdata, msg):
    print(msg.topic+&quot; &quot;+str(msg.payload))

client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message

client.connect(&quot;mqtt.eclipse.org&quot;, 1883, 60)

# Llamada bloqueante que procesa el tráfico de red, invoca callbacks
# y maneja la reconexión al broker. 
client.loop_forever()
</code></pre>
<p>La clase cliente puede utilizarse para:</p>
<ul>
<li>Crear una instancia de cliente MQTT.</li>
<li>Conectar a un <em>broker</em> usando las funciones de la familia <code>connect*()</code>.</li>
<li>Invocar a funciones de la familia <code>loop*()</code> para mantener el tráfico de datos con el servidor.</li>
<li>Utilizar <code>subscribe()</code> para suscribirse a un <em>topic</em> y recibir mensajes.</li>
<li>Utilizar <code>publish()</code> publicar mensajes en el <em>broker</em>.</li>
<li>Utilizar <code>disconnect()</code> para desconectar del <em>broker</em>.</li>
</ul>
<p>Los <em>callbacks</em> se invocarán automáticamente para permitir el procesamiento
de eventos. De entre los más utilizados, destacan:</p>
<ul>
<li><code>ON_CONNECT</code>: invocado cuando el <em>broker</em> responde a nuestra petición de conexión.
Ejemplo:</li>
</ul>
<pre><code class="language-python">def on_connect(client, userdata, flags, rc):
    print(&quot;Connection returned result: &quot;+connack_string(rc))
</code></pre>
<ul>
<li><code>ON_DISCONNECT</code>: invocado cuando el cliente se desconecta del <em>broker</em>.
Ejemplo:</li>
</ul>
<pre><code class="language-python">def on_disconnect(client, userdata, rc):
    if rc != 0:
        print(&quot;Unexpected disconnection.&quot;)
</code></pre>
<ul>
<li><code>ON_MESSAGE</code>: invocado cuando se recibe un mensaje en un <em>topic</em> al que </li>
<li>el cliente está suscrito. 
Ejemplo:</li>
</ul>
<pre><code class="language-python">def on_message(client, userdata, message):
    print(&quot;Received message '&quot; + str(message.payload) + &quot;' on topic '&quot;
        + message.topic + &quot;' with QoS &quot; + str(message.qos))
</code></pre>
<p>Para publicar de forma puntual sobre un <em>broker</em> (sin mantener
una conexión establecida), es posible utilizar la siguiente secuencia de
ordenes:</p>
<pre><code class="language-python">import paho.mqtt.publish as publish

publish.single(&quot;paho/test/single&quot;, &quot;payload&quot;, hostname=&quot;mqtt.eclipse.org&quot;)
</code></pre>
<p>Del mismo modo, podemos suscribirnos de forma puntual mediante una llamada
bloqueante a:</p>
<pre><code class="language-python">import paho.mqtt.subscribe as subscribe

msg = subscribe.simple(&quot;paho/test/simple&quot;, hostname=&quot;mqtt.eclipse.org&quot;)
print(&quot;%s %s&quot; % (msg.topic, msg.payload))
</code></pre>
<p>Toda la información y documentación asociada al módulo puede consultarse
<a href="https://pypi.org/project/paho-mqtt/">aquí</a>.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea entregable</p>
<p>Cada alumno propondrá una solución para monitorizar un edificio inteligente a
través de un sistema de mensajería MQTT. Para ello, cabe destacar que el
edificio constará de:</p>
<ul>
<li>Un identificador del tipo EDIFICIO_TUPUESTODELABORATORIO.</li>
<li>Un conjunto de plantas, identificadas por la cadena "P_NUMPLANTA".</li>
<li>En cada planta, cuatro alas (norte -N-, sur -S-, este -E-, oeste -O-)</li>
<li>En cada ala, un conjunto de salas, identificadas por un valor numérico.</li>
<li>En cada sala, cuatro sensores: TEMP (temperatura), HUM (humedad), LUX (luminosidad), VIBR (vibración).</li>
</ul>
<p>Se pide, en primer lugar, diseñar la jerarquía de <em>topics</em> que permita una correcta 
monitorización de los edificios.</p>
<p>En segundo lugar, se desarrollará un programa Python cliente o un flujo Node-RED que publique, periódicamente
y de forma aleatoria, objetos JSON 
(opcionalmente puedes utilizar CBOR) que incluyan el valor de temperatura, humedad, luminosidad o
vibración para una determinada sala del edificio, elegida también aleatoriamente, a través
del <em>topic</em> correspondiente. Estos mensajes 
estarán espaciados en el tiempo un número aleatorio de segundos (en el caso de Node-RED, se sugiere buscar nodos
que permitan generar números aleatorios para dar soporte a la tarea).</p>
<p>En tercer lugar, se piden las <em>wildcards</em> que permitan consultar distintos tipos de información
jerárquica. Por ejemplo:</p>
<ul>
<li>Todos los mensajes de temperatura para el edificio.</li>
<li>Todos los mensajes de vibración del ala oeste de la planta 2 del edificio.</li>
<li>Todos los mensajes de sensorización de la sala 4 del ala Sur de la planta 7 del edificio.</li>
<li>...</li>
</ul>
<p>En último lugar, se pide desarrollar un programa Python o un flujo Node-RED que actúe a modo de
alarma, y que muestre mensajes sólo si algún valor recibido para los 
datos sensorizados supera un umbral preestablecido. En dicho caso, el programa
mostrará el edificio, planta, ala, sala y sensor que ha producido la alarma, 
junto con su valor numérico.</p>
<p>Puedes utilizar el <a href="https://docs.python.org/3/library/json.html">módulo JSON</a>
para parsear los objetos recibidos en Python, o los nodos correspondientes en Node-RED.</p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
