<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 5 - Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-I</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-I/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P1b/index.md" class="dropdown-item">Práctica 1 (segunda parte)</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-I/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-II</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_III/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5/" class="dropdown-item">Práctica 5 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5_II/" class="dropdown-item">Práctica 5 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">ANIOT</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../ANIOT/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P7/index2/" class="dropdown-item">Práctica 7 (adicional)</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">LSI</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Lab0/" class="dropdown-item">Práctica 0</a>
</li>
                                    
<li>
    <a href="../Lab1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../Lab2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../Lab3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../Lab4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Práctica 5</a>
</li>
                                    
<li>
    <a href="../Lab6/" class="dropdown-item">Práctica 6</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Lab4/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../Lab6/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#laboratorio-5-clasificacion-de-imagenes-y-deteccion-de-objetos-con-el-esp32" class="nav-link">Laboratorio 5. Clasificación de imágenes y detección de objetos con el ESP32</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#esp-dl" class="nav-link">ESP-DL</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#ejecucion-basica-de-un-modelo" class="nav-link">Ejecución básica de un modelo</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#clasificacion-de-imagenes-con-esp-dl" class="nav-link">Clasificación de imágenes con ESP-DL</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#deteccion-de-objetos-con-esp-dl" class="nav-link">Detección de objetos con ESP-DL</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="laboratorio-5-clasificacion-de-imagenes-y-deteccion-de-objetos-con-el-esp32">Laboratorio 5. Clasificación de imágenes y detección de objetos con el ESP32</h1>
<h2 id="objetivos">Objetivos</h2>
<ul>
<li>Entender la estructura y utilidad general del <em>framework</em> ESP-DL.</li>
<li>Experimentar con dos ejemplos básicos de clasificación de imágenes (Mobilenet) y detección de objetos (Yolo).</li>
<li>Comprender y evaluar el rendimiento (en términos de tiempo y precisión) de distintas variantes del modelo Yolo para detección de objetos.</li>
<li>Integrar el proceso de inferencia para detección de objetos en un sistema IoT para emular un entorno de detección de peatones para asistencia a conducción.</li>
</ul>
<h2 id="esp-dl">ESP-DL</h2>
<p><strong>ESP-DL</strong> es un framework ligero y eficiente para la inferencia de redes neuronales, diseñado específicamente para los chips de la serie <strong>ESP</strong>. Con ESP-DL, puedes desarrollar aplicaciones de inteligencia artificial de forma rápida y sencilla utilizando los <strong>System on Chips (SoCs)</strong> de <strong>Espressif</strong>.</p>
<h4 id="vision-general">Visión general</h4>
<p>ESP-DL ofrece <strong>APIs</strong> para cargar, depurar y ejecutar modelos de IA. El framework es fácil de usar y se puede integrar sin problemas con otros SDKs de Espressif. <strong>ESP-PPQ</strong> actúa como la herramienta de cuantización para ESP-DL, siendo capaz de cuantizar modelos procedentes de <strong>ONNX</strong>, <strong>Pytorch</strong> y <strong>TensorFlow</strong>, y exportarlos al formato estándar de modelo de ESP-DL.</p>
<h4 id="formato-de-modelo-esp-dl">Formato de modelo ESP-DL</h4>
<p>Este formato es similar a ONNX pero utiliza <strong>FlatBuffers</strong> en lugar de <strong>Protobuf</strong>, lo que lo hace más ligero y permite una deserialización sin copia (<strong>zero-copy</strong>). Su extensión de archivo es <code>.espdl</code>.</p>
<h4 id="implementacion-eficiente-de-operadores">Implementación eficiente de operadores</h4>
<p>ESP-DL implementa de forma eficiente operadores comunes de IA como <code>Conv</code>, <code>Gemm</code>, <code>Add</code> y <code>Mul</code>.  </p>
<h4 id="planificador-de-memoria-estatico">Planificador de memoria estático</h4>
<p>Este planificador asigna automáticamente las distintas capas a la ubicación de memoria óptima en función del tamaño de RAM interna especificado por el usuario, garantizando una alta velocidad de ejecución general y un uso mínimo de memoria.</p>
<h4 id="planificacion-de-doble-nucleo">Planificación de doble núcleo</h4>
<p>La planificación automática en doble núcleo permite que los operadores de mayor carga computacional aprovechen al máximo la capacidad de cómputo de los dos núcleos. Actualmente, <code>Conv2D</code> y <code>DepthwiseConv2D</code> son compatibles con esta planificación.</p>
<h4 id="activacion-con-lut-de-8-bits">Activación con LUT de 8 bits</h4>
<p>Todas las funciones de activación, excepto <code>ReLU</code> y <code>PReLU</code>, se implementan en ESP-DL mediante una <strong>tabla de búsqueda (LUT)</strong> de 8 bits para acelerar la inferencia. Puedes utilizar cualquier función de activación sin que aumente la complejidad computacional.</p>
<hr />
<p>La figura que se muestra a continuación ilustra la arquitectura general de ESP-DL.</p>
<p><img alt="ESP-DL architecture" src="img/espdl_arch.svg" /></p>
<h4 id="preparacion-del-modelo">Preparación del modelo</h4>
<p>Consulta el <a href="https://github.com/espressif/esp-dl/blob/12397f3/operator_support_state.md">documento de soporte de operadores</a> para asegurarte de que los operadores en un nuevo modelo son compatibles.</p>
<p>ESP-DL requiere el uso de un <strong>formato propietario</strong> para el despliegue de modelos. Los modelos de deep learning deben ser <strong>cuantizados y convertidos</strong> a este formato antes de poder ser utilizados. <strong>ESP-PPQ</strong> (la herramienta de soporte para cuantización) proporciona dos interfaces, <code>espdl_quantize_onnx</code> y <code>espdl_quantize_torch</code>, para admitir la exportación de modelos ONNX y PyTorch, respectivamente.</p>
<p>Otros frameworks de deep learning, como <strong>TensorFlow</strong>, <strong>PaddlePaddle</strong>, etc., deben convertir primero el modelo a <strong>ONNX</strong>. Por lo tanto, asegúrate de que el modelo puede convertirse a formato ONNX.</p>
<p>Para más detalles, consulta:  </p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-dl/en/latest/tutorials/how_to_quantize_model.html">Cómo cuantizar un modelo</a>.</li>
</ul>
<h4 id="despliegue-del-modelo">Despliegue del modelo</h4>
<p>ESP-DL proporciona una serie de <strong>APIs</strong> para cargar y ejecutar modelos de forma rápida. Para más detalles, consulta:</p>
<ul>
<li><a href="https://docs.espressif.com/projects/esp-dl/en/latest/tutorials/how_to_load_test_profile_model.html">Cómo cargar, probar y perfilar un modelo</a>.</li>
<li><a href="https://docs.espressif.com/projects/esp-dl/en/latest/tutorials/how_to_run_model.html">Cómo ejecutar un modelo</a>.</li>
</ul>
<p>En las siguientes secciones, partiremos siempre de modelos ya preparados y ejemplos totalmente funcionales, que deberás adaptar para completar las tareas indicadas en el boletín.</p>
<h2 id="ejecucion-basica-de-un-modelo">Ejecución básica de un modelo</h2>
<p>En primer lugar, clona el proyecto de ESP-DL que puedes encontrar en el <a href="https://github.com/espressif/esp-dl.git">siguiente repositorio</a>. En este primer ejemplo, trabajaremos sobre el directorio <code>examples/tutorial/how_to_run_model</code>, por lo que puedes abrirlo en Visual Studio (utiliza al menos la versión 5.4.1 de ESP-IDF).</p>
<h4 id="obtener-entradas-y-salidas-del-modelo">Obtener entradas y salidas del modelo</h4>
<pre><code class="language-cpp">std::map&lt;std::string, dl::TensorBase *&gt; model_inputs = model-&gt;get_inputs();
dl::TensorBase *model_input = model_inputs.begin()-&gt;second;
std::map&lt;std::string, dl::TensorBase *&gt; model_outputs = model-&gt;get_outputs();
dl::TensorBase *model_output = model_outputs.begin()-&gt;second;
</code></pre>
<p>Puedes obtener los nombres de entrada/salida y sus respectivos objetos <code>dl::TensorBase</code> usando las APIs <code>get_inputs()</code> y <code>get_outputs()</code>.<br />
Para más información, consulta la <a href="../api_reference/tensor_api">documentación de dl::TensorBase</a>.</p>
<blockquote>
<p><strong>Nota:</strong><br />
El gestor de memoria de ESP-DL asigna un único bloque de memoria para las entradas, resultados intermedios y salidas del modelo. Como se comparte esta memoria, durante la inferencia, los resultados posteriores sobrescriben a los anteriores. Es decir, los datos de <code>model_input</code> pueden ser sobrescritos por <code>model_output</code> u otros resultados intermedios una vez finalizada la inferencia.</p>
</blockquote>
<hr />
<h4 id="cuantizar-la-entrada">Cuantizar la entrada</h4>
<p>Los modelos cuantizados a 8 bits y 16 bits aceptan entradas de tipo <code>int8_t</code> y <code>int16_t</code> respectivamente.<br />
Las entradas en coma flotante (<code>float</code>) deben cuantizarse en uno de esos tipos según el <code>exponent</code> antes de pasarlas al modelo.</p>
<h4 id="formula-de-cuantizacion">Fórmula de cuantización</h4>
<div class="arithmatex">\[
Q = \text{Clip} \left( \text{Round} \left( \frac{R}{\text{Scale}} \right), \text{MIN}, \text{MAX} \right)
\]</div>
<div class="arithmatex">\[
\text{Scale} = 2^{\text{Exp}}
\]</div>
<p>Donde:</p>
<ul>
<li><code>R</code> es el número en punto flotante a cuantizar.  </li>
<li><code>Q</code> es el valor entero tras cuantización, recortado al rango [MIN, MAX].  </li>
<li><code>MIN</code>: -128 (8 bits), -32768 (16 bits).  </li>
<li><code>MAX</code>: 127 (8 bits), 32767 (16 bits).</li>
</ul>
<h3 id="cuantizar-un-solo-valor">Cuantizar un solo valor</h3>
<pre><code class="language-cpp">float input_v = VALUE;
// dl::quantize usa el inverso del scale como segundo argumento, por eso usamos DL_RESCALE.
int8_t quant_input_v = dl::quantize&lt;int8_t&gt;(input_v, DL_RESCALE(model_input-&gt;exponent));
</code></pre>
<h4 id="cuantizar-un-dltensorbase">Cuantizar un <code>dl::TensorBase</code></h4>
<pre><code class="language-cpp">// Se asume que input_tensor ya contiene los datos en float.
dl::TensorBase *input_tensor;
model_input-&gt;assign(input_tensor);
</code></pre>
<hr />
<h4 id="descuantizar-la-salida">Descuantizar la salida</h4>
<p>Los modelos cuantizados a 8 o 16 bits devuelven valores de tipo <code>int8_t</code> o <code>int16_t</code>, respectivamente.<br />
Estos valores deben ser descuantizados según el <code>exponent</code> para obtener los resultados en punto flotante.</p>
<h4 id="formula-de-descuantizacion">Fórmula de descuantización</h4>
<div class="arithmatex">\[
R' = Q \times \text{Scale}
\]</div>
<div class="arithmatex">\[
\text{Scale} = 2^{\text{Exp}}
\]</div>
<p>Donde:</p>
<ul>
<li><code>R'</code> es el valor en punto flotante aproximado tras la descuantización.  </li>
<li><code>Q</code> es el valor entero resultante de la cuantización.</li>
</ul>
<h4 id="descuantizar-un-solo-valor">Descuantizar un solo valor</h4>
<pre><code class="language-cpp">int8_t quant_output_v = VALUE;
float output_v = dl::dequantize(quant_output_v, DL_SCALE(model_output-&gt;exponent));
</code></pre>
<h4 id="descuantizar-un-dltensorbase">Descuantizar un <code>dl::TensorBase</code></h4>
<pre><code class="language-cpp">// Crear un TensorBase de tipo float con forma [1, 1]
dl::TensorBase *output_tensor = new dl::TensorBase({1, 1}, nullptr, 0, dl::DATA_TYPE_FLOAT);
output_tensor-&gt;assign(model_output);
</code></pre>
<hr />
<h4 id="inferencia-del-modelo">Inferencia del modelo</h4>
<p>Consulta el ejemplo de proyecto <code>examples/tutorial/how_to_run_model</code>,
específicamente, la API para la ejecución del modelo:</p>
<ul>
<li><code>void dl::Model::run(runtime_mode_t mode)</code></li>
<li><code>void dl::Model::run(TensorBase *input, runtime_mode_t mode)</code></li>
<li><code>void dl::Model::run(std::map&lt;std::string, TensorBase*&gt; &amp;user_inputs, runtime_mode_t mode, std::map&lt;std::string, TensorBase*&gt; user_outputs)</code></li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Estudia la API que se utiliza en el ejemplo para realizar inferencia con ESP-DL. Observa los tres métodos distintos para cuantizar/descuantizar las entradas y salidas del modelo. En el primer método, descomenta las líneas que proporcionan información sobre entrada y salida del modelo, para que se muestren por pantalla. Opcionalmente, temporiza los procesos de inferencia.</p>
</div>
<h2 id="clasificacion-de-imagenes-con-esp-dl">Clasificación de imágenes con ESP-DL</h2>
<p>En este segundo ejemplo, estudiaremos (sin modificar de momento) un código básico de inferencia sobre un modelo 
de clasificación de imágenes (MobilenetV2), similar al que utilizaste en prácticas anteriores sobre el acelerador
Google Coral. Específicamente, abre en Visual Studio Code el ejemplo <code>examples/mobilenetv2_cls</code>, constrúyelo para la placa
ESP-EYE (esp32-s3) y monitoriza la salida. Verás la clasificación de la imagen <code>cat.jpg</code> como perteneciente a una de las
cinco clases de gatos que para las que ha sido entrenado el modelo. </p>
<p>Observa el código del ejemplo:</p>
<pre><code class="language-cpp">#include &quot;esp_log.h&quot;
#include &quot;imagenet_cls.hpp&quot;
#include &quot;bsp/esp-bsp.h&quot;

extern const uint8_t cat_jpg_start[] asm(&quot;_binary_cat_jpg_start&quot;);
extern const uint8_t cat_jpg_end[] asm(&quot;_binary_cat_jpg_end&quot;);
const char *TAG = &quot;mobilenetv2_cls&quot;;

extern &quot;C&quot; void app_main(void)
{
#if CONFIG_IMAGENET_CLS_MODEL_IN_SDCARD
    ESP_ERROR_CHECK(bsp_sdcard_mount());
#endif

    dl::image::jpeg_img_t jpeg_img = {
        .data = (uint8_t *)cat_jpg_start,
        .width = 300,
        .height = 300,
        .data_size = (uint32_t)(cat_jpg_end - cat_jpg_start),
    };
    dl::image::img_t img;
    img.pix_type = dl::image::DL_IMAGE_PIX_TYPE_RGB888;
    sw_decode_jpeg(jpeg_img, img, true);

    ImageNetCls *cls = new ImageNetCls();

    auto &amp;results = cls-&gt;run(img);
    for (const auto &amp;res : results) {
        ESP_LOGI(TAG, &quot;category: %s, score: %f&quot;, res.cat_name, res.score);
    }
    delete cls;
    heap_caps_free(img.data);

#if CONFIG_IMAGENET_CLS_MODEL_IN_SDCARD
    ESP_ERROR_CHECK(bsp_sdcard_unmount());
#endif
}
</code></pre>
<p>Observa que la complejidad del tratamiento de las entradas y salidas del modelo se encapsula en una clase <code>ImageNetCls</code>. Su ejecución sigue la misma lógica que la que vimos anteriormente pare el ejemplo básico:</p>
<pre><code class="language-cpp">dl::image::img_t img = {.data=DATA, .width=WIDTH, .height=HEIGHT, .pix_type=PIX_TYPE};
std::vector&lt;dl::cls::result_t&gt; &amp;res = detect-&gt;run(img);
</code></pre>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Descarga más imágenes similares y observa la salida del modelo. Si te es posible, temporiza la ejecución del mismo y la fase de preparación de la imagen de entrada.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Tarea (opcional)</p>
<p>Modifica el código para que las imágenes se tomen directamente desde la cámara del ESP-EYE.</p>
</div>
<h2 id="deteccion-de-objetos-con-esp-dl">Detección de objetos con ESP-DL</h2>
<p>En este caso, trabajaremos con el ejemplo <code>yolo11_detect</code>, disponible en la distribución de ESP-DL. Ábrelo, compílalo y monitoriza su corrección.</p>
<p>El ejemplo proporciona diversas variantes de modelos (en función del tipo de datos que utilizan), que devolverán disintos niveles de precisión/calidad a cambio de mayor o menor tiempo de ejecución. Estas variantes puede configurarse a través de <em>menuconfig</em> (sección <em>models: coco_detect</em>). 
En todo caso, la salida de un proceso de inferencia deberá ser algo similar a:</p>
<pre><code class="language-sh">I (28477) yolo11n: [category: 0, score: 0.817575, x1: 24, y1: 196, x2: 111, y2: 453]
I (28477) yolo11n: [category: 5, score: 0.731059, x1: 81, y1: 115, x2: 400, y2: 372]
I (28477) yolo11n: [category: 0, score: 0.731059, x1: 112, y1: 203, x2: 171, y2: 429]
I (28487) yolo11n: [category: 0, score: 0.731059, x1: 336, y1: 196, x2: 404, y2: 436]
I (28497) yolo11n: [category: 0, score: 0.320821, x1: 0, y1: 276, x2: 29, y2: 434]
</code></pre>
<p>Esta salida muestra la categoría de cada objeto detectado, su probabilidad de pertenencia a la clase, y la posición del <em>bounding box</em> que lo contiene.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea</p>
<p>Modifica el proyecto para utilizar las distintas variantes del modelo proporcionado, y anota la calidad del proceso de inferencia en términos de precisión y, a ser posible, de tiempo de ejecución.</p>
</div>
<p>Observa que la forma de preparar la entrada y reportar la salida de la ejecución del modelo es también sencilla:</p>
<pre><code class="language-cpp">#include &quot;coco_detect.hpp&quot;
#include &quot;esp_log.h&quot;
#include &quot;bsp/esp-bsp.h&quot;

extern const uint8_t bus_jpg_start[] asm(&quot;_binary_bus_jpg_start&quot;);
extern const uint8_t bus_jpg_end[] asm(&quot;_binary_bus_jpg_end&quot;);
const char *TAG = &quot;yolo11n&quot;;

extern &quot;C&quot; void app_main(void)
{
#if CONFIG_COCO_DETECT_MODEL_IN_SDCARD
    ESP_ERROR_CHECK(bsp_sdcard_mount());
#endif

    dl::image::jpeg_img_t jpeg_img = {
        .data = (uint8_t *)bus_jpg_start,
        .width = 405,
        .height = 540,
        .data_size = (uint32_t)(bus_jpg_end - bus_jpg_start),
    };
    dl::image::img_t img;
    img.pix_type = dl::image::DL_IMAGE_PIX_TYPE_RGB888;
    sw_decode_jpeg(jpeg_img, img, true);

    COCODetect *detect = new COCODetect();
    auto &amp;detect_results = detect-&gt;run(img);
    for (const auto &amp;res : detect_results) {
        ESP_LOGI(TAG,
                 &quot;[category: %d, score: %f, x1: %d, y1: %d, x2: %d, y2: %d]&quot;,
                 res.category,
                 res.score,
                 res.box[0],
                 res.box[1],
                 res.box[2],
                 res.box[3]);
    }
    delete detect;
    heap_caps_free(img.data);

#if CONFIG_COCO_DETECT_MODEL_IN_SDCARD
    ESP_ERROR_CHECK(bsp_sdcard_unmount());
#endif
}
</code></pre>
<div class="admonition danger">
<p class="admonition-title">Tarea entregable (70% de la nota)</p>
<p>Partiendo del proyecto original, y probando con varias imágenes de entrada, vas a emular un sistema de ayuda a la conducción que envíe una alarma al usuario si detecta un peatón en la imagen. Para ello, utilizando MQTT y alguno de los modelos de detección probados, se enviará un mensaje vía MQTT a un broker en la red, cuando se cumplan ciertas condiciones de detección (por ejemplo, un peatón detectado en el centro de la imagen, con una precisión de clasificación superior a un umbral. Esta alarma será recogida por un suscriptor MQTT y reportada al usuario. </p>
</div>
<div class="admonition danger">
<p class="admonition-title">Tarea entregable (15% de la nota)</p>
<p>Usando Node-Red o cualquier otro entorno, investiga la posibilidad de enviar un mensaje mediante algún sistema de mensajería (por ejemplo, Telegram) cuando se reciba un aviso de alerta.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Tarea entregable (15% de la nota)</p>
<p>Modifica el código para que las imágenes se capten periódicamente desde la cámara de tu ESP-EYE. Además de la alerta vía MQTT, se mostrará en el display del ESP-EYE algún tipo de señal de alerta que permita, sin necesidad de uso de MQTT ni de un agente externo, avisar del peligro al conductor.</p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="../../js/mathjax.js"></script>
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
