<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>LAB7. BLE Mesh - Master IoT UCM - Prácticas RPI/ANIOT/LSI (25/26)</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/ANIOT/LSI (25/26)</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-I</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1/" class="dropdown-item">LAB1. Introducción al entorno de desarrollo ESP-IDF</a>
</li>
                                    
<li>
    <a href="../P2/" class="dropdown-item">LAB2. WiFi en el ESP32</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">LAB3. WiFi: provisionamiento y ahorro de energía</a>
</li>
                                    
<li>
    <a href="../P4/" class="dropdown-item">LAB4. ESP WiFi Mesh</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">LAB5. BLE: servidor GATT</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">LAB6. BLE: cliente GATT</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">LAB7. BLE Mesh</a>
</li>
                                    
<li>
    <a href="../P9/" class="dropdown-item">LAB9. 6LoWPAN y simulador Cooja</a>
</li>
                                    
<li>
    <a href="../P10/" class="dropdown-item">LAB10. LoRa y LoRaWan</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-II</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_III/" class="dropdown-item">Práctica 1 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P4/" class="dropdown-item">Práctica 4 (I)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P4_II/" class="dropdown-item">Práctica 4 (II)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">ANIOT</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../ANIOT/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P1b/" class="dropdown-item">Práctica 1b</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P7/index2/" class="dropdown-item">Práctica 7 (adicional)</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P8/" class="dropdown-item">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">LSI</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../LSI/Lab0/" class="dropdown-item">Práctica 0</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../LSI/Lab6/" class="dropdown-item">Práctica 6</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P6/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P9/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#lab7-ble-mesh" class="nav-link">LAB7. BLE Mesh</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#estructura-de-la-practica" class="nav-link">Estructura de la práctica</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#requisitos-previos" class="nav-link">Requisitos previos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#modelo-generico-onoff" class="nav-link">Modelo genérico OnOff</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#modelo-sensor" class="nav-link">Modelo sensor</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="lab7-ble-mesh">LAB7. BLE Mesh</h1>
<h2 id="objetivos">Objetivos</h2>
<ul>
<li>
<p>Poner en práctica los conceptos vistos en teoría en relación a BLE Mesh,
específicamente provisionamiento y modelos cliente/servidor.</p>
</li>
<li>
<p>Desplegar una infraestructura de provisionamiento de un modelo <em>Generic OnOff Server</em>
con provisionamiento desde aplicación móvil para el control remoto de 
encendido/apagado de un LED.</p>
</li>
<li>
<p>Desplegar una infraestructura de provisionamiento de un modelo <em>Generic Sensor</em>
con provisionamiento desde ESP32.</p>
</li>
</ul>
<h2 id="estructura-de-la-practica">Estructura de la práctica</h2>
<p>Esta práctica está dividida en dos partes. En la primera parte trabajaremos un
ejemplo de modelo genérico OnOff en el que se simulará una red domótica con un interruptor y varias luces conectadas a
una red BLE Mesh (o un sólo led RGB). Si disponemos de ellos, podemos conectar
leds a los pines GPIO indicados en el fichero board.h para ver físicamente el
efecto del encendido y apagado de las luces.</p>
<p>En la segunda parte trabajaremos un ejemplo de modelo Sensor, en el que un sensor enviará información de un sensor
virtual (simulado con números aleatorios) a los clientes conectados en la red BLE Mesh.</p>
<h2 id="requisitos-previos">Requisitos previos</h2>
<p>Los códigos que estudiaremos en la práctica se encuentran en el directorio
<code>examples/bluetooth/esp_ble_mesh/onoff_models</code> en el caso del sistema
<em>OnOff</em> (primera parte de la práctica) y en
<code>examples/bluetooth/esp_ble_mesh/sensor_models</code> en el caso del modelo sensor (segunda parte de
la práctica).</p>
<p>Por otro lado, descarga e instala la aplicación <em>nRF Mesh</em> en tu móvil (disponible para Android e iOS).</p>
<h2 id="modelo-generico-onoff">Modelo genérico OnOff</h2>
<h3 id="el-servidor-onoff">El servidor OnOff</h3>
<p>El servidor implementa un único elemento en el cual se integran dos modelos
distintos:</p>
<ol>
<li>Modelo <em>Configuration Server</em>: obligatorio en todo nodo BLE Mesh, implementa la configuración de 
claves (<em>NetKey</em> y <em>AppKey</em>) así como configuraciones genéricas del servidor (suscripciones, tamaño de TTL o funcionalidad de <em>relay</em> de mensajes).</li>
<li>Modelo <em>Generic OnOff Server</em>: implementa la funcionalidad básica de encendido/apagado de una luz.</li>
</ol>
<p>El código en el fichero <code>main.c</code> contiene la funcionalidad básica del servidor,
que podemos resumir en:</p>
<ul>
<li>Inicialización de la pila BLE (<em>bluedroid</em>).</li>
<li>Inicialización de la pila BLE Mesh.</li>
<li>Registro de las funciones de <em>callback</em> para el proceso de provisionamiento y
  del modelo/modelos implementados.</li>
<li>Implementación e inicialización del elemento BLE Mesh.</li>
<li>Implementación e inicialización del modelo <em>Configuration Server</em> y <em>Generic OnOff Server</em>.</li>
<li>Soporte para operaciones <em>Get Opcode</em> y <em>Set Opcode</em> en el modelo de configuración.</li>
</ul>
<h4 id="analisis-basico-del-codigo">Análisis básico del código</h4>
<p>Primero, la tarea principal (<em>app_main</em>) se encarga de la inicialización de las pilas BLE y BLE Mesh:</p>
<pre><code class="language-c">void app_main(void)
{
    esp_err_t err;

    ESP_LOGI(TAG, &quot;Initializing...&quot;);

    board_init();

    err = nvs_flash_init();
    if (err == ESP_ERR_NVS_NO_FREE_PAGES) {
        ESP_ERROR_CHECK(nvs_flash_erase());
        err = nvs_flash_init();
    }
    ESP_ERROR_CHECK(err);

    err = bluetooth_init();
    if (err) {
        ESP_LOGE(TAG, &quot;esp32_bluetooth_init failed (err %d)&quot;, err);
        return;
    }

    ble_mesh_get_dev_uuid(dev_uuid);

    /* Initialize the Bluetooth Mesh Subsystem */
    err = ble_mesh_init();
    if (err) {
        ESP_LOGE(TAG, &quot;Bluetooth mesh init failed (err %d)&quot;, err);
    }
}
</code></pre>
<p>En particular, el código incluye invocaciones a <code>bluetooth_init()</code> y
<code>ble_mesh_init()</code> encargadas de ambas inicializaciones.
La inicialización de la pila BLE Mesh requiere alguna explicación adicional:</p>
<pre><code class="language-c">static esp_err_t ble_mesh_init(void)
{
    esp_err_t err = ESP_OK;

    esp_ble_mesh_register_prov_callback(example_ble_mesh_provisioning_cb);
    esp_ble_mesh_register_config_server_callback(example_ble_mesh_config_server_cb);
    esp_ble_mesh_register_generic_server_callback(example_ble_mesh_generic_server_cb);

    err = esp_ble_mesh_init(&amp;provision, &amp;composition);
    if (err != ESP_OK) {
        ESP_LOGE(TAG, &quot;Failed to initialize mesh stack (err %d)&quot;, err);
        return err;
    }

    err = esp_ble_mesh_node_prov_enable((esp_ble_mesh_prov_bearer_t)(ESP_BLE_MESH_PROV_ADV | ESP_BLE_MESH_PROV_GATT));
    if (err != ESP_OK) {
        ESP_LOGE(TAG, &quot;Failed to enable mesh node (err %d)&quot;, err);
        return err;
    }

    ESP_LOGI(TAG, &quot;BLE Mesh Node initialized&quot;);

    board_led_operation(LED_G, LED_ON);

    return err;
}
</code></pre>
<p>Observa que el código incluye la siguiente funcionalidad:</p>
<ul>
<li>
<p><code>esp_ble_mesh_register_prov_callback(example_ble_mesh_provisioning_cb)</code>: registra la
  función de <em>callback</em> de provisionado en la pila BLE Mesh. Esta función se ejecuta durante
  el proceso de configuración y permite a la pila BLE Mesh generar eventos y
  notificar a la aplicación sobre eventos importantes en el proceso de
  configuración. Los eventos principales que pueden emitirse son:</p>
<ul>
<li><code>ESP_BLE_MESH_PROV_REGISTER_COMP_EVT</code> y <code>ESP_BLE_MESH_NODE_PROV_ENABLE_COMP_EVT</code>:
generados cuando se completa la inicialización de la pila BLE Mesh.
En este punto, el nodo está listo para ser descubierto por un provisionador.</li>
<li><code>ESP_BLE_MESH_NODE_PROV_ENABLE_COMP_EVT</code>: generado cuando </li>
<li><code>ESP_BLE_MESH_NODE_PROV_LINK_OPEN_EVT</code>: generado cuando un provisionador y
  un dispositivo no provisionado establecen un enlace.</li>
<li><code>ESP_BLE_MESH_NODE_PROV_LINK_CLOSE_EVT</code>: generado para notificar a la
  aplicación que se ha roto un enlace con un dispositivo asociado.</li>
<li><code>ESP_BLE_MESH_NODE_PROV_COMPLETE_EVT</code>: recibido por la aplicación cuando
  el proceso de provisionamiento se completa.<br><br></li>
</ul>
</li>
<li>
<p><code>esp_ble_mesh_register_config_server_callback(example_ble_mesh_config_server_cb)</code> y
  <code>esp_ble_mesh_register_generic_server_callback(example_ble_mesh_generic_server_cb)</code>:
  registran las funciones de <em>callback</em> asociadas a los modelos <em>Configuration Server</em> y
  <em>Generic OnOff Server</em>, respectivamente. Centrándonos en la segunda función, el <em>callback</em> se utiliza cuando el
  otro extremo de la comunicación solicita operaciones sobre el modelo, pudiendo emitir los siguientes eventos:</p>
<ul>
<li><code>ESP_BLE_MESH_GENERIC_SERVER_STATE_CHANGE_EVT</code>: generado cuando se produce un cambio en el
estado del modelo (ya sea por recibir un mensaje <em>Set</em> o por un cambio interno).</li>
<li><code>ESP_BLE_MESH_GENERIC_SERVER_RECV_GET_MSG_EVT</code>: generado cuando el servidor recibe un mensaje
<em>Get</em> de un cliente que solicita el estado actual del modelo.</li>
<li><code>ESP_BLE_MESH_GENERIC_SERVER_RECV_SET_MSG_EVT</code>: generado cuando el servidor recibe un mensaje
<em>Set</em> de un cliente que solicita cambiar el estado del modelo.<br><br></li>
</ul>
</li>
<li>
<p><code>esp_ble_mesh_node_prov_enable((esp_ble_mesh_prov_bearer_t)(ESP_BLE_MESH_PROV_ADV | ESP_BLE_MESH_PROV_GATT))</code>:
  activa el proceso de Anuncio y Escaneo, haciendo visible al dispositivo
  para potenciales provisionadores que estén a la escucha.</p>
</li>
<li>
<p><code>board_led_operation(LED_G, LED_ON)</code>: inicializa un hipotético LED RGB, que se
  controlará remotamente.</p>
</li>
</ul>
<p>En este punto, la inicialización de la pila BLE Mesh se ha completado, por
lo que un provisionador podría identificar dispositivos para provisionamiento de
parámetros de red y transmisión de datos.</p>
<h4 id="implementacion-de-la-estructura-ble-mesh-element">Implementación de la estructura BLE Mesh Element</h4>
<p>A continuación, se detallan los pasos necesarios para, en el servidor:</p>
<ul>
<li>Completar la inicialización del sistema.</li>
<li>Añadir un elemento y un modelo.</li>
<li>Elegir distintas implementaciones de encriptación.</li>
<li>Declarar las características de <em>Proxy</em>, <em>Relay</em>, <em>Low Power</em> y <em>Friend</em> del
  nodo.</li>
</ul>
<p>En primer lugar, para declarar y definir un elemento y un modelo asociado,
utilizamos las siguientes estructuras:</p>
<pre><code class="language-c">/** Abstraction that describes a BLE Mesh Element.
 *  This structure is associated with struct bt_mesh_elem in mesh_access.h
 */
typedef struct {
    /** Element Address, assigned during provisioning. */
    uint16_t element_addr;

    /** Location Descriptor (GATT Bluetooth Namespace Descriptors) */
    const uint16_t location;

    const uint8_t sig_model_count;      /*!&lt; SIG Model count */
    const uint8_t vnd_model_count;      /*!&lt; Vendor Model count */

    esp_ble_mesh_model_t *sig_models;   /*!&lt; SIG Models */
    esp_ble_mesh_model_t *vnd_models;   /*!&lt; Vendor Models */
} esp_ble_mesh_elem_t;
</code></pre>
<p>De esta forma podemos mantener la información de los elementos disponibles en el vector
<code>elements</code>:</p>
<pre><code class="language-c">static esp_ble_mesh_elem_t elements[] = {
    ESP_BLE_MESH_ELEMENT(0, root_models, ESP_BLE_MESH_MODEL_NONE),
    ESP_BLE_MESH_ELEMENT(0, extend_model_0, ESP_BLE_MESH_MODEL_NONE),
    ESP_BLE_MESH_ELEMENT(0, extend_model_1, ESP_BLE_MESH_MODEL_NONE),
};
</code></pre>
<p>Donde la macro <code>ESP_BLE_MESH_ELEMENT</code> se utiliza para inicializar los campos
de la estructura <code>esp_ble_mesh_elem_t</code>:</p>
<pre><code class="language-c">#define ESP_BLE_MESH_ELEMENT(_loc, _mods, _vnd_mods)    \
{                                                       \
    .location         = (_loc),                         \
    .sig_model_count  = ARRAY_SIZE(_mods),              \
    .vnd_model_count  = ARRAY_SIZE(_vnd_mods),          \
    .sig_models       = (_mods),                        \
    .vnd_models       = (_vnd_mods),                    \
}
</code></pre>
<p>Los campos incluidos en las estructuras anteriores son:</p>
<ul>
<li><code>element_addr</code>: almacena la dirección de 16 bits del elemento (asignada durante el provisionado).</li>
<li><code>location</code>: descriptor de localización (p.e. interruptor izquierdo o derecho). En este ejemplo se establece a <code>0</code>.</li>
<li><code>sig_model_count</code>: número de modelos SIG estándar contenidos en este elemento.</li>
<li><code>vnd_model_count</code>: número de modelos de fabricante contenidos en este elemento (no estándar).</li>
<li><code>sig_models</code>: puntero al array de modelos SIG ya definidos.</li>
<li><code>vnd_models</code>: puntero al array de modelos de fabricante ya definidos (ninguno en
  nuestro ejemplo, <code>ESP_BLE_MESH_MODEL_NONE</code>).</li>
</ul>
<p>Como vemos, cada elemento usa un array del tipo <code>esp_ble_mesh_model_t</code> para
identificar los modelos implementados por el elemento, como por ejemplo el array <code>root_models</code>:</p>
<pre><code class="language-c">static esp_ble_mesh_model_t root_models[] = {
    ESP_BLE_MESH_MODEL_CFG_SRV(&amp;config_server),
    ESP_BLE_MESH_MODEL_GEN_ONOFF_SRV(&amp;onoff_pub_0, &amp;onoff_server_0),
};
</code></pre>
<p>Distintos modelos requieren diferentes macros. En nuestro caso, ya que vamos a
implementar un modelo <em>Generic OnOff Server</em>, hemos utilizado
<code>ESP_BLE_MESH_MODEL_GEN_ONOFF_SRV</code>.</p>
<h3 id="el-cliente-onoff">El cliente OnOff</h3>
<p>El cliente resulta mucho más sencillo en su funcionamiento. De forma general,
simplemente define un modelo <em>Client OnOff</em> y espera a ser provisionado.
Una vez completado el proceso de provisionamento,
espera a la pulsación de uno de los botones en la placa (<em>BOOT</em>)
para enviar a todos los nodos de la red mesh una solicitud de cambio
en el estado de encendido de las luces.</p>
<p>Concretamente, nos interesan las siguientes definiciones. En el fichero
<code>board.c</code>, observa la respuesta a la pulsación del botón:</p>
<pre><code class="language-c">static void button_tap_cb(void* arg)
{
    ESP_LOGI(TAG, &quot;tap cb (%s)&quot;, (char *)arg);

    example_ble_mesh_send_gen_onoff_set();
}

static void board_button_init(void)
{
    button_handle_t btn_handle = iot_button_create(BUTTON_IO_NUM, BUTTON_ACTIVE_LEVEL);
    if (btn_handle) {
        iot_button_set_evt_cb(btn_handle, BUTTON_CB_RELEASE, button_tap_cb, &quot;RELEASE&quot;);
    }
}

void board_init(void)
{
    board_led_init();
    board_button_init();
}
</code></pre>
<p>La función invocada, <code>example_ble_mesh_send_gen_onoff_set()</code> (definida en el
fichero <code>main.c</code>), realiza el envío de una operación de tipo <em>Set</em> a todos los
miembros de la red mesh:</p>
<pre><code class="language-c">void example_ble_mesh_send_gen_onoff_set(void)
{
    esp_ble_mesh_generic_client_set_state_t set = {0};
    esp_ble_mesh_client_common_param_t common = {0};
    esp_err_t err = ESP_OK;

    common.opcode = ESP_BLE_MESH_MODEL_OP_GEN_ONOFF_SET_UNACK;
    common.model = onoff_client.model;
    common.ctx.net_idx = store.net_idx;
    common.ctx.app_idx = store.app_idx;
    common.ctx.addr = 0xFFFF;   /* to all nodes */
    common.ctx.send_ttl = 3;
    common.msg_timeout = 0;     /* 0 indicates that timeout value from menuconfig will be used */
#if ESP_IDF_VERSION &lt; ESP_IDF_VERSION_VAL(5, 2, 0)
    common.msg_role = ROLE_NODE;
#endif

    set.onoff_set.op_en = false;
    set.onoff_set.onoff = store.onoff;
    set.onoff_set.tid = store.tid++;

    err = esp_ble_mesh_generic_client_set_state(&amp;common, &amp;set);
    if (err) {
        ESP_LOGE(TAG, &quot;Send Generic OnOff Set Unack failed&quot;);
        return;
    }

    store.onoff = !store.onoff;
    mesh_example_info_store(); /* Store proper mesh example info */
}
</code></pre>
<h3 id="provisionamiento-y-control-desde-una-aplicacion-movil">Provisionamiento y control desde una aplicación móvil</h3>
<p>En primer lugar, nos dividiremos en grupos de 3-5 personas. Uno de los integrantes del grupo,
utilizando la aplicación móvil <em>nRF Mesh</em>, actuará como provisionador de la red,
proporcionando las claves de red y aplicación (<em>NetKey</em> y <em>AppKey</em>), así como información básica de red
(por ejemplo, las direcciones unicast). Además, podrá crear grupos de nodos y
suscribir/desuscribir modelos a dichos grupos.</p>
<p>Además, se requiere que uno de vuestros ESP32 actúe como cliente, mientras que el resto
como servidores. De este modo, emularemos una sala por grupo con múltiples luces y un único
interruptor que controlará su estado de encendido/apagado.</p>
<div class="admonition danger">
<p class="admonition-title">Ejercicio 1</p>
<p>Documenta la configuración de la red mesh y el proceso de provisionamiento de nodos que vas a realizar a continuación.</p>
</div>
<ul>
<li><em>PASO 1</em>: en la pestaña <em>Network</em> aparecerán los nodos ya provisionados.
  En nuestro caso, inicialmente ninguno:</li>
</ul>
<p><img alt="" src="img/APP/00_pantalla_inicial.png" /></p>
<ul>
<li><em>PASO 2</em>: pincharemos sobre <em>ADD NODE</em> (o sobre <code>+</code> en iOS), y provisionaremos, uno a uno, todos
  los nodos que queramos que formen parte de nuestra red mesh:</li>
</ul>
<p><img alt="" src="img/APP/01_provisionamiento_inicial.png" /></p>
<ul>
<li><em>PASO 3</em>: antes de provisionar un nodo, lo identificamos presionando en <em>IDENTIFY</em>:</li>
</ul>
<p><img alt="" src="img/APP/02_provisionando_nodo.png" /></p>
<ul>
<li><em>PASO 4</em>: provisionamos el nodo pulsando en <em>PROVISION</em>:</li>
</ul>
<p><img alt="" src="img/APP/03_provisionando_nodo2.png" /></p>
<ul>
<li><em>PASO 5</em>: si todo ha ido bien, se mostrará un mensaje de éxito similar al
  siguiente:</li>
</ul>
<p><img alt="" src="img/APP/04_nodo_provisionado.png" /></p>
<ul>
<li><em>PASO 6</em>: tras repetir este paso con todos los nodos del grupo, veremos
  una pantalla como la siguiente.
  Observa y anota las direcciones unicast de cada nodo provisionado.
  El nodo con un elemento es el cliente OnOff, mientras que los nodos con tres
  elementos son los servidores OnOff:</li>
</ul>
<p><img alt="" src="img/APP/05_nodos_provisionados.png" /></p>
<p>A continuación, generarás un grupo de nodos. Esto permitirá suscribir modelos
a dicho grupo (no son los elementos los que se suscriben) y publicar mensajes
que se enviarán a todos los modelos del grupo.</p>
<ul>
<li><em>PASO 7</em>: en la pestaña <em>Groups</em>, crea un nuevo grupo pulsando <code>+</code>. Asigna el nombre y la
  dirección de grupo de 16 bits que desees, por ejemplo <em>Sala de Estar</em> y <code>0xC000</code>:</li>
</ul>
<p><img alt="" src="img/APP/07_anyadiendo_grupo.png" /></p>
<p>Si todo ha ido bien, verás que en el nuevo grupo aún no hay ningún dispositivo suscrito/asociado.
A continuación, suscribiremos cada modelo servidor y cliente (tipos
<em>Generic OnOff Server</em> y <em>Generic OnOff Client</em>) de los nodos de la red al grupo creado.
Esto lo harás nodo a nodo seleccionando cada nodo en la pestaña <em>Network</em>,
después el elemento, y finalmente el modelo:</p>
<p><img alt="" src="img/APP/08_generic_onoff_client.png" /></p>
<p>Para, a continuación, (1) asociar una clave de aplicación (<em>BIND KEY</em>) y (2) suscribir el modelo
al grupo con <em>SUBSCRIBE</em>:</p>
<p><img alt="" src="img/APP/09_generic_onoff_client_bindkey.png" />
<img alt="" src="img/APP/10_suscrito_sala_estar.png" /></p>
<p>Si vuelves a la pestaña <em>Groups</em> y seleccionas el grupo, verás que aparece una luz por cada servidor/modelo suscrito:</p>
<p><img alt="" src="img/APP/11_estado_sala_estar.png" /></p>
<p>En este punto, si estás monitorizando la salida de todos los ESP32 de tu red mesh, verás que el
estado del LED cambia a petición de la aplicación. Además, verás que también
cambia si presionas el botón <em>BOOT</em> del interruptor (cliente) en la
placa.</p>
<div class="admonition danger">
<p class="admonition-title">Ejercicio 2</p>
<p>El cliente envía, tras presionar el botón <em>BOOT</em>, el mensaje de tipo <em>Set</em> a todos
los nodos de la red. Modifícalo para que únicamente se envíe a los nodos suscritos
al grupo. Prueba a desuscribir uno o varios modelos del grupo y verás cómo ya no reciben los
mensajes de solicitud de cambio de estado. Finalmente, vuelve a suscribir uno de los modelos
desuscritos.</p>
</div>
<h2 id="modelo-sensor">Modelo sensor</h2>
<p>En este ejemplo (<code>examples/bluetooth/esp_ble_mesh/sensor_models</code>), se implementa tanto un cliente
de modelo sensor (que además es provisionador) como un servidor de modelo sensor configurable.</p>
<p>El modelo <em>Sensor Server</em> permite exponer datos de sensores. El modelo <em>Sensor Client</em> se utiliza
para consumir los valores de sensores (<em>Sensor States</em>) expuestos por el servidor:</p>
<ul>
<li>Estado <em>Sensor Descriptor</em>: describe los datos del sensor (ID, tipo, unidad de medida, rango de valores).</li>
<li>Estado <em>Sensor Cadence</em>: controla la frecuencia de actualización de los datos del sensor.</li>
<li>Estado <em>Sensor Settings</em>: controla los parámetros del sensor. Por ejemplo,
  podría indicar su sensibilidad y puede ser ajustado remotamente para
  prevenir que un sensor de movimiento se disparase ante pequeños movimientos.</li>
<li>Estado <em>Sensor Data</em>: contiene los valores reales medidos por el sensor. Realmente,
  representa uno o más pares <em>Property ID</em>-<em>Valor</em>.</li>
<li>Estado <em>Sensor Series Column/Row</em>: sólo utilizado si se considera cada uno de los
  valores como perteneciente a una serie temporal de datos.</li>
</ul>
<p>En el ejemplo <em>sensor_client</em>, el dispositivo actúa tanto de cliente como de provisionador.
Una vez que el dispositivo servidor es provisionado y configurado, los
usuarios pueden presionar el botón <em>BOOT</em> de la placa para enviar una petición al servidor,
el cual responderá con los distintos estados del sensor en orden (<em>Descriptor</em>, <em>Setting</em>, <em>Cadence</em>...).</p>
<p>En el ejemplo <em>sensor_server</em>, el dispositivo no provisonado implementa un modelo
<em>Sensor Server</em>. El servidor soporta dos instancias de estados: la primera
(<em>Property ID 0x0056</em>) representaría la temperatura <em>Indoor</em>; la segunda
(<em>Property ID 0x005B</em>) representaría la temperatura <em>Outdoor</em>. Todos los datos
en estos ejemplos están preinicializados.</p>
<h3 id="puesta-en-marcha">Puesta en marcha</h3>
<p>En primer lugar, arranca un nodo cliente/provisionador y monitoriza
su salida. Cuando un/a compañero/a arranque un nodo servidor, verás que es
provisionado por tu cliente, otorgándole una dirección unicast. Anótala.</p>
<p>El funcionamiento general del ejemplo es el siguiente:</p>
<ol>
<li>El dispositivo A ejecuta el ejemplo <em>sensor_client</em>, mientras que el dispositivo B ejecuta el
  ejemplo <em>sensor_server</em>.</li>
<li>A actúa como provisionador. Cuando detecta el dispositivo no provisionado B,
  inicia el proceso de provisionamiento y le asigna una dirección unicast.</li>
<li>En A, cada pulsación del botón <em>BOOT</em> supondrá una petición al nodo B.</li>
<li>Estas peticiones serán, sucesivamente y en este orden:<ul>
<li><em>Sensor Descriptor</em>.</li>
<li><em>Sensor Cadence</em>.</li>
<li><em>Sensor Settings</em>.</li>
<li><em>Sensor Data</em>.</li>
<li><em>Sensor Series</em>.</li>
</ul>
</li>
</ol>
<div class="admonition danger">
<p class="admonition-title">Ejercicio 3</p>
<p>Estudia el código del cliente y del servidor, y observa a qué nodo se envían
las peticiones desde el cliente, qué operación se solicita en cada
pulsación de botón <em>BOOT</em> y qué datos devuelve el servidor en cada caso.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Ejercicio 4</p>
<p>Modifica el código para que los valores consultados
en cada pulsación del botón <em>BOOT</em> no sean únicamente los del modelo
del último nodo provisonado, sino que se consulten de forma secuencial 
los valores <em>Sensor Data</em> de todos los nodos provisionados.
Así, si hay tres nodos provisionados, cada pulsación devolverá
el valor de <em>Sensor Data</em> de uno de ellos, siguiendo el orden de provisionamiento.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Ejercicio 5</p>
<p>Modifica el código para que ahora sólo se provisione automáticamente a aquellos
nodos autorizados. Aplica el filtro por UUID.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Ejercicio 6</p>
<p>Modifica el código del servidor para que los valores de temperatura cambien
aleatoriamente de forma periódica. Implementa esta funcionalidad mediante
una tarea de FreeRTOS.</p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="../../js/mathjax.js"></script>
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
