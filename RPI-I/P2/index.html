<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 2 - Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI/ANIOT/LSI (24/25)</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Calendario</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-I</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../P1b/index.md" class="dropdown-item">Práctica 1 (segunda parte)</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Práctica 2</a>
</li>
                                    
<li>
    <a href="../P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">RPI-II</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../RPI-II/P1_I/" class="dropdown-item">Práctica 1 (1)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_II/" class="dropdown-item">Práctica 1 (2)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_III/" class="dropdown-item">Práctica 1 (3)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P1_IV/" class="dropdown-item">Práctica 1 (4)</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../RPI-II/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">ANIOT</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../ANIOT/P1/" class="dropdown-item">Práctica 1</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P2/" class="dropdown-item">Práctica 2</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P3/" class="dropdown-item">Práctica 3</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P4/" class="dropdown-item">Práctica 4</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P5/" class="dropdown-item">Práctica 5</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P6/" class="dropdown-item">Práctica 6</a>
</li>
                                    
<li>
    <a href="../../ANIOT/P7/" class="dropdown-item">Práctica 7</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../P1/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../P3/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#practica-2-wifi-en-el-esp32" class="nav-link">Práctica 2. WiFi en el ESP32</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#objetivos" class="nav-link">Objetivos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#introduccion" class="nav-link">Introducción</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#modo-station" class="nav-link">Modo Station</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#modo-punto-de-acceso" class="nav-link">Modo Punto de Acceso</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#modo-combinado-stationpunto-de-acceso" class="nav-link">Modo combinado Station/Punto de Acceso</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#escaneado-de-redes-wifi" class="nav-link">Escaneado de redes WiFi</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#conexion-a-una-red-wpa2-enterprise-eduroam" class="nav-link">Conexión a una red WPA2 Enterprise (eduroam)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-2-wifi-en-el-esp32">Práctica 2. WiFi en el ESP32</h1>
<h2 id="objetivos">Objetivos</h2>
<ul>
<li>Conocer el flujo de trabajo del driver WiFi en ESP-IDF.</li>
<li>Analizar las diferencias entre un <em>firmware</em> desarrollado para trabajar 
en modo <em>station</em> y en modo <em>AP</em>.</li>
<li>Desarrollar un <em>firmware</em> combinado para que funcione en modo AP y <em>station</em>
de forma simultánea.</li>
<li>Conocer los mecanismos de escaneado de redes en ESP-IDF.</li>
<li>Conectar a redes vía WPA2 Enterprise desde el ESP32 (<em>eduroam</em>).</li>
</ul>
<h2 id="introduccion">Introducción</h2>
<p>Las bibliotecas y componentes de soporte WiFi en ESP-IDF proporcionan soporte
para configurar y monitorizar la conexión 802.11 sobre placas ESP32. Este 
soporte incluye configuraciones para:</p>
<ul>
<li>
<p>Modo <code>station</code> (modo cliente WiFi, o <em>STA</em>). 
  En este caso, el ESP32 conecta con un punto de acceso preconfigurado.</p>
</li>
<li>
<p>Modo <code>AP</code> (también denominado <em>softAP</em> o modo <em>Punto de Acceso</em>). En este
  caso, son las estaciones las que conectan al ESP32.</p>
</li>
<li>
<p>Modo combinado AP-STA, donde el ESP32 actúa de forma concurrente como punto de
  acceso (AP) y cliente WiFi conectado a otro punto de acceso (STA).</p>
</li>
<li>
<p>Varios modos de seguridad tanto en modo cliente como en modo AP (WPA,
  WPA2, WEP, etc.)</p>
</li>
<li>
<p>Escaneado de puntos de acceso (activo y pasivo).</p>
</li>
<li>
<p>Provisionamiento de claves y modo WPS.</p>
</li>
<li>
<p>Modo promiscuo para monitorización de paquetes IEEE 802.11.</p>
</li>
</ul>
<p>En la presente práctica, a través de ejemplos básicos, estudiaremos las
características principales soportadas por el driver WiFi sobre el ESP32.
Todas estas características pueden ser utilizadas a posteriori para el 
desarrollo de códigos y proyectos más complejos con mínimas modificaciones.</p>
<h3 id="modelo-de-programacion-del-driver-wifi-en-esp-idf">Modelo de programación del driver WiFi en ESP-IDF</h3>
<p>El modelo de programación del driver WiFi en ESP-IDF sigue un modelo de 
programación sencillo que se puede resumir en la siguiente imagen:</p>
<p><img alt="" src="img/blockdiag.png" /></p>
<p>Puede considerarse que el driver WiFi es una caja negra independiente del resto
de la aplicación, como la pila TCP/IP, las tareas de aplicación y los eventos.
El código de las tareas de aplicación generalmente invoca a la API WiFi para
inicializar el dispositivo inalámbrico y tratar eventos específicos cuando
resulta necesario. El driver WiFi recibe invocaciones a su API, las procesa y
emite eventos a la aplicación. </p>
<p>El tratamiento de eventos WiFi se basa en la <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/esp_event.html">biblioteca de eventos
esp_event</a>;
los eventos se envían por parte del driver al <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/esp_event.html#esp-event-default-loops">bucle de tratamiento de eventos
por
defecto</a>.
La aplicación registra una serie de funciones <em>callback</em>, a través de la función
<code>esp_event_handler_register()</code>, que serán las responsables de tratar estos
eventos. Algún tipo de eventos es también procesado por el componente
<code>esp_netif</code> para proporcionar reacciones por defecto ante su recepción. Por
ejemplo, cuando un dispositivo se conecta a un AP el <code>esp_netif</code> arranca un
cliente DHCP para obtener una dirección IP sin intervención del código de
usuario (aunque este comportamiento por defecto puede ser personalizado para,
por ejemplo, asignar una dirección IP estáticamente).</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Toda la API mencionada a continuación se encuentra descrita en profundidad 
<a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_wifi.html">aquí</a>. Se aconseja disponer de esta información durante el proceso
de desarrollo y también en el propio desarrollo de la práctica.</p>
</div>
<h3 id="eventos-wifi">Eventos WiFi</h3>
<p>Se listan a continuación algunos de los ejemplos más utilizados en la gestión
de conexiones WiFi, que utilizaremos en los ejemplos posteriores.</p>
<ul>
<li>
<p><code>WIFI_EVENT_SCAN_DONE</code></p>
<p>Este evento se envía automáticamente en la invocación de
<code>esp_wifi_scan_start()</code>, en los siguientes escenarios:</p>
<ul>
<li>El escaneado de redes se completa, es decir, se ha encontrado el punto de
  acceso (AP) objetivo.</li>
<li>El escaneado de redes finaliza tras la invocación de <code>esp_wifi_scan_stop()</code>.</li>
<li>Se invoca al inicio de un nuevo escaneo (mediante la rutina
  <code>esp_wifi_scan_start()</code>) antes de finalizar un escaneado previo. Este
  nuevo escaneado se superpondrá al anterior y se emitirá el evento.</li>
</ul>
<p>El evento no se emite cuando el escaneado se fuerza mediante la invocación
a <code>esp_wifi_connect()</code>.</p>
<p>Ante la recepción de este evento, no se lanza ningún proceso específico como
respuesta. La aplicación necesitará invocar normalmente a 
<code>esp_wifi_scan_get_ap_num()</code> y a <code>esp_wifi_scan_get_ap_records()</code> 
para recoger la lista de APs escaneados y  liberar los recursos  (memoria)
que se aloja en el proceso de escaneado.</p>
</li>
<li>
<p><code>WIFI_EVENT_STA_START</code></p>
<p>Este evento se envía cuando, tras la invocación a <code>esp_wifi_start()</code>,
ésta devuelve <code>ESP_OK</code>. Tras la recepción de este evento, se inicializa
la interfaz de red, por lo que normalmente, tras la recepción de este evento
se está listo para invocar a <code>esp_wifi_connect()</code> para comenzar el proceso
de conexión con un punto de acceso (AP).</p>
</li>
<li>
<p><code>WIFI_EVENT_STA_STOP</code></p>
<p>Este evento se envía cuando, tras la invocación a <code>esp_wifi_stop()</code>,
ésta devuelve <code>ESP_OK</code>. Tras la recepción de este evento, se libera la
dirección IP, se detiene el cliente DHCP y se liberan las conexiones
TCP/UDP existentes. Normalmente no se trata desde el punto de vista de la
aplicación.</p>
</li>
<li>
<p><code>WIFI_EVENT_STA_CONNECTED</code></p>
<p>Este evento se envía cuando, tras la invocación a <code>esp_wifi_connect()</code>,
ésta devuelve <code>ESP_OK</code>. Tras la recepción de este evento, arranca un 
cliente DHCP para la obtención de una dirección IP. A continuación,
si todo ha ido bien, el driver WiFi está listo para enviar y recibir
datos.</p>
<p>Dicho instante es el adecuado para comenzar con la lógica de la aplicación,
siempre que ésta no dependa de la correcta obtención de una dirección IP. 
Si este es el caso, será necesario esperar a la obtención de la misma
esperando al evento <code>WIFI_EVENT_STA_GOT_IP</code>.</p>
</li>
<li>
<p><code>WIFI_EVENT_STA_DISCONNECTED</code></p>
<p>Este evento se genera en los siguientes escenarios:</p>
<ul>
<li>Cuando se invoca a las funciones
<code>esp_wifi_disconnect()</code>, <code>esp_wifi_stop()</code>, <code>esp_wifi_deinit()</code> o
<code>esp_wifi_restart()</code> y la estación está conectada al punto de acceso.</li>
<li>Cuando se invoca a <code>esp_wifi_connect()</code>, pero el driver WiFi no 
consigue configurar una conexión con el AP debido a cualquier razón
(por ejemplo, el escaneo no puede encontrar el AP objetivo, el proceso
de autenticación no tiene éxito, etc). Si hay más de un AP con el mismo
SSID, el evento se emite sólo cuando el dispositivo no puede conectar
a ninguno de los APs encontrados.</li>
<li>Cuando la conexión WiFi se interrumpe, por ejemplo porque el dispositivo
pierde N <em>beacons</em> emitidos por el AP, el AP expulsa al dispositivo, el modo
de autenticación cambia, etc.</li>
</ul>
<p>Resulta común que la rutina de tratamiento del evento trate de invocar de
nuevo a la función <code>esp_wifi_connect()</code> para reintentar la conexión.  </p>
</li>
<li>
<p><code>WIFI_EVENT_STA_GOT_IP</code></p>
<p>Este evento se emite cuando el cliente DHCP obtiene una dirección IPv4
desde un servidor DHCP, o cuando se modifica su dirección IPv4. El 
evento significa que todo está listo y que la aplicación puede continuar
con sus tareas (por ejemplo, creación de sockets, inicialización de 
protocolos, etc.)</p>
<p>La dirección IPv4 podría modificarse por alguna de las siguientes razones:</p>
<ul>
<li>El cliente DHCP no puede renovar la dirección IPv4 tras su expiración
(los servidores DHCP suelen conceder direcciones IP durante un tiempo
limitado).</li>
<li>El cliente DHCP se asocia a otra dirección.</li>
<li>Se modifica la dirección IPv4 asignada estáticamente (no vía DHCP).</li>
</ul>
<p>Normalmente, cuando la IP cambia, todos los sockets asociados a ella
quedarán en un estado no utilizable. Así, la recepción de este evento
se suele aprovechar para cerrar y a continuación recrear todos los 
sockets abiertos.</p>
</li>
<li>
<p><code>WIFI_EVENT_STA_LOST_IP</code></p>
<p>Evento emitido cuando una dirección IPv4 se convierte en una dirección
inválida. El evento no se emite inmediatamente tras la desconexión
WiFi, sino que inicializa un temporizador de tipo <em>address lost</em>. Si se
obtiene una IP antes de su expiración, el evento no se emite. En otro
caso, se emite justo en el instante de expirción del temporizador.</p>
<p>Normalmente, las aplicaciones no deben tratar este evento (suele usarse
en tareas de depuración).</p>
</li>
<li>
<p><code>WIFI_EVENT_AP_START</code></p>
<p>Emitido en el inicio de un AP (punto de acceso).</p>
</li>
<li>
<p><code>WIFI_EVENT_AP_STACONNECTED</code></p>
<p>Cuando un dispositivo (<em>station</em>) se conecta a un AP, éste emite el event
<code>WIFI_EVENT_AP_STACONNECTED</code>. Es posible ignorarlo, o aprovecharlo para
obtener información sobre la estación conectada, por ejemplo.</p>
</li>
<li>
<p><code>WIFI_EVENT_AP_STADISCONNECTED</code></p>
<p>Este evento se genera en los siguientes escenarios:</p>
<ul>
<li>La aplicación invoca a <code>esp_wifi_disconnect()</code> o <code>esp_wifi_deauth_sta()</code>
para desconectarla manualmente del punto de acceso.</li>
<li>El driver WiFi expulsa al dispositivo (<em>station</em>), por ejemplo en una
situación en la que el AP no ha recibido paquetes en los últimos minutos.</li>
</ul>
<p>Cuando ocurre este evento, la aplicación necesitaría (idealmente) tomar
las medidas necesarias asociadas al mismo, por ejemplo, cerrar los <em>sockets</em>
abiertos.</p>
</li>
</ul>
<h2 id="modo-station">Modo Station</h2>
<p>La siguiente figura describe, a grandes rasgos, algunos de los escenarios
principales que pueden darse en modo <em>station</em>:</p>
<p><img alt="" src="img/stadiag.png" /></p>
<p>Se analizan a continuación las fases principales en este tipo de <em>firmware</em>
(no todas tienen que estar necesariamente presentes en cualquier escenario).</p>
<p><strong>Fase 1: inicialización WiFi</strong></p>
<ol>
<li>La tarea principal invoca a <code>esp_netif_init()</code> para crear la pila
  IP y realizar las tareas de inicialización pertinentes.</li>
<li>La tarea principal invoca a <code>esp_event_loop_create()</code> para crear e 
  inicializar el sistema de eventos.</li>
<li>La tarea principal invoca a <code>esp_netif_create_default_wifi_sta()</code> para
  crear la interfaz de red que asocia el dispositivo con la pila TCP/IP.</li>
<li>La tarea principal invoca a <code>esp_wifi_init()</code> para crear la tarea que
  manejará la conexión WiFi e inicializa el driver WiFi.</li>
<li>Por último, se invoca (si así se desea, aunque es lo más común) a la
  API para la creación de la tarea o tareas de aplicación.</li>
</ol>
<p>Esta secuencia es la recomendada para la inicialización del sistema de 
  comunicación WiFi, pero no es estrictamente obligatorio seguirla en dicho
  orden o en su totalidad. Por ejemplo, se podría crear directamente una
  tarea de aplicación (paso 5) y realizar la configuración en su cuerpo, o se
  puede diferir su creación hasta la obtención de una dirección IP.</p>
<p><strong>Fase 2: configuración WiFi</strong></p>
<p>Una vez inicializado el driver WiFi, comienza su configuración. En 
este escenario, el modo debe fijarse a <em>station</em> a través de una invocación
a <code>esp_wifi_set_mode(WIFI_MODE_STA)</code>. Es posible invocar a continuación
a otras rutinas de tipo <code>esp_wifi_set_xxx()</code> para configurar parámetros
adicionales (país, ancho de banda, modo de protocolo, ...). 
Para más información sobre los modos de operación (<em>station</em>, <em>AP</em> o
modo combinado <em>station/AP</em>, consulta el siguiente
<a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/wifi.html#wi-fi-mode">enlace</a>).</p>
<p>Generalmente, es necesario configurar el driver WiFi antes de establecer
una conexión, pero no es obligatorio: es posible reconfigurarlo en cualquier
momento, siempre que el driver esté correctamente incializado. En cualquier
caso, si la configuración no tiene que modificarse tras la conexión, es mejor
realizarla en este punto, porque algunos de los parámetros que pueden variar
forzarán una reconexión WiFi, aspecto que es mejor evitar.</p>
<p>La rutina <code>esp_wifi_set_config()</code> permite configurar los aspectos básicos
de la conexión WiFi. Por ejemplo, el código:</p>
<pre><code class="language-c">    wifi_config_t wifi_config = {
        .sta = {
            .ssid = EXAMPLE_ESP_WIFI_SSID,
            .password = EXAMPLE_ESP_WIFI_PASS,
            .threshold.authmode = WIFI_AUTH_WPA2_PSK,

            .pmf_cfg = {
                .capable = true,
                .required = false
            },
        },
    };
    ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA) );
    ESP_ERROR_CHECK(esp_wifi_set_config(ESP_IF_WIFI_STA, &amp;wifi_config) );
</code></pre>
<p>Realiza una configuración básica WiFi proporcionando SSID, contraseña y 
modo de autenticación antes de configurar la conexión.</p>
<p><strong>Fase 3: inicio WiFi</strong></p>
<ol>
<li>Invocación a <code>esp_wifi_start()</code> para iniciar el driver WiFi.</li>
<li>El driver WiFi envia un evento <code>WIFI_EVENT_STA_START</code>, que será tratado
por la tarea de gestión de eventos por defecto para realizar las tareas
necesarias e invocará a la runtina de tratamiento del evento a nivel de 
aplicación.</li>
<li>La aplicación deberá tratar el evento <code>WIFI_EVENT_STA_START</code>, invocando
(se recomienda) a <code>esp_wifi_connect()</code>. </li>
</ol>
<p><strong>Fase 4: conexión WiFi</strong></p>
<ol>
<li>Una vez invocada <code>esp_wifi_connect()</code>, el dirver WiFi comienza un proceso
interno de escaneado/conexión.</li>
<li>Si dicho proceso tiene éxito, se genera un evento <code>WIFI_EVENT_STA_CONNECTED</code>.
Automáticamente se invoca al cliente DHCP y comienza el proceso de obtención de 
dirección IP.</li>
<li>Generalmente, la aplicación no suele responder a este evento, pero podría
por ejemplo imprimirse un mensaje por pantalla a modo de depuración.</li>
</ol>
<p>En el segundo paso, la conexión podría fallar, por ejemplo, si la contraseña
proporcionada es incorrecta. En dicho caso, se envía un evento 
de tipo <code>WIFI_EVENT_STA_DISCONNECTED</code> y se proporcionará la causa del error. 
En el paso 6 se trata este aspecto.</p>
<p><strong>Fase 5: obtención de IP</strong></p>
<ol>
<li>Una vez inicializado el cliente DHCP (paso 4.2) comienza la fase de
     obtención de IP.</li>
<li>Si se recibe con éxito una IP desde el servidor DHCP, se emite un evento de
     tipo <code>IP_EVENT_STA_GOT_IP</code>.</li>
<li>La aplicación tratará este evento. Realmente, en este punto puede comenzar
     la lógica de red de la aplicación, incluyendo, por ejemplo, la creación de
     sockets TCP/UDP. Es imprescindible la recepción de una dirección IP antes
     de la inicialización de sockets.</li>
</ol>
<p><strong>Fase 6: desconexión WiFi</strong></p>
<ol>
<li>Cuando finaliza de forma abrupta una conexión WiFi, por ejemplo al apagar
el punto de acceso (AP), si la calidad de recepción (RSSI) es baja, etc. 
se emite un evento <code>WIFI_EVENT_STA_DISCONNECTED</code>.</li>
<li>La tarea de aplicación debería tratar este evento para, típicamente, 
reintentar la conexión a través de una invocación a <code>esp_wifi_reconnect()</code>.</li>
</ol>
<p><strong>Fase 7: cambio de IP</strong></p>
<ol>
<li>Cuando la dirección IP asignada a un dispositivo cambia, se emite un evento
de tipo <code>IP_EVENT_STA_GOT_IP</code>. Por defecto, y de forma automática, se activa
el campo <code>ip_change</code> de la estructura de tipo <code>ip_event_got_ip_t</code> que acompaña
al evento.</li>
<li>La aplicación debería tomar las medidas necesarias (por ejemplo, recreación
de sockets) para mantenerse en un estado consistente.</li>
</ol>
<p><strong>Fase 8: terminación WiFi</strong></p>
<ol>
<li>Invocación a <code>esp_wifi_disconnect()</code> para desconectar la conexión en marcha.</li>
<li>Invocación a <code>esp_wifi_stop()</code> para parar el driver WiFi.</li>
<li>Invocación a <code>esp_wifi_deinit()</code> para descargar el driver WiFi.</li>
</ol>
<h3 id="analisis-de-un-ejemplo-wifigetting_startedstation">Análisis de un ejemplo (<code>wifi/getting_started/station</code>)</h3>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Analiza el ejemplo <code>station</code>, compílalo y flashealo. Estudia el tratamiento
de eventos que realiza, y cómo estos son emitidos para casos reales. Para
ello, conecta tu ESP32 con un punto de acceso existente, otro inexistente,
apaga el punto de acceso mientras la IP está concedida, y analiza los
eventos generados y su respuesta. </p>
</div>
<div class="admonition danger">
<p class="admonition-title">Entregable 1</p>
<p>Revisa el tratamiento de eventos del código anterior, añade el tratamiento
de los eventos que falten por tratar. Entrega tu código con comentarios
explicando el código añadido.</p>
</div>
<h2 id="modo-punto-de-acceso">Modo Punto de Acceso</h2>
<p>La siguiente figura describe, a grandes rasgos, algunos de los escenarios
principales que pueden darse en modo <em>AP (access point)</em>:</p>
<p><img alt="" src="img/apdiag.png" /></p>
<p>El flujo de trabajo es muy similar al del modo <em>station</em>, con la diferencia
básica del tipo de configuración WiFi a realizar (<code>WIFI_MODE_AP</code>) y obviamente
los parámetros de configuración. Observa el siguiente ejemplo de configuración:</p>
<pre><code class="language-c">    wifi_config_t wifi_config = {
        .ap = {
            .ssid = EXAMPLE_ESP_WIFI_SSID,
            .ssid_len = strlen(EXAMPLE_ESP_WIFI_SSID),
            .channel = EXAMPLE_ESP_WIFI_CHANNEL,
            .password = EXAMPLE_ESP_WIFI_PASS,
            .max_connection = EXAMPLE_MAX_STA_CONN,
            .authmode = WIFI_AUTH_WPA_WPA2_PSK
        },
    };
    if (strlen(EXAMPLE_ESP_WIFI_PASS) == 0) {
        wifi_config.ap.authmode = WIFI_AUTH_OPEN;
    }

    ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_AP));
    ESP_ERROR_CHECK(esp_wifi_set_config(ESP_IF_WIFI_AP, &amp;wifi_config));
</code></pre>
<p>Para más información sobre los parámetros de configuración de un punto 
de acceso, consulta este 
<a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/wifi.html#ap-basic-configuration">enlace</a>.</p>
<h3 id="analisis-de-un-ejemplo-wifigetting_startedsoftap">Análisis de un ejemplo (<code>wifi/getting_started/softAP</code>)</h3>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Analiza el ejemplo <code>softAP</code>, compílalo y flashealo. Estudia el tratamiento
de eventos que realiza, y cómo estos son emitidos para casos reales. Para
ello, conecta distintos clientes (<em>stations</em>), bien sean ESP32 o cualquier
otro dispositivo, y analiza los eventos generados y su respuesta.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Entregable 2</p>
<p>Revisa el tratamiento de eventos del código anterior, añade el tratamiento
de los eventos que falten por tratar. Añade en tu código un comentario
explicando el código añadido.</p>
</div>
<h2 id="modo-combinado-stationpunto-de-acceso">Modo combinado Station/Punto de Acceso</h2>
<p>ESP-IDF soporta un modo mixto de conexión, en el que el ESP32 es a la vez
un punto de acceso (AP) y una estación (<em>station</em>). Este modo se configura
utilizando el parámetro <code>ESP_MODE_APSTA</code> en la invocación a la rutina
<code>esp_wifi_set_mode()</code>.</p>
<p>Además, obviamente el <em>firmware</em> combinado requerirá la creación de dos
estructuras de tipo <code>wifi_config_t</code>, una con los datos asociados al punto
de acceso (campo <code>.ap</code>) y otra con los campos asociados a la 
<em>station</em> (campo <code>.sta</code>). A continuación, será necesario invocar a la rutina
de configuración (<code>esp_wifi_set_config</code>) con cada una de dichas estructuras
(por último, también es necesario invocar a la inicialización de
<code>netif</code> tanto en modo <em>station</em> --<code>esp_netif_create_default_wifi_sta()</code>--
como en modo <em>AP</em> --<code>esp_netif_create_default_wifi_ap()</code>).</p>
<h3 id="ejercicio-desarrollo-de-un-nodo-mixto-stationap">Ejercicio: desarrollo de un nodo mixto <em>station/AP</em></h3>
<div class="admonition danger">
<p class="admonition-title">Entregable 3</p>
<p>Modifica el ejemplo <code>station</code> para que el ESP32 se comporte a la vez 
como estación y como punto de acceso. Añade las opciones de configuración
necesarias para que todos los parámetros se puedan modificar vía 
<code>menuconfig</code>. Comprueba que el ESP32 efectivamente se conecta al punto
de acceso y que a la vez es posible conectar otro dispositivo al mismo
(por ejemplo, tu teléfono móvil). Entrega el código.</p>
</div>
<h2 id="escaneado-de-redes-wifi">Escaneado de redes WiFi</h2>
<h3 id="modos-de-escaneado-de-redes-wifi">Modos de escaneado de redes WiFi</h3>
<p>El modo de escaneo de redes WiFi (es decir, la invocación de la rutina
<code>esp_wifi_scan_start()</code>) sólo está soportada en la actualidad en modo
<em>station</em> o <em>station+AP</em>. En este modo, se da soporte a distintos tipos de
escaneado de redes, véase:</p>
<ul>
<li><strong>Escaneado activo:</strong> El escaneado se desarrolla mediante el envío de paquetes
<em>probe</em> y esperando respuesta, de forma activa.</li>
<li><strong>Escaneado pasivo:</strong> El escaneado se desarrolla simplemente escuchando en 
cada canal y esperando el envío por parte de los APs de paquetes baliza
(<em>beacons</em>). El modo activo o pasivo puede configurarse desde la aplicación, 
mediante el campo <code>scan_type</code> de la estrcutura <code>wifi_scan_config_t</code> (lo verás
en el siguiente ejemplo).</li>
<li><strong>Escaneado en primer plano:</strong>: Se utiliza cuando no hay conexión WiFi activa
en el momento del escaneado. No es, por tanto, directamente configurable.</li>
<li><strong>Escaneado en segundo plano:</strong> Se utiliza cuando hay conexión WiFi activa
en el momento del escaneado. No es, por tanto, directamente configurable.</li>
<li><strong>Escaneado de todos los canales:</strong> Escanea SSIDs en todos los canales. 
La forma de activarlo es mediante el valor <code>0</code> en el campo correspondiente
de <code>wifi_scan_config_t</code>.</li>
<li><strong>Escaneado de canal específico:</strong> Escanea únicamente en un canal. </li>
</ul>
<p>Así, existen 8 modos distintos de escaneado de red WiFi, resultantes de la
combinación de los anteriores modos, llamados:</p>
<ol>
<li><em>All-Channel Background Active Scan.</em></li>
<li><em>All-Channel Background Passive Scan.</em></li>
<li><em>All-Channel Foreground Active Scan.</em></li>
<li><em>All-Channel Foreground Passive Scan.</em></li>
<li><em>Specific-Channel Background Active Scan.</em></li>
<li><em>Specific-Channel Background Passive Scan.</em></li>
<li><em>Specific-Channel Foreground Active Scan.</em></li>
<li><em>Specific-Channel Foreground Passive Scan.</em></li>
</ol>
<h3 id="configuracion-de-escaneado-de-redes-wifi">Configuración de escaneado de redes WiFi</h3>
<p>Para configurar una sesión de escaneado, se utilizan los campos correspondientes
de la estructura de tipo <code>wifi_scan_config_t</code>, proporcionada a la rutina 
<code>esp_wifi_scan_start()</code>, que es la encargada de iniciar la sesión. Los campos
de dicha estructura son:</p>
<ul>
<li><code>ssid</code>: Si SSID no es NULL, sólo se escanea en búsqueda de este <code>ssid</code>.</li>
<li><code>channel</code>: Si es 0, se realiza un escaneado de todos los canales. En caso 
contrario, sólo se escanea el canal especificado.</li>
<li><code>show_hidden</code>: Si es 0, se ignoran los AP con SSID oculto. En caso contrario
se consideran SSIDs normales, y por tanto se muestran.</li>
<li><code>scan_type</code>: Si toma el valor <code>WIFI_SCAN_TYPE_ACTIVE</code> realiza un escaneado 
activo. En cualquier otro caso, el escaneado es pasivo.</li>
<li><code>scan_time</code>: Especifica el tiempo de escaneado por canal.</li>
</ul>
<h3 id="escaneado-de-todos-los-canales-en-primer-plano-ejemplo-de-flujo">Escaneado de todos los canales en primer plano. Ejemplo de flujo</h3>
<p>El siguiente escenario describe un escaneado básico sobre todos los canales en 
primer plano (recuerda que únicamente puede ocurrir en modo <em>station</em> si 
todavía no hay conexión a un AP).</p>
<p><img alt="" src="img/scan_all_diag.png" /></p>
<p><strong>Fase 1: Configuración del escaneado</strong></p>
<ol>
<li>
<p>Se invoca a la rutina <code>esp_wifi_set_country()</code> para establecer el país
donde se está desarrollando el escaneado (opcional).</p>
</li>
<li>
<p>Se invoca a <code>esp_wifi_scan_start()</code> para configurar el escaneado. Para
ello, se utilizan los parámetros por defecto o se configuran tal y como
se ha especificado en la sección anterior.</p>
</li>
</ol>
<p><strong>Fase 2: Fase de escaneado</strong></p>
<ol>
<li>
<p>El driver WiFi cambia al canal 1 y emite (en caso de escaneado activo)
en modo <em>broadcast</em> un paquete de tipo <em>probe request</em>. En caso de escaneado
pasivo, seguirá escuchando en el canal 1 durante un tiempo determinado a la
espera de <em>beacons</em>. En cualquier caso, el valor por defecto de espera es de
120 milisengundos.</p>
</li>
<li>
<p>El driver cambia al canal 2 y repite el proceso. </p>
</li>
<li>
<p>El proceso se repite para N canales, donde N viene configurado según el 
país en el que se lleva a cabo el análisis.</p>
</li>
</ol>
<p><strong>Fase 3: Fase de análisis de resultados</strong></p>
<ol>
<li>
<p>Cuando todos los canales se han escaneado, se emite un evento de tipo
     <code>WIFI_EVENT_SCAN_DONE</code>.</p>
</li>
<li>
<p>La aplicación, a través del <em>callback</em> correspondiente, recibe y procesa
     los resultados. Se invoca a <code>esp_wifi_scan_get_ap_num()</code> para obtener el
     número de APs que se han encontrado. A continuación, reserva memoria para
     este número de entradas e invoca a <code>esp_wifi_scan_get_ap_records()</code> para
     obtener la información de cada AP. </p>
</li>
</ol>
<h3 id="analisis-de-un-ejemplo-wifiscan">Análisis de un ejemplo (<code>wifi/scan</code>)</h3>
<p>Analiza el ejemplo de escaneado <em>wifi/scan</em>, e intenta observar el flujo de
trabajo detallado anteriormente.</p>
<div class="admonition note">
<p class="admonition-title">Tarea</p>
<p>Compila, flashea y ejecuta el ejemplo de escaneado. Observa si los resultados
son los esperados en el laboratorio o en un entorno doméstico. Modifica el 
código para conseguir distintos tipos de escaneado, asegurándote, por ejemplo,
de que si fijas un canal específico en el que tu punto de acceso está trabajando,
éste es detectado corretamente. Estudia y modifica los tiempos de espera en el 
escaneado y observa su efecto en el tiempo total de escaneado.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Entregable 4</p>
<p>Diseña un firmware de nodo que realice un escaneado de las redes
disponibles. Si el nodo detecta la presencia de una o más de las <em>redes
conocidas</em>, se conectará en modo STA a la red de mayor prioridad entre las
conocidas. Probadlo usando como redes conocidas la del laboratorio, vuestro
móvil y vuestro domicilio.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Entregable 5</p>
<p>Codificar el código de la tarea anterior para que la lista de <em>redes
conocidas</em> y la prioridad relativa se puedan configurar con menuconfig.</p>
</div>
<h2 id="conexion-a-una-red-wpa2-enterprise-eduroam">Conexión a una red WPA2 Enterprise (<em>eduroam</em>)</h2>
<p>Las últimas versiones de ESP-IDF permiten la conexión a redes con autenticación
RADIUS, como por ejemplo <em>eduroam</em>. Aunque los detalles de configuración y 
desarrollo de un ejemplo concreto van más allá del objetivo de la práctica, 
es deseable realizar una prueba de conexión a <em>eduroam</em> en el laboratorio, 
ya que nos resultará de utilidad de cara a futuras prácticas. </p>
<p>Para conectar a <em>eduroam</em> nuestro ESP32, necesitaremos seguir los siguientes
pasos:</p>
<ol>
<li>
<p>Descarga el certificado de la CA de la UCM desde 
<a href="https://ssii.ucm.es/file/eduroam">este enlace</a>. Copia el fichero descargado, 
con nombre <code>eduroam.crt</code> al directorio <code>main</code>, y asígnale el nombre <code>wpa2_ca.pem</code>.</p>
</li>
<li>
<p>Configura el proyecto a través de <code>idf.py menuconfig</code> con los siguientes
parámetros:</p>
<ul>
<li>SSID: eduroam</li>
<li>Validate server: activo</li>
<li>EAP method: TTLS</li>
<li>Phase2 method for TTLS: PAP</li>
<li>EAP ID: anonymous@ucm.es</li>
<li>EAP USERNAME: (tu correo UCM)</li>
<li>EAP PASSWORD: (tu contraseña UCM)</li>
</ul>
</li>
</ol>
<div class="admonition danger">
<p class="admonition-title">Entregable 6</p>
<p>Configura el ejemplo de autenticación para WPA2 Enterprise con tus
credenciales de eduroam. Compila y ejecuta el ejemplo de autenticación y
adjunta una captura de pantalla que demuestre la correcta conexión del nodo
a <em>eduroam</em>.</p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
