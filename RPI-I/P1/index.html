<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Práctica 1 - Master IoT UCM - Prácticas RPI</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">Master IoT UCM - Prácticas RPI</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Calendario</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">RPI-I <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li class="active">
    <a href="./">Práctica 1</a>
</li>
                                    
<li >
    <a href="../P2/">Práctica 2</a>
</li>
                                    
<li >
    <a href="../P3/">Práctica 3</a>
</li>
                                    
<li >
    <a href="../P4/">Práctica 4</a>
</li>
                                    
<li >
    <a href="../P5/">Práctica 5</a>
</li>
                                    
<li >
    <a href="../P6/">Práctica 6</a>
</li>
                                    
<li >
    <a href="../P7/">Práctica 7</a>
</li>
                                    
<li >
    <a href="../P8/">Práctica 8</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">RPI-II <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../RPI-II/P1/index.md">Práctica 1</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P6/">Práctica 2 (I)</a>
</li>
                                    
<li >
    <a href="../../RPI-II/P6-II/">Práctica 2 (II)</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">ANIOT <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../ANIOT/P1/">Práctica 1</a>
</li>
                                    
<li >
    <a href="../../ANIOT/P2/">Práctica 2</a>
</li>
                                    
<li >
    <a href="../../ANIOT/P3/">Práctica 3</a>
</li>
                                    
<li >
    <a href="../../ANIOT/P4/">Práctica 4</a>
</li>
                                    
<li >
    <a href="../../ANIOT/P5/">Práctica 5</a>
</li>
                                    
<li >
    <a href="../../ANIOT/P6/">Práctica 6</a>
</li>
                                    
<li >
    <a href="../../ANIOT/P7/">Práctica 7</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../..">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../P2/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#practica-1-introduccion-al-entorno-de-desarrollo-esp-idf">Práctica 1. Introducción al entorno de desarrollo ESP-IDF</a></li>
            <li><a href="#objetivos">Objetivos</a></li>
            <li><a href="#introduccion">Introducción</a></li>
            <li><a href="#flujo-de-trabajo">Flujo de trabajo.</a></li>
            <li><a href="#analisis-de-un-proyecto-sencillo-hola-mundo-en-esp-idf">Análisis de un proyecto sencillo (Hola, mundo) en ESP-IDF</a></li>
            <li><a href="#personalizacion-del-proyecto">Personalización del proyecto</a></li>
            <li><a href="#gestion-de-redes-wifi-ejemplo-1-escaneado-de-redes-wifi">Gestión de redes WiFi. Ejemplo 1. Escaneado de redes WiFi</a></li>
            <li><a href="#gestion-de-redes-wifi-ejemplo-2-gestion-de-eventos-de-red">Gestión de redes WiFi. Ejemplo 2. Gestión de eventos de red</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="practica-1-introduccion-al-entorno-de-desarrollo-esp-idf">Práctica 1. Introducción al entorno de desarrollo ESP-IDF</h1>
<h2 id="objetivos">Objetivos</h2>
<ul>
<li>
<p>Conocer el entorno básico de desarrollo para el ESP32</p>
</li>
<li>
<p>Ser capaz de compilar, <em>flashear</em> y monitorizar proyectos sencillos basados
  en ESP-IDF</p>
</li>
<li>
<p>Entender el funcionamiento básico de una aplicación ESP-IDF que haga uso de
  las capacidades WiFi del ESP32</p>
</li>
<li>
<p>Personalizar variables de configuración de proyectos ESP-IDF</p>
</li>
<li>
<p>Responder a eventos básicos de red en ESP-IDF</p>
</li>
</ul>
<h2 id="introduccion">Introducción</h2>
<p>ESP-IDF (<em>Espressif IoT Development Framework</em>) es el entorno de desarrollo
oficial de Espressif para los SoCs ESP32 y ESP32-S. Este entorno de desarrollo
y conjunto de herramientas permite desarrollar <em>firmwares</em> eficientes para 
dichas placas utilizando las interfaces de comunicación WiFi y Bluetooth, así
como gestionar múltiples características de los SoCs que iremos desgranando 
en futuras prácticas. </p>
<p>ESP-IDF utiliza como base <a href="https://freertos.org">FreeRTOS</a> para la construcción
del <em>firmware</em>, aunque añade multitud de componentes para ofrecer un soporte
de mayor nivel para la interacción con protocolos de comunicación de bajo y 
alto nivel, la mayoría de ellos enfocados al ámbito de comunicación en Internet
de las Cosas.</p>
<p>La presente práctica pretende ser una introducción básica a la puesta en 
marcha del entorno de desarrollo ESP-IDF sobre un sistema operativo Linux.
Además, veremos de forma superficial la estructura básica de un programa
sencillo desarrollado usando ESP-IDF, así como ejemplos básicos para la puesta
en marcha de la interfaz WiFi sobre una placa ESP32.</p>
<p>!!! "Recuerda" La presente práctica no tiene tarea entregable asociada más allá
    de un informe justificativo del trabajo realizado. Por tanto, recuerda
    apuntar y reportar los pasos y tareas realizadas durante su desarrollo para
    plasmarlas en tu informe.</p>
<h2 id="flujo-de-trabajo">Flujo de trabajo.</h2>
<h3 id="actualizacion-del-sistema">Actualización del sistema</h3>
<p>Antes de instalar nuevo software es conveniente actualizar el sistema de la
máquina virtual. Para ello abrimos un terminal virtual (ventana de comandos) y
escribimos los siguientes comandos:</p>
<pre><code class="sh">sudo apt update
sudo apt full-upgrade
</code></pre>

<p>Esperamos a que se actualice la máquina, puede tomar unos minutos.</p>
<h3 id="instalacion-de-prerequisitos">Instalación de prerequisitos</h3>
<p>ESP-IDF requiere ciertos paquetes software instalados en el sistema para poder
desarrollar los códigos y descargarlos sobre el ESP32. Se muestran a 
continuación los requisitos y modo de instalación para máquinas Ubuntu/Debian
(como la máquina virtual del curso), aunque la documentación de ESP-IDF
incluye instrucciones para otras distribuciones y sistemas operativos, 
incluyendo Windows y MacOS.</p>
<p>En tu máquina virtual, instala como superusuario (root) los paquetes necesarios
utilizando:</p>
<pre><code class="sh">sudo apt install git wget flex bison gperf python python3-pip python-setuptools cmake ninja-build ccache libffi-dev libssl-dev dfu-util
</code></pre>

<p>Además, es necesario, en todo caso, que el usuario que estés utilizando
pertenezca al grupo <code>dialout</code>. Para ello puedes editar el fichero <code>/etc/group</code>
añadiendo a tu usuario a la línea que indica el grupo correspondiente, e
iniciando de nuevo tu sesión, o puedes utilizar el comando adduser:</p>
<pre><code class="sh">sudo adduser ubuntu dialout
</code></pre>

<p>Después tendrás que salir de la sesión y volver a entrar para que el nuevo grupo
esté tenido en cuenta.</p>
<p>Instala y configura Python 3 para su uso por defecto en tu 
distribución:</p>
<pre><code class="sh">sudo apt install python3 python3-pip python3-setuptools
sudo apt install python-is-python3
</code></pre>

<h3 id="obtencion-de-esp-idf">Obtención de ESP-IDF</h3>
<p>Utilizaremos las versiones de ESP-IDF a obtener directamente desde el 
repositorio Github oficial (concretamente, en su versión 4.1). Para ello,
ejecuta desde tu directorio de inicio:</p>
<pre><code class="sh">mkdir -p ~/esp
cd ~/esp
git clone --recursive https://github.com/espressif/esp-idf.git
cd esp-idf
git fetch
git checkout release/v4.1
git pull
git submodule update --init --recursive
</code></pre>

<h3 id="instalacion-de-herramientas-adicionales">Instalación de herramientas adicionales</h3>
<p>Desde el directorio <code>esp-idf</code>, ejecuta el script <code>install.sh</code> para instalar
las herramientas (<em>toolchain</em>) específicas para tu versión:</p>
<pre><code class="sh">sh install.sh
</code></pre>

<h3 id="preparacion-del-entorno">Preparación del entorno</h3>
<p>Tras el inicio de cada sesión, deberás establecer valores correctos para ciertas
variables de entorno. Afortunadamente, se proporciona un script (<code>export.sh</code>)
que te permitirá establecerlas de forma automática:</p>
<pre><code class="sh">source export.sh
</code></pre>

<p>Puedes añadir esta línea en cualquier fichero de inicio de sesión para no tener
que ejecutar el comando cada vez. Por ejemplo, puedes editar el fichero
$HOME/.bashrc, y añadir al final de dicho fichero la línea:</p>
<pre><code class="sh">source $HOME/esp/esp-idf/export.sh
</code></pre>

<p>En cualquier caso, en este punto deberías tener acceso a un programa llamado
<code>idf.py</code>, a través del cual gestionaremos el flujo de trabajo. Compruébalo y 
observa si la version de IDF con la que estás trabajando es efectivamente la
4.1 (el número de subversión podría variar en tu salida):</p>
<pre><code class="sh">$ idf.py --version
ESP-IDF v4.1-332-g7b7c64107
</code></pre>

<h3 id="preparacion-del-proyecto">Preparación del proyecto</h3>
<p>En esta primera parte, nos basaremos en un ejemplo sencillo de código
desarrollado en base a ESP-IDF. No es el objetivo de esta práctica analizar en
detalle los la estructura de dicho código (al menos de momento), sino utilizarlo
para ilustrar el flujo de trabajo típico en un proyecto ESP-IDF.</p>
<p>!!! "Recuerda"
    Tras la ejecución del script <code>export.sh</code>, tendrás definida una variable
    de entorno llamada <code>IDF_PATH</code>. Consulta su valor y comprueba que apunta,
    efectivamente, al directorio de instalación de IDF. La utilizaremos a 
    partir de ahora para referirnos a él.</p>
<p>Para empezar, toma el ejemplo <code>hello_world</code> proporcionado como parte de la
instalación básica de IDF, y cópialo en cualquier directorio del sistema de
ficheros:</p>
<pre><code class="sh">cp -R $IDF_PATH/examples/get-started/hello_world $HOME/
cd $HOME/hello_world
</code></pre>

<h3 id="compilacion">Compilación</h3>
<p>El proceso de compilación básico utiliza el script <code>idf.py</code>:</p>
<pre><code class="sh">idf.py build
</code></pre>

<p>Si todo ha ido bien, en el directorio <code>build</code> se habrán generado los objetos
y binarios listos para ser <em>flasheados</em> en el ESP32.</p>
<h3 id="volcado-a-memoria-flash-flasheado">Volcado a memoria flash (<em>Flasheado</em>)</h3>
<p>El proceso de <em>flasheado</em> básico utiliza el script <code>idf.py</code>:</p>
<pre><code class="sh">idf.py -p PUERTO flash
</code></pre>

<p>En este punto, el ESP32 debe estar conectado utilizando el cable microUSB, y si
estás trabajando en una máquina virtual, debe haberse hecho visible a la misma
(por ejemplo, en VirtualBox, a través del menú <em>Dispositivos-&gt;USB-&gt;Silicon Labs
USB to UART Bridge Controller</em>).</p>
<p>En todo caso, la salida del comando <code>dmesg</code> tras la conexión del dispositivo 
te proporcionará información sobre el PUERTO que debes utilizar en el proceso
de <em>flasheado</em> y montorización posterior.</p>
<h3 id="monitorizacion">Monitorización</h3>
<p>Si todo ha ido bien, el proceso de monitorización nos permitirá observar la
salida del programa que tenemos ejecutando en la placa. Para ello, de nuevo,
usamos el <em>script</em> <code>idf.py</code>:</p>
<pre><code class="sh">idf.py -p PUERTO monitor
</code></pre>

<p>!!! "Nota"
    Comprueba que, efectivamente, puedes realizar el proceso de compilación,
    <em>flasheado</em> y monitorización del programa sobre la placa ESP32. Recuerda
    que el botón <code>EN</code>, justo al lado del conector microUSB, forzará un 
    reseteo de la misma.</p>
<h2 id="analisis-de-un-proyecto-sencillo-hola-mundo-en-esp-idf">Análisis de un proyecto sencillo (<em>Hola, mundo</em>) en ESP-IDF</h2>
<p>Observa la estructura general del directorio <code>hello_world</code> que compilaste
anteriormente. Específicamente, nos interesará inspeccionar la estructura
básica de un programa principal para ESP-IDF, en este caso <code>hello_world_main.c</code>.</p>
<pre><code class="c">#include &lt;stdio.h&gt;
#include &quot;sdkconfig.h&quot;
#include &quot;freertos/FreeRTOS.h&quot;
#include &quot;freertos/task.h&quot;
#include &quot;esp_system.h&quot;
#include &quot;esp_spi_flash.h&quot;

void app_main(void)
{
    printf(&quot;Hello world!\n&quot;);

    /* Print chip information */
    esp_chip_info_t chip_info;
    esp_chip_info(&amp;chip_info);
    printf(&quot;This is %s chip with %d CPU cores, WiFi%s%s, &quot;,
            CONFIG_IDF_TARGET,
            chip_info.cores,
            (chip_info.features &amp; CHIP_FEATURE_BT) ? &quot;/BT&quot; : &quot;&quot;,
            (chip_info.features &amp; CHIP_FEATURE_BLE) ? &quot;/BLE&quot; : &quot;&quot;);

    printf(&quot;silicon revision %d, &quot;, chip_info.revision);

    printf(&quot;%dMB %s flash\n&quot;, spi_flash_get_chip_size() / (1024 * 1024),
            (chip_info.features &amp; CHIP_FEATURE_EMB_FLASH) ? &quot;embedded&quot; : &quot;external&quot;);

    printf(&quot;Minimum free heap size: %d bytes\n&quot;, esp_get_minimum_free_heap_size());

    for (int i = 10; i &gt;= 0; i--) {
        printf(&quot;Restarting in %d seconds...\n&quot;, i);
        vTaskDelay(1000 / portTICK_PERIOD_MS);
    }
    printf(&quot;Restarting now.\n&quot;);
    fflush(stdout);
    esp_restart();
}
</code></pre>

<p>A alto nivel, la función <code>app_main</code> es el punto de entrada a todo programa
desarrollado usando ESP-IDF. De modo más específico, tras la <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/general-notes.html">carga del
sistema</a>,
la llamada <em>tarea principal</em> (<em>main task</em>) ejecuta el código proporcionado por
el usuario e implementado en la función <code>app_main</code>. Tanto el tamaño de pila
asignado como la prioridad de esta tarea puede ser configuradas por el
desarrollador a través del sistema de configuración de ESP-IDF (lo veremos más
adelante). Normalmente, esta función se utiliza para llevar a cabo tareas
iniciales de configuración o para crear y lanzar a ejecución otras tareas. De
cualquier modo (como es el caso), se puede implementar cualquier funcionalidad
dentro de la función <code>app_main</code>.</p>
<p>En este ejemplo, se muestra en primer lugar información genérica sobre el SoC
que está ejecutando el <em>firmware</em>:</p>
<pre><code class="c">/* Print chip information */
    esp_chip_info_t chip_info;
    esp_chip_info(&amp;chip_info);
    printf(&quot;This is %s chip with %d CPU cores, WiFi%s%s, &quot;,
            CONFIG_IDF_TARGET,
            chip_info.cores,
            (chip_info.features &amp; CHIP_FEATURE_BT) ? &quot;/BT&quot; : &quot;&quot;,
            (chip_info.features &amp; CHIP_FEATURE_BLE) ? &quot;/BLE&quot; : &quot;&quot;);

    printf(&quot;silicon revision %d, &quot;, chip_info.revision);

    printf(&quot;%dMB %s flash\n&quot;, spi_flash_get_chip_size() / (1024 * 1024),
            (chip_info.features &amp; CHIP_FEATURE_EMB_FLASH) ? &quot;embedded&quot; : &quot;external&quot;);

    printf(&quot;Minimum free heap size: %d bytes\n&quot;, esp_get_minimum_free_heap_size());
</code></pre>

<p>A continuación, dentro de un bucle sencillo, el sistema muestra un mensaje y
difiere la ejecución de la tarea durante un período determinado de tiempo
utilizando la función <a href="https://www.freertos.org/a00127.html">vTaskDelay</a> de
FreeRTOS. Esta función recibe el número de <em>ticks</em> de reloj que se desea
utilizar, por lo que el tiempo real que la tarea diferirá su ejecución depende
de la duración de dicho <em>tick</em>. Por ello,  la constante <code>portTIC_PERIOD_MS</code>
puede utilizarse para calcular dicho tiempo:</p>
<pre><code class="c">    for (int i = 10; i &gt;= 0; i--) {
        printf(&quot;Restarting in %d seconds...\n&quot;, i);
        vTaskDelay(1000 / portTICK_PERIOD_MS);
    }
</code></pre>

<p>Finalmente, la tarea reinicia el sistema tras la finalización de la tarea
principal:</p>
<pre><code class="c">    printf(&quot;Restarting now.\n&quot;);
    fflush(stdout);
    esp_restart();
</code></pre>

<div class="admonition danger">
<p class="admonition-title">Tarea Básica</p>
<p>Modifica el período de suspensión de la tarea para que sea mayor o menor, y
comprueba que efectivamente esto modifica el comportamiento del <em>firmware</em>
cargado. Modifica el programa para que se compruebe debidamente si el SoC
tiene capacidades WiFi (para ello, puedes consultar <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/system.html#_CPPv415esp_chip_info_t">la siguiente
página</a>).</p>
</div>
<h3 id="creacion-de-tareas">Creación de tareas</h3>
<p>El anterior proyecto puede replantearse para que no sea la tarea principal la
que ejecute la lógica del programa. Para ello, es necesario introducir
brevemente la API básica para gestión (en nuestro caso, creación) de tareas.
Verás muchos más detalles sobre esta API en la asignatura ANIOT, por lo que no
veremos aquí más detalles de los estrictamente necesarios. </p>
<p>La función <code>xTaskCreate</code> (incluida en <code>task.h</code>) permite la creación de nuevas
tareas:</p>
<pre><code class="c"> BaseType_t xTaskCreate( TaskFunction_t pvTaskCode,
                         const char * const pcName,
                         configSTACK_DEPTH_TYPE usStackDepth,
                         void *pvParameters,
                         UBaseType_t uxPriority,
                         TaskHandle_t *pxCreatedTask
                        );
</code></pre>

<p>Concretamente, crea una nueva tarea y la añade a la lista de tareas listas para
ejecución, recibiendo como parámetros:</p>
<ul>
<li><code>pvTaskCode</code>: Puntero a la función de entrada para la tarea. Las tareas suelen
    implementarse como un bucle infinito, y no debería, en su cuerpo, retornar
    o simplemente finalizar abruptamente. En cambio, una tarea puede ser 
    destruida externamente a través de su manejador (último parámetro en 
    la creación), o internamente (desde el propio código de la tarea), tal y 
    como se muestra en el siguiente ejemplo extraído directamente desde la
    documentación de FreeRTOS:</li>
</ul>
<pre><code class="c"> void vATaskFunction( void *pvParameters )
    {
        for( ;; )
        {
            -- Task application code here. --
        }

        /* Tasks must not attempt to return from their implementing
        function or otherwise exit.  In newer FreeRTOS ports
        attempting to do so will result in an configASSERT() being
        called if it is defined.  If it is necessary for a task to
        exit then have the task call vTaskDelete( NULL ) to ensure
        its exit is clean. */
        vTaskDelete( NULL );
    }
</code></pre>

<ul>
<li>
<p><code>pcName</code>: Nombre (en forma de cadena) descriptivo de la tarea a ejecutar,
  típicamente usado en tiempo de depuración.</p>
</li>
<li>
<p><code>usStackDepth</code>: Número de palabras a alojar para utilizar como pila para la
    tarea.</p>
</li>
<li>
<p><code>pvParameters</code>: Parámetros a proporcionar a la función de entrada para la
    tarea.</p>
</li>
<li>
<p><code>uxPriority</code>: Prioridad asignada a la tarea.</p>
</li>
<li>
<p><code>pxCreatedTask</code>: Manejador opcional para la tarea.</p>
</li>
</ul>
<p>Así, la funcionalidad del programa <code>Hola, mundo</code> que hemos analizado
anteriormente, podría reestrcturarse en base a una única tarea:</p>
<pre><code class="c">void hello_task(void *pvParameter)
{
    printf(&quot;Hello world!\n&quot;);
    for (int i = 10; i &gt;= 0; i--) {
        printf(&quot;Restarting in %d seconds...\n&quot;, i);
        vTaskDelay(1000 / portTICK_RATE_MS);
    }
    printf(&quot;Restarting now.\n&quot;);
    fflush(stdout);
    esp_restart();
}
</code></pre>

<p>Que podría ser creada desde la tarea principal:</p>
<pre><code class="c">void app_main()
{
    nvs_flash_init();
    xTaskCreate( &amp;hello_task, &quot;hello_task&quot;, 2048, NULL, 5, NULL );
}
</code></pre>

<div class="admonition danger">
<p class="admonition-title">Tarea Adicional</p>
<p>Implementa una modificación del programa <code>hello_world</code> que implemente
y planifique dos tareas independientes con distinta funcionalidad (en este
caso, es suficiente con mostrar por pantalla algún mensaje) y distintos
tiempos de suspensión. Comprueba que, efectivamente, ambas tareas se 
ejecutan concurrentemente.</p>
</div>
<h2 id="personalizacion-del-proyecto">Personalización del proyecto</h2>
<p>ESP-IDF utiliza la biblioteca <code>kconfiglib</code> para proporcionar un sistema de 
configuracion de proyectos en tiempo de compilación sencillo y extensible. Para
ilustrar su funcionamiento, utilizaremos el ejemplo <code>blink</code> que puedes encontrar
en la distribución de ESP-IDF que has clonado anteriormente (copia el ejemplo
en cualquier punto de tu jerarquía de directorios antes de comenzar). </p>
<p>Para configurar un proyecto ESP-IDF, simplemente utiliza la siguiente orden:</p>
<pre><code class="sh">idf.py menuconfig
</code></pre>

<p>La ejecución de la orden anterior te permitirá navegar por un conjunto de
opciones de carácter general, que te permitirán configurar las características
específicas del proyecto a compilar (por ejemplo, seleccionando los componentes
que deseas habilitar en la construcción del mismo).</p>
<div class="admonition danger">
<p class="admonition-title">Tarea Básica</p>
<p>Navega por las opciones que aparecen en los menús de configuración para
familiarizarte con ellos. Los utilizarás en futuras prácticas. Describe su
uso en el informe de la práctica.</p>
</div>
<p>En el proyecto <code>blink</code>, observa que una de las opciones del menú de navegación,
llamada <em>Example configuration</em>, incluye una opción llamada <em>Blink GPIO number</em>.
Más allá de su funcionalidad (define el número de pin GPIO a activar/desactivar
para iluminar un LED), es de interés para nosotros el hecho de que esta opción
de configuración definirá en tiempo de compilación el valor de una constante 
(en este caso <code>CONFIG_BLINK_GPIO</code>) que podemos utilizar directamente en cualquier
fichero de nuestro proyecto. </p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Observa el uso que da el código del proyecto <code>blink</code> a la constante 
<code>CONFIG_BLINK_GPIO</code>.</p>
</div>
<p>Esta opción de configuración no forma parte de las opciones por defecto de 
ESP-IDF, sino que ha sido añadida por los desarrolladores del proyecto <code>blink</code>.
Observa y estudia el formato y contenido del fichero <code>main/Kconfig.projbuild</code>
que se proporciona como parte del fichero. En él, se definen las características
(nombre, rango, valor por defecto y descripcion) de la opción de configuración
a definir.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea Básica</p>
<p>Modifica el proyecto <code>hello_world</code> para que defina dos opciones de
configuración que permitirán definir el tiempo de espera de cada una de las
dos tareas que hayas definido en tu anterior solución. Haz uso de ellas en
tu código y comprueba que efectivamente su modificación a través del sistema
de menús permite una personalización del comportamiento de tus códigos.</p>
</div>
<h2 id="gestion-de-redes-wifi-ejemplo-1-escaneado-de-redes-wifi">Gestión de redes WiFi. Ejemplo 1. Escaneado de redes WiFi</h2>
<p>A modo de ejemplo, y en preparación para los códigos con los que trabajaremos
en futuras prácticas,  vamos a analizar a continuación un ejemplo concreto de
<em>firmware</em> cuya tarea es el escaneado de redes inalámbricas al alcance del ESP32,
y su reporte a través del puerto serie del mismo. Para cada red escaneada, se
reportarán sus características principales.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea Básica</p>
<p>Compila, flashea y monitoriza el ejemplo <code>scan</code> situado en el directorio
<code>examples/wifi/scan</code>. Recuerda copiarlo antes a cualquier otro directorio
de trabajo. Antes de compilarlo, modifica el número máximo de redes a
escanear a través del menú de configuración del ejemplo para ampliarlo a 20.
Crea un punto de acceso WiFi con tu teléfono móvil y observa que,
efectivamente, es escaneado por el ejemplo.</p>
</div>
<p>Observa su funcionamiento. El <em>firmware</em> simplemente escanea un subconjunto de
las redes disponibles, reportando algunas de sus características (por ejemplo,
SSID, modo de autenticación o canal primario). </p>
<div class="admonition danger">
<p class="admonition-title">Tarea Adicional</p>
<p>Analiza el código de la función <code>wifi_scan</code> (tarea principal).
Céntrate especialmente en las líneas que permiten activar y configurar el
escaneado de redes. Intenta entender el funcionamiento general del programa,
consultando y apuntando el cometido de cada línea, con especial interés a
aquellas funciones con prefijo <code>esp_wifi_*</code>. Anota en tu informe de la
práctica el cometido de cada una de ellas, consultando la <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/network/esp_wifi.html">documentación
oficial</a>.</p>
</div>
<h2 id="gestion-de-redes-wifi-ejemplo-2-gestion-de-eventos-de-red">Gestión de redes WiFi. Ejemplo 2. Gestión de eventos de red</h2>
<p>El segundo ejemplo consiste en la creación de un <em>firmware</em> para conexión del 
ESP32 a un punto de acceso existente. Este ejemplo nos permitirá observar, a 
grandes rasgos, el sistema de gestión de eventos en FreeRTOS/ESP-IDF, que
estudiarás en más detalle en ANIOT y que permite gestionar, entre otros, las
respuestas a eventos de red, como por ejemplo la obtención de dirección IP
o la conexión exitosa a un punto de acceso.</p>
<div class="admonition danger">
<p class="admonition-title">Tarea Básica</p>
<p>Compila, flashea y monitoriza el ejemplo <code>station</code> situado en el directorio
<code>examples/wifi/getting_started</code>. Recuerda copiarlo antes a tu directorio de
trabajo. Antes de compilarlo, modifica el SSID de la red al que conectará,
así como la contraseña elegida (puedes usar el mismo punto de acceso que
creaste anteriormente como objetivo de tu conexión) a través del sistema de
menús de configuración.</p>
</div>
<p>Observa su funcionamiento. El <em>firmware</em> simplemente inicializa el dispositivo
en modo <em>station</em> (en contraposición al modo <em>Access Point</em>, que veremos en 
la próxima sesión), realizando una conexión al punto de acceso preconfigurado
a través del menú de configuración.</p>
<p>Analiza el código de la función <code>wifi_init_sta</code>. Esta función, que implementa
la tarea principal, se divide básicamente en dos partes:</p>
<ul>
<li><strong>Gestión de eventos</strong>. Observa el mecanismo mediante el cual se registra
y se asocia la recepción de un evento a la ejecución de un manejador o función
determinada.</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Tarea Adicional</p>
<p>Responde a la siguiente pregunta de forma razonada:
¿Qué eventos se asocian a la ejecución de qué función en el <em>firmware</em> que
estás estudiando?</p>
</div>
<ul>
<li><strong>Configuración de la conexión a un punto de acceso</strong>. La configuración de la
  conexión se realiza a través de los campos correspondientes de una estructura
  de tipo <code>wifi_config_t</code>. Observa los campos básicos que necesita, cómo fuerza
  el uso de WPA2 y cómo recoge los datos de conexión (SSID y contraseña) a
  través del sistema de configuración. Observa también cómo, una vez realizadas
  dichas personalizaciones, inicializa el sistema de comunicación inalámbrica a
  través de <code>esp_wifi_start()</code>. Consulta la documentación relativa a dichas
  funciones y anota en tu informe aquellos aspectos que consideres más
  relevantes.</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Tarea Adicional</p>
<p>Modifica el <em>firmware</em> para que el <em>handler</em> de tratamiento de la obtención
de una dirección IP sea independiente del tratamiento del resto de eventos
del sistema WiFi que ya se están considerando. Comprueba que, efectivamente
sigue observándose la salida asociada a dicho evento, aun cuando ambas
funciones sean independientes. Entrega o añade al informe  el código
modificado.</p>
</div></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
